<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Assistant - Strategy Lab</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <link rel="stylesheet" href="style.css"> <!-- Import global styles including .custom-scroll -->

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#151F32', 900: '#0F172A', 950: '#020617' },
                        blue: { 450: '#60A5FA', 550: '#3B82F6' },
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { opacity: 0.6, boxShadow: '0 0 0 0 rgba(59, 130, 246, 0.4)' },
                            '50%': { opacity: 1, boxShadow: '0 0 15px 0 rgba(59, 130, 246, 0.6)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Logic for custom styles not covered by Tailwind or global CSS */

        /* Typing Dots Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Message Fade In */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-anim {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Hide Scrollbar for Quick Chips */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>

<!-- New Layout Structure -->

<body
    class="flex flex-col h-[100dvh] bg-slate-950 text-slate-300 relative overflow-hidden font-sans selection:bg-blue-500/30">

    <!-- 1. BACKGROUND GRID (Decorative) -->
    <div class="absolute inset-0 z-0 pointer-events-none opacity-20"
        style="background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px); background-size: 40px 40px;">
    </div>

    <!-- 2. HEADER (Fixed Top) -->
    <header
        class="flex justify-between items-center p-6 border-b border-slate-800/60 bg-slate-900/80 backdrop-blur-md z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]"></div>
            <h1 class="text-xs font-bold tracking-[0.2em] text-slate-100 uppercase drop-shadow-md">
                LAB <span class="text-blue-500">ASSISTANT_V1</span>
            </h1>
        </div>
        <button onclick="window.location.href='/dashboard.html'"
            class="text-[10px] font-mono text-slate-500 hover:text-red-400 transition-colors tracking-widest uppercase cursor-pointer">
            [ EXIT TERMINAL ]
        </button>
    </header>

    <!-- 3. CHAT AREA (Flexible Middle) -->
    <main class="flex-1 min-h-0 overflow-y-auto custom-scroll p-4 md:p-8 space-y-6 z-10 w-full max-w-5xl mx-auto"
        id="chat-container">
        <!-- NOTE: Removed pb-96. Layout is now docked flexbox. -->

        <!-- Welcome Message -->
        <div class="flex gap-4 message-anim opacity-0">
            <div
                class="w-8 h-8 rounded bg-blue-600/20 border border-blue-500/50 flex items-center justify-center shrink-0 mt-1">
                <svg class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z" />
                    <path d="M12 8v4l3 3" />
                </svg>
            </div>
            <div class="max-w-[85%] bg-slate-900 border border-slate-800 rounded-2xl rounded-tl-none p-5 shadow-lg">
                <p id="ai-welcome-text" class="text-sm leading-relaxed text-slate-300">
                    <span class="text-blue-400 font-mono text-xs font-bold block mb-2">Initialize Sequence...</span>
                    Hello. I am your Strategy Lab Assistant. I am calibrated to analyze career trajectories, optimize
                    negotiation leverage, and critique professional assets. <br><br>
                    How can I advance your position today?
                </p>
            </div>
        </div>
    </main>

    <!-- 4. INPUT AREA (Docked Bottom) -->
    <div class="shrink-0 w-full p-6 z-30 bg-slate-950 border-t border-slate-800/50">
        <div class="max-w-3xl mx-auto pointer-events-auto">

            <!-- Quick Chips Row -->
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide" id="quick-chips">
                <button onclick="sendQuickPrompt('Critique my elevator pitch')"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full border border-slate-700/50 bg-slate-900/80 backdrop-blur-sm text-[10px] font-mono text-slate-400 hover:border-blue-500 hover:text-blue-400 transition-all hover:shadow-[0_0_10px_rgba(59,130,246,0.2)]">
                    Critique my elevator pitch
                </button>
                <button onclick="sendQuickPrompt('Explain STAR Method')"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full border border-slate-700/50 bg-slate-900/80 backdrop-blur-sm text-[10px] font-mono text-slate-400 hover:border-blue-500 hover:text-blue-400 transition-all hover:shadow-[0_0_10px_rgba(59,130,246,0.2)]">
                    Explain 'STAR Method'
                </button>
                <button onclick="sendQuickPrompt('Salary negotiation tactics')"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full border border-slate-700/50 bg-slate-900/80 backdrop-blur-sm text-[10px] font-mono text-slate-400 hover:border-blue-500 hover:text-blue-400 transition-all hover:shadow-[0_0_10px_rgba(59,130,246,0.2)]">
                    Salary negotiation tactics
                </button>
                <button onclick="sendQuickPrompt('Review my resume summary')"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full border border-slate-700/50 bg-slate-900/80 backdrop-blur-sm text-[10px] font-mono text-slate-400 hover:border-blue-500 hover:text-blue-400 transition-all hover:shadow-[0_0_10px_rgba(59,130,246,0.2)]">
                    Review my resume summary
                </button>
            </div>

            <!-- The Input Island -->
            <div class="relative group">
                <textarea id="user-input" placeholder="Ask about strategy, negotiation, or etiquette..." rows="3"
                    class="w-full bg-slate-900/80 backdrop-blur-xl border border-slate-700/50 rounded-2xl py-3 pl-6 pr-14 text-sm text-white placeholder-slate-500 shadow-2xl focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/20 transition-all resize-none custom-scroll"></textarea>
                <button onclick="sendMessage()" id="send-btn"
                    class="absolute right-2 bottom-3 p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-xl disabled:opacity-0 disabled:scale-90 transition-all shadow-lg flex items-center justify-center">
                    <!-- ArrowRight Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                </button>
            </div>

            <div class="text-center mt-3">
                <p class="text-[10px] text-slate-600 font-mono">
                    AI-Generated advice. Verify critical data.
                </p>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        let isProcessing = false;
        let system_prompt_context = '';

        document.addEventListener('DOMContentLoaded', () => {
            // ... existing initialization ... 
            const missionContext = localStorage.getItem('mission_context');
            if (missionContext) {
                try {
                    const ctx = JSON.parse(missionContext);
                    const headerTitle = document.querySelector('h1');
                    if (headerTitle) {
                        headerTitle.innerHTML = `MISSION: <span class="text-blue-500">${ctx.role} @ ${ctx.company}</span>`;
                    }
                    system_prompt_context = `CONTEXT:\nRole: ${ctx.role}\nCompany: ${ctx.company}\nStatus: ${ctx.status || 'Active'}\nJD: ${ctx.jd}\nNotes: ${ctx.notes}`;
                } catch (e) { console.error("Context Error", e); }
            }
        });

        // ... mockResponses ...

        // EVENT LISTENERS
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !isProcessing) {
                e.preventDefault(); // Prevent newline
                sendMessage();
            }
        });

        function sendQuickPrompt(text) {
            if (isProcessing) return;
            userInput.value = text;
            sendMessage();
        }

        // --- CORE LOGIC ---
        // ... sendMessage ... 

        // ... appendMessage ... (Replacing with specific line targeting below to apply text-left)

                        ${ role === 'user' ? text : '' } <!-- AI Text filled later if streaming -->
                    </div >
                </div >
            `;

            chatContainer.appendChild(div);
            return div.querySelector('.prose'); // Return content container for streaming
        }

        function showThinking() {
            const id = 'thinking-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-center gap-1 ml-14 text-blue-500 animate-pulse mt-2";
            // Updated Thinking Indicator per specific request: 3 dots
            div.innerHTML = `
            < div class="w-1.5 h-1.5 bg-blue-500 rounded-full" ></div >
                 <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animation-delay-150" style="animation-delay: 150ms"></div>
                 <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animation-delay-300" style="animation-delay: 300ms"></div>
        `;
            chatContainer.appendChild(div);
            return id;
        }

        function removeThinking(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // -- UPSELL CONFIGURATION --
        const UPSELL_TRIGGERS = [
            {
                keyword: "Executive Rewrite",
                toolName: "EXECUTIVE REWRITE",
                price: "$9.99",
                color: "blue", // Tailwind color name
                icon: `< svg class="w-3.5 h-3.5" viewBox = "0 0 24 24" fill = "none" stroke = "currentColor" stroke - width="2" stroke - linecap="round" stroke - linejoin="round" ><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg > `,
                action: "/resume-rewriter.html"
            },
            {
                keyword: "Interview Simulator",
                toolName: "THE SIMULATOR",
                price: "$14.99",
                color: "green",
                icon: `< svg class="w-3.5 h-3.5" viewBox = "0 0 24 24" fill = "none" stroke = "currentColor" stroke - width="2" stroke - linecap="round" stroke - linejoin="round" > <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg > `,
                action: "/app.html#interview"
            },
            {
                keyword: "The Closer",
                toolName: "NEGOTIATION ENGINE",
                price: "$4.99",
                color: "purple", // We need to ensure purple is in tailwind config or use hex
                icon: `< svg class="w-3.5 h-3.5" viewBox = "0 0 24 24" fill = "none" stroke = "currentColor" stroke - width="2" stroke - linecap="round" stroke - linejoin="round" ><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg > `,
                action: "/strategy/closer.html"
            }
        ];

        // Helper to get color classes
        function getChipColors(color) {
            const map = {
                blue: "border-blue-500/30 bg-blue-500/10 text-blue-400 hover:border-blue-400",
                green: "border-green-500/30 bg-green-500/10 text-green-400 hover:border-green-400",
                purple: "border-purple-500/30 bg-purple-500/10 text-purple-400 hover:border-purple-400"
            };
            return map[color] || map.blue;
        }

        function streamResponse(fullText) {
            const contentDiv = appendMessage('ai', ''); // Create empty bubble
            // Logic to find trigger
            const matchedTrigger = UPSELL_TRIGGERS.find(t => fullText.includes(t.keyword));

            // Hybrid Streaming
            const words = fullText.split(' ');
            let i = 0;

            const interval = setInterval(() => {
                if (i >= words.length) {
                    clearInterval(interval);
                    isProcessing = false;
                    sendBtn.disabled = false;

                    // Final Render: Markdown
                    let finalHtml = marked.parse(fullText);

                    // Append Chip if matched
                    if (matchedTrigger) {
                        const colors = getChipColors(matchedTrigger.color);
                        const chipHtml = `
            < button onclick = "window.location.href='${matchedTrigger.action}'"
        class="mt-6 group flex items-center justify-between w-full max-w-xs backdrop-blur-md border rounded-lg p-3 transition-all duration-300 text-left ${colors} hover:shadow-[0_0_15px_rgba(255,255,255,0.05)] cursor-pointer" >
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-md bg-slate-950/50 flex items-center justify-center border border-white/10 shrink-0">
                                    ${matchedTrigger.icon}
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold opacity-70 tracking-widest uppercase mb-0.5">Recommended Tool</div>
                                    <div class="text-xs font-bold text-white flex items-center gap-2">
                                        ${matchedTrigger.toolName}
                                        <span class="bg-slate-900 text-slate-400 text-[10px] px-1.5 py-0.5 rounded border border-slate-700">${matchedTrigger.price}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-transform">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </div>
                        </button >
                        `;
                        finalHtml += chipHtml;
                    }

                    contentDiv.innerHTML = finalHtml;
                    scrollToBottom();
                    return;
                }

                contentDiv.textContent += (i === 0 ? '' : ' ') + words[i];
                scrollToBottom();
                i++;
            }, 30); // Speed up typing slightly
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

    </script>
</body>

</html>