<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - AceInterview Admin</title>
    <!-- GATEKEEPER SCRIPT -->
    <script>
        (function () {
            try {
                // 1. Check Token
                const token = localStorage.getItem('supabase.auth.token');
                if (!token) throw new Error("No Token");

                // 2. Check Role in Session
                const sessionStr = localStorage.getItem('aceinterview_session');
                const session = sessionStr ? JSON.parse(sessionStr) : null;

                // Allow if role is explicitly admin
                // Note: Real security happens on backend. This is just UI redirection.
                if (!session || session.role !== 'admin') {
                    // Fallback: Check if email is explicitly an admin email (hardcoded for safety during dev)
                    if (session && (session.email === 'admin@aceinterview.ai' || session.email === 'david@aceinterview.ai')) {
                        // Allowed
                    } else {
                        throw new Error("Not Admin");
                    }
                }
            } catch (e) {
                console.warn("Access Denied:", e.message);
                // Redirect to dashboard (uncomment for prod, kept loose for dev testing if needed)
                window.location.href = '/dashboard.html';
            }
        })();
    </script>

    <!-- Tailwind & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: '#0A2540',
                        teal: '#20C997',
                        slate: { 950: '#020617' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #020617;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #20C997;
            box-shadow: 0 0 10px #20C997;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.7;
            }
        }

        .console-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #10B981;
        }

        /* Iframe Resizers */
        .device-frame {
            transition: width 0.3s ease, height 0.3s ease;
            border: 1px solid #334155;
            border-radius: 8px;
            background: white;
        }

        .w-mobile {
            width: 375px;
            height: 667px;
        }

        .w-tablet {
            width: 768px;
            height: 1024px;
        }

        .w-desktop {
            width: 100%;
            height: 800px;
        }

        /* CHAT STYLES */
        .chat-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #10B981;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #10B981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }

        .msg-system {
            color: #94A3B8;
            border-left: 2px solid #334155;
            padding-left: 8px;
            margin-bottom: 8px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        .msg-admin {
            color: #20C997;
            text-align: right;
            margin-bottom: 8px;
            font-size: 11px;
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
        }

        /* INTEL DRAWER STYLES */
        .intel-drawer {
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .intel-drawer.open {
            transform: translateX(0);
        }

        .tier-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .tier-Executive {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
            border: 1px solid rgba(168, 85, 247, 0.4);
        }

        .tier-Management {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .tier-Service {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .tier-Professional {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }
    </style>
</head>

<!-- MOBILE HEADER (Visible < lg) -->
<div
    class="lg:hidden flex items-center justify-between mb-6 bg-slate-950/50 p-4 rounded-xl border border-slate-800 backdrop-blur-md sticky top-0 z-30">
    <div class="flex items-center gap-3">
        <i class="fas fa-shield-cat text-teal text-xl"></i>
        <span class="font-black text-lg tracking-tighter text-white">MISSION_CONTROL</span>
    </div>
    <button onclick="toggleSidebar()" class="p-2 text-slate-400 hover:text-white transition-colors">
        <i class="fas fa-bars text-xl"></i>
    </button>
</div>

<!-- Mobile Overlay -->
<div id="mobile-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden" onclick="toggleSidebar()"></div>

<!-- HEADER (Desktop) -->
<header class="hidden lg:flex justify-between items-center mb-8">
    <div class="flex items-center gap-4">
        <div class="w-10 h-10 rounded-lg bg-teal/20 flex items-center justify-center border border-teal/50">
            <i class="fas fa-shield-cat text-teal text-xl"></i>
        </div>
        <div>
            <h1 class="text-2xl font-bold tracking-tight text-white">MISSION CONTROL</h1>
            <div class="flex items-center gap-2 text-xs text-slate-400">
                <div class="pulse-dot"></div>
                <span>SYSTEM ONLINE</span>
            </div>
        </div>
    </div>
    <div class="flex items-center gap-3">
        <a href="/dashboard.html"
            class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-teal-400 rounded-lg text-sm font-bold transition-all border border-slate-700 flex items-center gap-2">
            <i class="fas fa-user"></i> USER VIEW
        </a>
        <button onclick="toggleIntelDrawer(true)"
            class="px-4 py-2 bg-teal/10 hover:bg-teal/20 text-teal rounded-lg text-sm font-bold transition-all border border-teal/30 flex items-center gap-2 group">
            <i class="fas fa-chart-line group-hover:scale-110 transition-transform"></i> MISSION INTEL
        </button>
        <button onclick="refreshAll()"
            class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm font-medium transition-colors border border-slate-700 flex items-center gap-2">
            <i class="fas fa-sync-alt"></i> REFRESH DATA
        </button>
    </div>
</header>

<!-- GRID LAYOUT -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- COL 1: HEALTH PULSE (Left Sidebar) -->
    <div id="admin-sidebar" class="hidden lg:block lg:col-span-1 space-y-6 order-2 lg:order-1">

        <!-- WIDGET A: SCORING TRENDS -->
        <div id="health-widget" class="glass-panel p-5 rounded-xl">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">
                <i class="fas fa-heartbeat mr-2"></i> Health Pulse
            </h3>

            <!-- MISSION SELECTOR (Standardized Across Tools) -->
            <div class="mb-6 p-3 bg-slate-900/50 rounded-lg border border-slate-700/50">
                <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Active
                    Mission Context</label>
                <div class="relative group">
                    <select id="mission-selector" onchange="selectMission(this.value)"
                        class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-xs text-teal-400 font-mono focus:outline-none focus:border-teal-500 transition-all cursor-pointer">
                        <option value="">Loading Missions...</option>
                    </select>
                    <div class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-slate-600">
                        <i class="fas fa-caret-down"></i>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="p-4 bg-slate-900/50 rounded-lg border border-slate-700/50">
                    <p class="text-xs text-slate-500 mb-1">24H Scoring Avg</p>
                    <div class="flex items-end gap-2">
                        <span id="score-24h" class="text-3xl font-bold text-white">--</span>
                        <span class="text-xs text-slate-400 mb-1">/ 5.0</span>
                    </div>
                </div>

                <div class="p-4 bg-slate-900/50 rounded-lg border border-slate-700/50">
                    <p class="text-xs text-slate-500 mb-1">7-Day Avg (Baseline)</p>
                    <span id="score-7d" class="text-xl font-bold text-slate-300">--</span>
                </div>

                <div id="anomaly-badge"
                    class="hidden px-3 py-2 bg-red-500/10 border border-red-500/50 rounded text-red-400 text-xs font-bold text-center">
                    <i class="fas fa-exclamation-triangle mr-1"></i> ANOMALY DETECTED
                </div>
            </div>
        </div>

        <!-- WIDGET B: AI COMMAND CENTER (CHAT) -->
        <div class="glass-panel p-4 rounded-xl h-[400px] flex flex-col">
            <h3
                class="text-xs font-bold text-teal-400 uppercase tracking-widest mb-2 flex justify-between items-center">
                <span><i class="fas fa-terminal mr-2"></i> COMMAND CENTER</span>
                <span class="text-[10px] text-slate-500">v1.0</span>
            </h3>

            <!-- Chat Output -->
            <div id="admin-chat-output"
                class="flex-1 overflow-y-auto space-y-2 p-2 mb-2 bg-slate-900/50 rounded border border-slate-700/50 custom-scroll">
                <div class="msg-system">
                    > System Online.<br>
                    > Welcome, Admin. How can I assist you?
                </div>
            </div>

            <!-- Chat Input -->
            <div class="relative">
                <input type="text" id="admin-chat-input"
                    class="w-full bg-slate-950 border border-slate-700 rounded p-2 pl-3 text-xs text-teal-400 font-mono focus:outline-none focus:border-teal-500 transition-colors"
                    placeholder="Type a command (e.g. 'Check health', 'Find user')..." autocomplete="off">
                <div class="absolute right-2 top-2 text-[10px] text-slate-600">‚èé</div>
            </div>
        </div>

        <!-- WIDGET C: SUPPORT BOT TUNING -->
        <div class="glass-panel p-5 rounded-xl border border-teal-500/20 shadow-lg shadow-teal-500/5">
            <h3
                class="text-xs font-bold text-teal-400 uppercase tracking-widest mb-4 flex justify-between items-center">
                <span><i class="fas fa-brain mr-2"></i> Support Bot Tuning</span>
                <span id="config-status" class="text-[10px] text-slate-500 italic">ready</span>
            </h3>
            <div class="space-y-4">
                <p class="text-[10px] text-slate-400 leading-relaxed">Customize the bot's core logic and guardrails
                    here. Updates are live instantly.</p>

                <div class="space-y-1">
                    <label class="text-[9px] text-slate-500 uppercase font-bold pl-1">Knowledge & Guardrails</label>
                    <textarea id="support-bot-prompt-input" rows="6"
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-[11px] text-slate-300 font-mono focus:outline-none focus:border-teal-500 custom-scroll"
                        placeholder="Loading system prompt..."></textarea>
                </div>

                <div class="space-y-1">
                    <label class="text-[9px] text-slate-500 uppercase font-bold pl-1">Opening Greeting</label>
                    <textarea id="support-bot-welcome-input" rows="3"
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-[11px] text-slate-300 font-mono focus:outline-none focus:border-teal-500 custom-scroll"
                        placeholder="Loading welcome message..."></textarea>
                </div>

                <button onclick="saveBotConfig()"
                    class="w-full py-2 bg-teal hover:bg-teal-400 text-black text-xs font-bold rounded-lg transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-save"></i> UPDATE BOT BRAIN
                </button>
            </div>
        </div>
    </div> <!-- End Col 1 (Sidebar) -->

    <!-- COL 2 & 3 & 4: MAIN CONTENT -->
    <div class="lg:col-span-3 space-y-6 order-1 lg:order-2">

        <!-- ROW 2: USER MANAGER -->
        <div class="glass-panel p-6 rounded-xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <h3 class="text-sm font-bold text-white flex items-center gap-2">
                    <i class="fas fa-users-cog text-blue-400"></i> USER MANAGEMENT (GOD MODE)
                </h3>
                <input type="text" placeholder="Search Users..."
                    class="bg-slate-900 border border-slate-700 rounded px-3 py-1 text-xs text-slate-300 w-full md:w-48 focus:outline-none focus:border-blue-500">
            </div>

            <div id="user-cards-mobile" class="md:hidden space-y-4 mb-4">
                <!-- Mobile User Cards -->
                <div class="text-center text-slate-600 py-8 italic text-sm">Loading Users...</div>
            </div>

            <div class="hidden md:block overflow-x-auto rounded-lg border border-slate-700">
                <table class="w-full text-left text-sm text-slate-400">
                    <thead class="bg-slate-900/80 text-xs uppercase font-medium text-slate-300">
                        <tr>
                            <th class="px-4 py-3">User Email</th>
                            <th class="px-4 py-3">Role</th>
                            <th class="px-4 py-3">Plan</th>
                            <th class="px-4 py-3 text-center">Univ. Credits</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body" class="divide-y divide-slate-800 bg-slate-900/30">
                        <!-- Dynamic User Rows -->
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-slate-600">Loading Users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ROW 3 & 4: GRID SUB-LAYOUT -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <!-- UAT LAB -->
            <div class="glass-panel p-6 rounded-xl">
                <h3 class="text-sm font-bold text-white flex items-center gap-2 mb-4">
                    <i class="fas fa-vial text-purple-400"></i> UAT LAB
                </h3>

                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button onclick="runTest('executive')"
                            class="px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-teal-500/50 rounded-lg text-left transition-all group">
                            <span
                                class="block text-xs font-bold text-white group-hover:text-teal-400 mb-1">Executive</span>
                            <span class="block text-[9px] text-slate-500">Scoring check.</span>
                        </button>
                        <button onclick="runTest('quitter')"
                            class="px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-red-500/50 rounded-lg text-left transition-all group">
                            <span
                                class="block text-xs font-bold text-white group-hover:text-red-400 mb-1">Quitter</span>
                            <span class="block text-[9px] text-slate-500">Short rejection.</span>
                        </button>
                        <button onclick="runTest('cliffhanger')"
                            class="px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-yellow-500/50 rounded-lg text-left transition-all group">
                            <span
                                class="block text-xs font-bold text-white group-hover:text-yellow-400 mb-1">Cliffhanger</span>
                            <span class="block text-[9px] text-slate-500">Missing result.</span>
                        </button>
                    </div>
                    <div
                        class="bg-black rounded-lg border border-slate-800 p-4 h-32 overflow-y-auto custom-scroll shadow-inner">
                        <pre id="test-console"
                            class="console-text whitespace-pre-wrap">Waiting to initialize test sequence...</pre>
                    </div>
                </div>
            </div>

            <!-- MISSION FEEDBACK -->
            <div
                class="glass-panel p-6 rounded-xl border border-blue-500/20 shadow-lg shadow-blue-500/5 flex flex-col h-[300px]">
                <h3
                    class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-4 flex justify-between items-center">
                    <span><i class="fas fa-inbox mr-2"></i> Mission Feedback</span>
                    <span onclick="fetchFeedback()"
                        class="cursor-pointer text-slate-500 hover:text-white transition-colors"><i
                            class="fas fa-sync-alt"></i></span>
                </h3>

                <div id="feedback-container" class="flex-1 overflow-y-auto space-y-3 custom-scroll pr-1">
                    <!-- Dynamic Feedback Feed -->
                    <div class="text-xs text-slate-500 italic text-center py-10">Initializing feedback stream...</div>
                </div>
            </div>
        </div>
    </div> <!-- End Col 2&3&4 -->
</div> <!-- End Grid -->



<!-- EDIT CREDITS MODAL -->
<div id="edit-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 w-[400px] shadow-2xl">
        <h3 class="text-lg font-bold text-white mb-4">Edit User Credits</h3>
        <p id="modal-user-email" class="text-xs text-slate-400 mb-6 font-mono"></p>

        <input type="hidden" id="modal-user-id">

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Universal</label>
                <input type="number" id="edit-credits"
                    class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-xs">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Resume</label>
                <input type="number" id="edit-resume"
                    class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-xs">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Mock Int.</label>
                <input type="number" id="edit-interview"
                    class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-xs">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Negotiation</label>
                <input type="number" id="edit-negotiation"
                    class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-xs">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">LinkedIn</label>
                <input type="number" id="edit-linkedin"
                    class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-xs">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Follow Up</label>
                <input type="number" id="edit-followup"
                    class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-xs">
            </div>
        </div>

        <div class="flex justify-end gap-3 mt-8">
            <button onclick="closeModal()" class="px-4 py-2 text-slate-400 hover:text-white text-sm">Cancel</button>
            <button onclick="saveUserChanges()"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold">Save
                Changes</button>
        </div>
    </div>
</div>


<script>
    // --- LOGIC ---

    async function refreshAll() {
        await Promise.all([fetchHealth(), fetchUsers()]);
    }

    // 1. FETCH HEALTH
    async function fetchHealth() {
        try {
            const res = await fetch('/api/admin/health', {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token') }
            });
            const data = await res.json();

            if (!res.ok) throw new Error(data.error || 'Auth Failed');

            // Update Widgets
            document.getElementById('score-24h').textContent = (data.avg_24h || 0).toFixed(1);
            document.getElementById('score-7d').textContent = (data.avg_7d || 0).toFixed(1);

            const widget = document.getElementById('health-widget');
            const badge = document.getElementById('anomaly-badge');

            if (data.anomaly) {
                widget.classList.add('bg-red-900/20', 'border-red-900/50');
                badge.classList.remove('hidden');
            } else {
                widget.classList.remove('bg-red-900/20', 'border-red-900/50');
                badge.classList.add('hidden');
            }
        } catch (e) {
            console.error("Health Fetch Failed", e);
        }
    }

    // --- MISSION SELECTOR LOGIC ---
    let allJobs = [];
    window.loadMissions = async () => {
        try {
            const token = localStorage.getItem('supabase.auth.token');
            if (!token) return;

            const res = await fetch('/api/jobs', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) return;
            allJobs = await res.json();

            const selector = document.getElementById('mission-selector');
            if (!selector) return;

            const activeJobs = allJobs.filter(j => j.status !== 'closed');
            selector.innerHTML = '<option value="">Choose a Mission...</option>';

            activeJobs.forEach(job => {
                const opt = document.createElement('option');
                opt.value = job.id;
                opt.textContent = `${job.job_title} @ ${job.company_name}`;
                selector.appendChild(opt);
            });

            // Pre-select if current exists
            const currentCtx = JSON.parse(localStorage.getItem('mission_context') || '{}');
            if (currentCtx.job_id) {
                selector.value = currentCtx.job_id;
            }
        } catch (e) {
            console.error("Failed to load missions", e);
        }
    };

    window.selectMission = (id) => {
        if (!id) return;
        const job = allJobs.find(j => j.id == id);
        if (!job) return;

        const context = {
            job_id: job.id,
            role: job.job_title,
            company: job.company_name,
            jd: job.job_description,
            description: job.job_description
        };
        localStorage.setItem('mission_context', JSON.stringify(context));
    };

    function toggleSidebar() {
        const sidebar = document.getElementById('admin-sidebar');
        const overlay = document.getElementById('mobile-overlay');
        if (!sidebar || !overlay) return;

        const isOpen = !sidebar.classList.contains('hidden');

        if (isOpen) {
            sidebar.classList.add('hidden');
            sidebar.classList.remove('fixed', 'inset-y-0', 'left-0', 'w-[280px]', 'z-50', 'bg-slate-950', 'border-r', 'border-slate-800', 'p-6', 'overflow-y-auto');
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
        } else {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('fixed', 'inset-y-0', 'left-0', 'w-[280px]', 'z-50', 'bg-slate-950', 'border-r', 'border-slate-800', 'p-6', 'overflow-y-auto');
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    // 2. FETCH USERS
    async function fetchUsers() {
        try {
            const res = await fetch('/api/admin/users', {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token') }
            });
            const users = await res.json();

            if (!res.ok) throw new Error(users.error || 'Auth Failed');

            const tbody = document.getElementById('user-table-body');
            const cardContainer = document.getElementById('user-cards-mobile');

            if (Array.isArray(users)) {
                // Update Table
                tbody.innerHTML = users.map(u => `
                        <tr class="hover:bg-slate-800/50 transition-colors">
                            <td class="px-4 py-3 text-white font-medium">${u.email}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${u.role === 'admin' ? 'bg-purple-900/50 text-purple-400' : 'bg-slate-800 text-slate-400'}">${u.role || 'user'}</span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="text-xs text-slate-400">${u.plan || 'Free'}</span>
                            </td>
                            <td class="px-4 py-3 text-center text-teal-400 font-mono font-bold">${u.credits || 0}</td>
                            <td class="px-4 py-3 text-right">
                                <button onclick='openEditModal(${JSON.stringify(u).replace(/'/g, "&apos;")})' class="text-xs text-blue-400 hover:text-blue-300 hover:underline">Edit</button>
                            </td>
                        </tr>
                    `).join('');

                // Update Cards
                cardContainer.innerHTML = users.map(u => `
                        <div class="glass-panel p-4 rounded-xl border border-white/5">
                            <div class="flex justify-between items-start mb-3">
                                <div class="truncate pr-4">
                                    <div class="text-sm font-bold text-white truncate">${u.email}</div>
                                    <div class="flex gap-2 mt-1">
                                        <span class="px-1.5 py-0.5 rounded text-[8px] font-bold uppercase ${u.role === 'admin' ? 'bg-purple-900/50 text-purple-400' : 'bg-slate-800 text-slate-400'}">${u.role || 'user'}</span>
                                        <span class="text-[10px] text-slate-500">${u.plan || 'Free'}</span>
                                    </div>
                                </div>
                                <div class="text-teal-400 font-bold font-mono">${u.credits || 0} cr</div>
                            </div>
                            <div class="flex justify-end pt-2 border-t border-white/5">
                                <button onclick='openEditModal(${JSON.stringify(u).replace(/'/g, "&apos;")})' class="text-xs text-blue-400 font-bold uppercase tracking-wider">Manage User</button>
                            </div>
                        </div>
                    `).join('');

            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">Failed to load users.</td></tr>';
                cardContainer.innerHTML = '<div class="text-center text-red-500 py-8 italic text-sm">Failed to load users.</div>';
            }
        } catch (e) {
            console.error("User Fetch Failed", e);
        }
    }

    // 3. EDIT MODAL
    function openEditModal(user) {
        document.getElementById('modal-user-id').value = user.id;
        document.getElementById('modal-user-email').textContent = user.email;

        document.getElementById('edit-credits').value = user.credits || 0;
        document.getElementById('edit-resume').value = user.resume_credits || 0;
        document.getElementById('edit-interview').value = user.credits_interview_sim || 0;
        document.getElementById('edit-negotiation').value = user.credits_negotiation || 0;
        document.getElementById('edit-linkedin').value = user.credits_linkedin || 0;
        document.getElementById('edit-followup').value = user.credits_followup || 0;

        document.getElementById('edit-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('edit-modal').classList.add('hidden');
    }

    async function saveUserChanges() {
        const id = document.getElementById('modal-user-id').value;
        const updates = {
            credits: parseInt(document.getElementById('edit-credits').value) || 0,
            resume_credits: parseInt(document.getElementById('edit-resume').value) || 0,
            credits_interview_sim: parseInt(document.getElementById('edit-interview').value) || 0,
            credits_negotiation: parseInt(document.getElementById('edit-negotiation').value) || 0,
            credits_linkedin: parseInt(document.getElementById('edit-linkedin').value) || 0,
            credits_followup: parseInt(document.getElementById('edit-followup').value) || 0
        };

        try {
            const res = await fetch('/api/admin/credits', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token')
                },
                body: JSON.stringify({ user_id: id, updates: updates })
            });

            if (res.ok) {
                closeModal();
                fetchUsers();
            } else {
                alert('Update failed');
            }
        } catch (e) {
            console.error(e);
            alert('Error saving changes');
        }
    }

    // 4. RUN TESTS (UAT LAB)
    async function runTest(persona) {
        const consoleEl = document.getElementById('test-console');
        consoleEl.textContent = `> Initializing ${persona.toUpperCase()} test sequence...\n`;
        try {
            const res = await fetch('/api/admin/run-test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ persona: persona })
            });
            const data = await res.json();
            consoleEl.textContent += `> Test Runner Connected.\n> Executing Simulation...\n\n`;
            setTimeout(() => {
                consoleEl.textContent += data.logs || "No logs returned.";
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }, 500);
        } catch (e) {
            consoleEl.textContent += `\n[FATAL ERROR]: Connection to Test Runner failed.`;
        }
    }

    // 5. DEVICE SIMULATOR
    function resizeFrame(sizeClass) {
        const frame = document.getElementById('sim-frame');
        frame.className = `device-frame shadow-2xl ${sizeClass}`;
    }

    // 6. SUPPORT BOT CONFIG (TUNING)
    async function fetchBotConfig() {
        try {
            const resP = await fetch('/api/admin/config?key=support_bot_prompt', {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token') }
            });
            const dataP = await resP.json();
            document.getElementById('support-bot-prompt-input').value = dataP.value || "";

            const resW = await fetch('/api/admin/config?key=support_bot_welcome', {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token') }
            });
            const dataW = await resW.json();
            document.getElementById('support-bot-welcome-input').value = dataW.value || "";
        } catch (err) {
            console.error("Failed to fetch bot config", err);
        }
    }

    async function saveBotConfig() {
        const promptVal = document.getElementById('support-bot-prompt-input').value;
        const welcomeVal = document.getElementById('support-bot-welcome-input').value;
        const status = document.getElementById('config-status');
        status.textContent = "saving...";

        try {
            await Promise.all([
                fetch('/api/admin/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token') },
                    body: JSON.stringify({ key: 'support_bot_prompt', value: promptVal })
                }),
                fetch('/api/admin/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token') },
                    body: JSON.stringify({ key: 'support_bot_welcome', value: welcomeVal })
                })
            ]);
            status.textContent = "saved!";
            setTimeout(() => status.textContent = "ready", 2000);
        } catch (err) {
            status.textContent = "error";
            alert("Failed to save bot configuration.");
        }
    }

    // 7. ADMIN CHAT LOGIC (COMMAND CENTER)
    const chatInput = document.getElementById('admin-chat-input');
    const chatOutput = document.getElementById('admin-chat-output');

    if (chatInput) {
        chatInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const msg = chatInput.value.trim();
                if (!msg) return;
                appendAdminMessage(msg);
                chatInput.value = '';
                try {
                    const loadingId = appendSystemMessage("Processing...", true);
                    const res = await fetch('/api/admin/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token')
                        },
                        body: JSON.stringify({ message: msg })
                    });
                    const data = await res.json();
                    document.getElementById(loadingId)?.remove();
                    if (data.error) appendSystemMessage("Error: " + data.error);
                    else appendSystemMessage(data.response);
                } catch (err) {
                    appendSystemMessage("Critical Error: Connection Failed");
                }
            }
        });
    }

    function appendAdminMessage(text) {
        const div = document.createElement('div');
        div.className = 'msg-admin';
        div.textContent = '> ' + text;
        chatOutput.appendChild(div);
        chatOutput.scrollTop = chatOutput.scrollHeight;
    }

    function appendSystemMessage(text, isLoading = false) {
        const div = document.createElement('div');
        div.className = 'msg-system';
        div.id = 'msg-' + Date.now();
        if (isLoading) div.className += ' italic opacity-70';
        div.innerHTML = '> ' + text.replace(/\n/g, '<br>');
        chatOutput.appendChild(div);
        chatOutput.scrollTop = chatOutput.scrollHeight;
        return div.id;
    }

    // 8. INTEL HUB LOGIC
    let currentIntelData = null;

    function toggleIntelDrawer(open) {
        const drawer = document.getElementById('intel-drawer');
        const overlay = document.getElementById('drawer-overlay');
        if (open) {
            drawer.classList.add('open');
            overlay.classList.remove('hidden');
            fetchIntel();
        } else {
            drawer.classList.remove('open');
            overlay.classList.add('hidden');
        }
    }

    function switchIntelTab(tab) {
        const opsTab = document.getElementById('tab-ops');
        const finTab = document.getElementById('tab-fin');
        const comTab = document.getElementById('tab-com');
        const activeClass = 'bg-teal text-black shadow-lg shadow-teal/20';
        const inactiveClass = 'text-slate-400 hover:text-white bg-slate-800';

        opsTab.className = `flex-1 py-2 text-xs font-bold rounded-lg transition-all ${inactiveClass}`;
        finTab.className = `flex-1 py-2 text-xs font-bold rounded-lg transition-all ${inactiveClass}`;
        comTab.className = `flex-1 py-2 text-xs font-bold rounded-lg transition-all ${inactiveClass}`;

        if (tab === 'ops') {
            opsTab.className = `flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeClass}`;
            renderOps();
        } else if (tab === 'fin') {
            finTab.className = `flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeClass}`;
            renderFin();
        } else {
            comTab.className = `flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeClass}`;
            renderCom();
        }
    }

    async function fetchIntel() {
        try {
            const res = await fetch('/api/admin/intel', {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token') }
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            currentIntelData = data;
            renderOps();
        } catch (err) {
            document.getElementById('intel-body').innerHTML = `<div class="text-red-400 text-xs p-4 bg-red-400/10 border border-red-400/20 rounded">Failed to sync intel: ${err.message}</div>`;
        }
    }

    function renderOps() {
        if (!currentIntelData) return;
        const body = document.getElementById('intel-body');
        const tiers = currentIntelData.tiers;
        const avg = currentIntelData.averages;
        body.innerHTML = `
                <div class="space-y-6">
                    <section>
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Live Job Market Concentration</h4>
                        <div class="grid grid-cols-2 gap-3">
                            ${Object.entries(tiers).map(([tier, count]) => `
                                <div class="bg-slate-900/80 p-3 rounded-xl border border-white/5">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[10px] text-slate-400 font-mono">${tier}</span>
                                        <span class="text-xs font-bold text-white">${count}</span>
                                    </div>
                                    <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                                        <div class="h-full bg-teal" style="width: ${Math.min((count / 100) * 100, 100)}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                    <section>
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">System Performance Baseline</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-4 bg-slate-900 border border-white/5 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20"><i class="fas fa-microphone"></i></div>
                                    <div>
                                        <p class="text-xs font-bold text-white">Interview Score Avg</p>
                                        <p class="text-[10px] text-slate-500">Based on recent sessions</p>
                                    </div>
                                </div>
                                <div class="text-right"><span class="text-xl font-bold text-white">${avg.interview}</span><span class="text-[10px] text-slate-500">/5.0</span></div>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-slate-900 border border-white/5 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-orange-500/10 flex items-center justify-center text-orange-400 border border-orange-500/20"><i class="fas fa-file-invoice"></i></div>
                                    <div>
                                        <p class="text-xs font-bold text-white">Resume Health Avg</p>
                                        <p class="text-[10px] text-slate-500">Global scan quality</p>
                                    </div>
                                </div>
                                <div class="text-right"><span class="text-xl font-bold text-white">${avg.resume}</span><span class="text-[10px] text-slate-500">/100</span></div>
                            </div>
                        </div>
                    </section>
                </div>
            `;
    }

    function renderFin() {
        if (!currentIntelData || !currentIntelData.transactions) return;
        const body = document.getElementById('intel-body');
        const trans = currentIntelData.transactions;
        if (trans.length === 0) {
            body.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-500 space-y-4"><i class="fas fa-receipt text-4xl opacity-20"></i><p class="text-sm italic">No recent transactions detected.</p></div>`;
            return;
        }
        body.innerHTML = `
                <div class="space-y-4">
                    <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Transaction History (Last 50)</h4>
                    ${trans.map(t => `<div class="p-4 bg-slate-900 border border-white/5 rounded-xl hover:border-white/10 flex justify-between items-start"><div><p class="text-xs font-bold text-white">${t.email}</p><p class="text-[10px] text-slate-500">${t.plan_type}</p></div><div class="text-right"><p class="text-sm font-bold text-teal">$${parseFloat(t.amount).toFixed(2)}</p><p class="text-[8px] text-slate-600">${new Date(t.created_at).toLocaleDateString()}</p></div></div>`).join('')}
                </div>
            `;
    }

    function renderCom() {
        if (!currentIntelData || !currentIntelData.support_logs) return;
        const body = document.getElementById('intel-body');
        const logs = currentIntelData.support_logs;
        if (logs.length === 0) {
            body.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-500 space-y-4"><i class="fas fa-comments text-4xl opacity-20"></i><p class="text-sm italic">No communications logged yet.</p></div>`;
            return;
        }
        body.innerHTML = `<div class="space-y-4">${logs.map(log => `<div class="p-4 bg-slate-900 border border-white/5 rounded-xl space-y-2"><div class="flex justify-between items-center"><span class="text-[10px] font-bold text-teal flex items-center gap-1"><i class="fas fa-question-circle"></i> USER</span><span class="text-[8px] text-slate-600">${new Date(log.created_at).toLocaleTimeString()}</span></div><p class="text-xs text-white">${log.question}</p><div class="pt-2 border-t border-white/5"><span class="text-[10px] font-bold text-slate-500">BOT</span><p class="text-[11px] text-slate-400 italic mt-1">${log.answer}</p></div></div>`).join('')}</div>`;
    }

    // 9. FEEDBACK SHUTTLE
    async function fetchFeedback() {
        try {
            const res = await fetch('/api/admin/feedback', {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('supabase.auth.token') }
            });
            const data = await res.json();
            const container = document.getElementById('feedback-container');

            if (data.length === 0) {
                container.innerHTML = '<div class="text-[10px] text-slate-600 italic text-center py-10">No feedback entries yet.</div>';
                return;
            }

            container.innerHTML = data.map(f => `
                    <div class="p-3 bg-slate-900 border border-white/5 rounded-lg group hover:border-blue-500/30 transition-all">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[9px] font-mono text-blue-400 truncate max-w-[120px]">${f.user_email}</span>
                            <span class="text-[8px] text-slate-600">${new Date(f.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        <p class="text-[11px] text-slate-300 leading-relaxed">${f.message}</p>
                    </div>
                `).join('');

        } catch (err) {
            console.error("Failed to fetch feedback", err);
        }
    }

    // STARTUP
    refreshAll();
    fetchBotConfig();
    fetchFeedback();
    loadMissions();
    setInterval(fetchFeedback, 30000); // Auto-refresh feedback every 30s
</script>

<!-- INTEL DRAWER -->
<div id="intel-drawer"
    class="intel-drawer fixed inset-y-0 right-0 w-[450px] bg-slate-950/95 backdrop-blur-xl border-l border-slate-800 shadow-2xl z-[60] flex flex-col">
    <div class="p-6 border-b border-white/5 flex justify-between items-center">
        <div>
            <h2 class="text-xl font-bold font-mono text-teal">MISSION_INTEL_HUB</h2>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest">Real-Time Operational Analytics</p>
        </div>
        <button onclick="toggleIntelDrawer(false)" class="text-slate-500 hover:text-white transition-colors"><i
                class="fas fa-times text-xl"></i></button>
    </div>
    <div class="p-4 bg-slate-900/50 border-b border-white/5 flex gap-2">
        <button onclick="switchIntelTab('ops')" id="tab-ops"
            class="flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-teal text-black shadow-lg shadow-teal/20">OPERATIONS</button>
        <button onclick="switchIntelTab('fin')" id="tab-fin"
            class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-400 hover:text-white bg-slate-800">FINANCIALS</button>
        <button onclick="switchIntelTab('com')" id="tab-com"
            class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-400 hover:text-white bg-slate-800">COMMUNICATIONS</button>
    </div>
    <div id="intel-body" class="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll">
        <div class="flex items-center justify-center h-full text-slate-500 italic text-sm">Initializing Intel
            Stream...</div>
    </div>
</div>
<div id="drawer-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[55]"
    onclick="toggleIntelDrawer(false)"></div>
</body>

</html>