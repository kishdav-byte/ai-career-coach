<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Career Coach</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS (Specific Version for Stability) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .ghost-badge {
            animation: pulse-ghost 2s infinite;
        }

        @keyframes pulse-ghost {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900">

    <!-- Mobile Header -->
    <div
        class="md:hidden bg-white border-b border-gray-200 p-4 flex justify-between items-center fixed top-0 w-full z-50">
        <span class="font-bold text-lg text-slate-800">üöÄ Ops Lab</span>
        <button id="mobile-menu-btn" class="text-gray-600 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>
    </div>

    <div class="flex min-h-screen pt-16 md:pt-0">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="bg-white border-r border-gray-200 w-64 fixed h-full z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out">
            <div class="h-full flex flex-col p-6">
                <div class="brand text-xl font-extrabold text-slate-900 mb-8 hidden md:block">üöÄ Operations Lab</div>
                <nav class="space-y-1 flex-1">
                    <a href="#"
                        class="flex items-center px-4 py-3 bg-blue-50 text-blue-700 rounded-lg font-medium"><span
                            class="mr-3">üìä</span> Overview</a>
                    <div class="mt-8 mb-2 px-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Active Tools
                    </div>
                    <a href="/dashboard.html" target="_blank"
                        class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors"><span
                            class="mr-3">‚ÜóÔ∏è</span> Open App</a>
                    <a href="/app.html#interview" target="_blank"
                        class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors"><span
                            class="mr-3">üé§</span> Interview Sim</a>
                    <a href="/strategy-lab.html" target="_blank"
                        class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors"><span
                            class="mr-3">üß™</span> Strategy Lab</a>
                    <div class="mt-8 mb-2 px-4 text-xs font-bold text-gray-400 uppercase tracking-wider">System</div>
                    <a href="#" onclick="adminLogout()"
                        class="flex items-center px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"><span
                            class="mr-3">üö™</span> Logout</a>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-4 md:p-8 max-w-7xl mx-auto w-full">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Dashboard</h1>
                    <p class="text-gray-500 mt-1">Live metrics from Client-Side Fetch.</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="ghost-status-toggle"
                        class="bg-yellow-100 text-yellow-800 border border-yellow-200 px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2 hover:bg-yellow-200 transition-colors">
                        <span>üëª Ghost Mode: OFF</span>
                    </button>
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full">ADMIN</span>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-1">Total Users</div>
                    <div class="text-3xl font-bold text-gray-900" id="stat-total-users">-</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-1">Active Strategies</div>
                    <div class="text-3xl font-bold text-gray-900" id="stat-active-interviews">-</div>
                    <div class="text-xs text-gray-400 mt-2">Paid users engaging</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-1">Sessions Run</div>
                    <div class="text-3xl font-bold text-gray-900" id="stat-avg-duration">-</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-sm text-gray-500 font-medium mb-1">Est. Revenue</div>
                    <div class="text-3xl font-bold text-gray-900" id="stat-revenue">$0</div>
                    <div class="text-xs text-green-600 mt-2 font-medium">Lifetime value</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Activity Overview (Logs)</h3>
                    <canvas id="activityChart" height="200"></canvas>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Top Job Types</h3>
                    <canvas id="jobTypeChart" height="200"></canvas>
                </div>
            </div>

            <!-- Recent Signups Table -->
            <div class="mb-12">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Recent Signups</h3>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto table-responsive">
                        <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="bg-gray-50 text-gray-500 font-semibold border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4">User</th>
                                    <th class="px-6 py-4">Plan</th>
                                    <th class="px-4 py-4 text-center">üõ°Ô∏è</th>
                                    <th class="px-4 py-4 text-center">üïµÔ∏è</th>
                                    <th class="px-4 py-4 text-center">üó∫Ô∏è</th>
                                    <th class="px-4 py-4 text-center">üìù</th>
                                    <th class="px-4 py-4 text-center">üé§</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="9" class="px-6 py-8 text-center text-gray-400">Loading Client Data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Error Logs -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-red-600 mb-4">üö® Recent Errors</h3>
                <div class="bg-white rounded-2xl shadow-sm border border-red-100 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-red-50 text-red-700">
                            <tr>
                                <th class="px-6 py-3">Time</th>
                                <th class="px-6 py-3">User</th>
                                <th class="px-6 py-3">Error</th>
                            </tr>
                        </thead>
                        <tbody id="errors-table-body"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://nvfjmqacxzlmfamiynuu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZmptcWFjeHpsbWZhbWl5bnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzk3MzAsImV4cCI6MjA4MDcxNTczMH0.W3J-E2ldrc99btVeChF0SauTQxr_48uFwImVaoHfOXI';

        // Revert to Default Supabase Client directly (Safest)
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true }
        });

        // Mobile Sidebar
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        mobileBtn.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
        document.addEventListener('click', (e) => {
            if (window.innerWidth < 768 && !sidebar.contains(e.target) && !mobileBtn.contains(e.target)) sidebar.classList.add('-translate-x-full');
        });

        // --- AUTH & DATA LOGIC ---
        async function loadAdminData() {
            console.log("Starting LoadAdminData...");
            try {
                // 1. Check Auth (Session or Token)
                const { data: { session }, error } = await supabase.auth.getSession();
                let currentUser = session?.user;

                if (!currentUser) {
                    const token = localStorage.getItem('supabase.auth.token');
                    if (token) {
                        try {
                            const { data: u, error: e } = await supabase.auth.getUser(token);
                            if (u) currentUser = u.user;
                        } catch (e) { console.warn("Token check failed", e); }
                    }
                }

                if (!currentUser) {
                    console.warn("No user found, redirecting");
                    window.location.href = '/login.html';
                    return;
                }

                // 2. Refresh Role Check (Using limit(1) instead of single() to avoid 406 on some headers)
                const { data: roleData, error: roleError } = await supabase
                    .from('users')
                    .select('role')
                    .eq('id', currentUser.id)
                    .limit(1); // FIX: Don't use .single()

                if (roleError || !roleData || roleData.length === 0 || roleData[0].role !== 'admin') {
                    console.error("Auth Fail", roleError, roleData);
                    alert("‚õî Access Denied: Admin role required.");
                    window.location.href = '/dashboard.html';
                    return;
                }

                // 3. Parallel Fetch (Users, Logs, Errors)
                // FIX: Remove 'head:true' from count or use simple fetch
                console.log("Fetching Data...");

                const [usersRes, logsRes, errRes] = await Promise.all([
                    supabase.from('users').select('*').order('created_at', { ascending: false }).limit(200),
                    supabase.from('activity_logs').select('metadata, feature, created_at').order('created_at', { ascending: false }).limit(300),
                    supabase.from('error_logs').select('*').order('created_at', { ascending: false }).limit(5)
                ]);

                if (usersRes.error) console.error("Users Fetch Error:", usersRes.error);
                if (logsRes.error) console.error("Logs Fetch Error:", logsRes.error);

                // 4. Client-Side Aggregation
                const users = usersRes.data || [];
                const logs = logsRes.data || [];
                const errors = errRes.data || [];

                // Stats
                // For Total Count, try a separate simple count query, but fallback to length if it fails
                let realTotal = users.length;
                try {
                    const cRes = await supabase.from('users').select('id', { count: 'exact', head: true });
                    if (cRes.count !== null) realTotal = cRes.count;
                } catch (e) { console.warn("Count failed", e); }

                let activeStrategies = 0;
                let revenue = 0;

                users.forEach(u => {
                    // Revenue
                    if (u.is_unlimited) revenue += 29.99;
                    else if (u.subscription_status === 'active') revenue += 9.99;

                    // Active Strategy
                    if ((u.credits_negotiation || 0) > 0 || (u.credits_30_60_90 || 0) > 0 || (u.credits_inquisitor || 0) > 0 || (u.credits_interview_sim || 0) > 0) {
                        activeStrategies++;
                    }
                });

                // Render Dashboard
                const computedData = {
                    total_users: realTotal,
                    active_interviews: activeStrategies,
                    total_revenue: Math.round(revenue * 100) / 100,
                    avg_duration: logs.length,
                    recent_users: users.slice(0, 50),
                    recent_errors: errors,
                    logs: logs
                };

                renderDashboard(computedData);

            } catch (e) {
                console.error("Admin Load Critical Error:", e);
                // Try to render what we have or show error on screen
                document.getElementById('stat-total-users').innerText = "Err";
            }
        }

        function renderDashboard(data) {
            document.getElementById('stat-total-users').textContent = data.total_users;
            document.getElementById('stat-active-interviews').textContent = data.active_interviews;
            document.getElementById('stat-avg-duration').textContent = data.avg_duration;
            document.getElementById('stat-revenue').textContent = '$' + data.total_revenue;

            // Render Users
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            data.recent_users.forEach(user => {
                const planBadge = user.is_unlimited
                    ? '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">UNLIMITED</span>'
                    : '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-bold">BASIC</span>';

                const renderCredit = (count) => user.is_unlimited ? '<span class="text-green-500 font-bold">‚àû</span>' : (count > 0 ? `<span class="text-slate-800 font-bold">${count}</span>` : '<span class="text-gray-300">-</span>');

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${user.name || 'User'}</div>
                            <div class="text-xs text-gray-500">${user.email}</div>
                        </td>
                        <td class="px-6 py-4">${planBadge}</td>
                        <td class="px-4 py-4 text-center bg-gray-50/50">${renderCredit(user.credits_negotiation || 0)}</td>
                        <td class="px-4 py-4 text-center">${renderCredit(user.credits_inquisitor || 0)}</td>
                        <td class="px-4 py-4 text-center bg-gray-50/50">${renderCredit(user.credits_30_60_90 || 0)}</td>
                        <td class="px-4 py-4 text-center">${renderCredit(user.credits_cover_letter || 0)}</td>
                        <td class="px-4 py-4 text-center bg-gray-50/50">${renderCredit(user.credits_interview_sim || 0)}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">${(user.subscription_status || 'free').toUpperCase()}</span></td>
                        <td class="px-6 py-4 text-right">
                             <select onchange="handleAction(this, '${user.email}')" class="text-sm p-1 border rounded"><option value="">Action...</option><option value="add_credit_strategy">Add All Credits</option></select>
                        </td>
                    </tr>
                `;
            });

            // Errors
            const errBody = document.getElementById('errors-table-body');
            errBody.innerHTML = '';
            data.recent_errors.forEach(e => {
                errBody.innerHTML += `<tr><td class="px-6 py-3">${new Date(e.created_at).toLocaleString()}</td><td class="px-6 py-3">${e.user_email || '-'}</td><td class="px-6 py-3 text-red-600">${e.error_type}</td></tr>`;
            });
        }

        async function handleAction(select, email) {
            if (!select.value) return;
            if (confirm("Execute " + select.value + "?")) {
                try {
                    const { data: session } = await supabase.auth.getSession();
                    const res = await fetch('/api/admin/action', {
                        method: 'POST', body: JSON.stringify({ admin_email: session.session.user.email, target_email: email, action_type: select.value }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (res.ok) { alert("Success"); loadAdminData(); }
                    else alert("Failed");
                } catch (e) { alert("Error: " + e); }
            }
            select.value = "";
        }

        function adminLogout() {
            supabase.auth.signOut();
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // Init
        loadAdminData();

    </script>
</body>

</html>