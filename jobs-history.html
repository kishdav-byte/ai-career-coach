<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job History | AI Career Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: '#20C997',
                        navy: '#0d1b2a',
                        'navy-light': '#1b263b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #000000 100%);
            color: #e2e8f0;
        }

        .font-display {
            font-family: 'Outfit', sans-serif;
        }

        .glass-sidebar {
            background: rgba(13, 27, 42, 0.6);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(32, 201, 151, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(32, 201, 151, 0.5);
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-20 lg:w-64 glass-sidebar flex flex-col justify-between h-full z-20 transition-all duration-300">
        <!-- Logo -->
        <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-white/5">
            <div
                class="w-10 h-10 bg-gradient-to-tr from-teal to-blue-600 rounded-xl flex items-center justify-center shrink-0 shadow-[0_0_15px_rgba(32,201,151,0.3)]">
                <span class="font-display font-bold text-white text-xl">AI</span>
            </div>
            <span class="hidden lg:block ml-3 font-display font-bold text-lg tracking-tight text-white">Career<span
                    class="text-teal">Coach</span></span>
        </div>

        <!-- Nav -->
        <nav class="flex-1 py-8 flex flex-col gap-2 px-2 lg:px-4">
            <a href="dashboard.html"
                class="flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                <i class="fas fa-grid-2 group-hover:text-teal transition-colors text-lg w-6 text-center"></i>
                <span class="hidden lg:block font-medium">Dashboard</span>
            </a>

            <a href="interview-history.html"
                class="flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                <i class="fas fa-chart-line group-hover:text-teal transition-colors text-lg w-6 text-center"></i>
                <span class="hidden lg:block font-medium">Performance</span>
            </a>

            <!-- Active Page Indicator using inline style for simplicity or dedicated class -->
            <a href="jobs-history.html"
                class="flex items-center gap-4 px-4 py-3 text-white bg-white/10 rounded-xl transition-all group shadow-[0_0_10px_rgba(32,201,151,0.1)] border border-teal/20">
                <i class="fas fa-briefcase text-teal text-lg w-6 text-center"></i>
                <span class="hidden lg:block font-medium">Job History</span>
            </a>
        </nav>

        <!-- User Profile -->
        <div class="p-4 border-t border-white/5">
            <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-white/5 cursor-pointer transition-colors"
                onclick="logout()">
                <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                    <span id="user-initials" class="font-bold text-white text-sm">--</span>
                </div>
                <div class="hidden lg:block overflow-hidden">
                    <p id="user-name" class="text-sm font-bold text-white truncate">Loading...</p>
                    <p class="text-xs text-gray-400 truncate">Sign Out</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full bg-slate-900/50 relative overflow-hidden">
        <!-- Background Glows -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
            <div
                class="absolute top-[-20%] right-[-10%] w-[800px] h-[800px] bg-teal/10 rounded-full blur-[120px] mix-blend-screen">
            </div>
            <div
                class="absolute bottom-[-20%] left-[-10%] w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[100px] mix-blend-screen">
            </div>
        </div>

        <!-- Header -->
        <header
            class="h-20 border-b border-white/5 flex items-center justify-between px-8 bg-slate-900/80 backdrop-blur-md z-10">
            <div>
                <h1 class="font-display font-bold text-2xl text-white tracking-tight">Job <span
                        class="text-teal">Archive</span></h1>
                <p class="text-xs text-gray-400 mt-1">Review active and closed opportunities</p>
            </div>
            <a href="dashboard.html" onclick="openAddModalFromHistory()"
                class="bg-teal hover:bg-teal/80 text-navy font-bold px-6 py-2.5 rounded-xl transition-all shadow-[0_0_20px_rgba(32,201,151,0.4)] hover:shadow-[0_0_30px_rgba(32,201,151,0.6)] flex items-center gap-2">
                <i class="fas fa-plus"></i>
                Add Job
            </a>
        </header>

        <!-- Content Scroll Area -->
        <div class="flex-1 overflow-y-auto custom-scroll p-8 z-10">
            <div class="max-w-7xl mx-auto space-y-8">

                <!-- Stats Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-card rounded-2xl p-6 flex flex-col">
                        <span class="text-xs text-slate-400 uppercase tracking-widest font-bold">Total Evaluated</span>
                        <span id="stat-total" class="text-3xl font-bold text-white mt-1">--</span>
                    </div>
                    <div class="glass-card rounded-2xl p-6 flex flex-col relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-teal"></div>
                        <span class="text-xs text-slate-400 uppercase tracking-widest font-bold">Active Funnel</span>
                        <span id="stat-active" class="text-3xl font-bold text-teal mt-1">--</span>
                    </div>
                    <div class="glass-card rounded-2xl p-6 flex flex-col relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-slate-600"></div>
                        <span class="text-xs text-slate-400 uppercase tracking-widest font-bold">Closed /
                            Archived</span>
                        <span id="stat-closed" class="text-3xl font-bold text-slate-400 mt-1">--</span>
                    </div>
                </div>

                <!-- History Table Section -->
                <div class="glass-card rounded-2xl p-0 border border-white/10 overflow-hidden">
                    <div class="p-6 border-b border-white/5 flex items-center justify-between">
                        <h2 class="font-display font-bold text-xl text-white">Full History</h2>
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <input type="text" id="search-input" onkeyup="filterTable()"
                                    placeholder="Search roles..."
                                    class="bg-black/20 border border-white/10 rounded-lg py-1.5 px-3 text-sm text-white focus:outline-none focus:border-teal/50 w-48 transition-all">
                            </div>
                            <button id="refresh-btn" onclick="initPage()"
                                class="text-gray-400 hover:text-white transition-colors text-sm"><i
                                    class="fas fa-sync-alt mr-1"></i> Refresh</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-white/5 text-gray-400 text-xs uppercase tracking-wider font-bold">
                                    <th class="p-4 border-b border-white/5">Date Added</th>
                                    <th class="p-4 border-b border-white/5">Role</th>
                                    <th class="p-4 border-b border-white/5">Company</th>
                                    <th class="p-4 border-b border-white/5 text-center">Status</th>
                                    <th class="p-4 border-b border-white/5 text-center">Days Open</th>
                                    <th class="p-4 border-b border-white/5 text-center">Interview Fit</th>
                                    <th class="p-4 border-b border-white/5 text-center">Resume Fit</th>
                                    <th class="p-4 border-b border-white/5 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body" class="text-sm text-gray-300">
                                <tr>
                                    <td colspan="8" class="p-8 text-center text-gray-500 italic">Accessing archives...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- JOB DRAWER -->
        <div id="drawer-overlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm z-20 hidden transition-opacity"
            onclick="closeDrawer()"></div>

        <aside id="job-drawer"
            class="absolute top-0 right-0 w-[500px] h-full glass-sidebar z-30 border-l border-white/10 flex flex-col shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out bg-[#0d1b2a]">

            <!-- Drawer Header -->
            <div class="p-6 border-b border-white/10 flex justify-between items-start bg-slate-900/50">
                <div>
                    <h2 id="drawer-role" class="text-2xl font-display font-bold text-white leading-tight">Role Name</h2>
                    <p id="drawer-company" class="text-teal font-medium">Company Name</p>
                </div>
                <button onclick="closeDrawer()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Drawer Content -->
            <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-6">

                <!-- Status & Date -->
                <div class="flex items-center justify-between text-sm">
                    <div>
                        <span class="block text-xs uppercase text-gray-500 font-bold tracking-wider mb-1">Status</span>
                        <div id="drawer-status">--</div>
                    </div>
                    <div class="text-right">
                        <span class="block text-xs uppercase text-gray-500 font-bold tracking-wider mb-1">Date
                            Added</span>
                        <span id="drawer-date" class="text-white font-mono">--</span>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <span class="block text-xs uppercase text-gray-500 font-bold tracking-wider mb-2">Job
                        Description</span>
                    <div id="drawer-description"
                        class="p-4 rounded-xl bg-white/5 border border-white/5 text-gray-400 text-sm leading-relaxed max-h-[300px] overflow-y-auto custom-scroll">
                        --
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <span class="block text-xs uppercase text-gray-500 font-bold tracking-wider mb-2">Intel /
                        Notes</span>
                    <div id="drawer-notes"
                        class="p-4 rounded-xl bg-white/5 border border-white/5 text-gray-400 text-sm leading-relaxed italic">
                        --
                    </div>
                </div>

            </div>

            <!-- Drawer Footer -->
            <div class="p-6 border-t border-white/10 bg-slate-900/50 space-y-3">
                <button id="btn-launch" onclick=""
                    class="w-full bg-teal hover:bg-teal/80 text-navy font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(32,201,151,0.2)]">
                    <i class="fas fa-rocket"></i> Launch Strategy Hub
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-interview" onclick=""
                        class="bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 border border-indigo-500/30 py-2 rounded-lg text-xs font-bold transition-all">
                        <i class="fas fa-microphone mr-1"></i> Practice
                    </button>
                    <button id="btn-resume" onclick=""
                        class="bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/30 py-2 rounded-lg text-xs font-bold transition-all">
                        <i class="fas fa-file-alt mr-1"></i> Check Resume
                    </button>
                </div>
            </div>

        </aside>

    </main>

    <script>
        // --- SUPABASE SETUP ---
        const supabaseUrl = 'https://nvfjmqacxzlmfamiynuu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZmptcWFjeHpsbWZhbWl5bnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzk3MzAsImV4cCI6MjA4MDcxNTczMH0.W3J-E2ldrc99btVeChF0SauTQxr_48uFwImVaoHfOXI';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        window.supabase = supabaseClient;

        let currentUser = null;
        let allJobs = [];
        let allInterviews = [];

        document.addEventListener('DOMContentLoaded', async () => {
            initPage();
        });

        async function initPage() {
            // AUTH CHECK
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = '/index.html';
                return;
            }
            currentUser = session.user;
            updateUserProfile(session.user);

            await loadData(session.user.id);
        }

        async function loadData(userId) {
            try {
                // 1. Fetch Jobs (Active & Closed) via API (which uses RLS)
                // Using fetch instead of direct supabase to invoke the API logic if needed, 
                // but direct supabase is cleaner for readonly if we had RLS on. 
                // Since api/jobs wraps it, let's use the API to ensure we get the same view.
                const headers = { 'Authorization': `Bearer ${localStorage.getItem('supabase.auth.token')}` };

                // PARALLEL FETCH: Jobs + Interviews (for matching)
                const [jobsRes, interviewsRes] = await Promise.all([
                    fetch('/api/jobs', { headers }),
                    supabaseClient.from('interviews').select('id, job_title, company, overall_score').eq('user_id', userId)
                ]);

                if (!jobsRes.ok) throw new Error("Failed to fetch jobs");

                allJobs = await jobsRes.json();
                const intData = await interviewsRes.data; // Supabase returns object {data, error} but await resolves to it? No, Promise.all resolves... wait.
                // Supabase .select() returns a promise that resolves to {data, error}.
                // So interviewsRes is { data: [...], error: ... }

                allInterviews = intData || [];

                // Render
                updateStats();
                renderTable(allJobs);

            } catch (e) {
                console.error("Error loading history:", e);
                document.getElementById('jobs-table-body').innerHTML = `<tr><td colspan="8" class="p-8 text-center text-red-400">Error loading data: ${e.message}</td></tr>`;
            }
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = allJobs.length;
            const closed = allJobs.filter(j => (j.status || '').toLowerCase() === 'closed').length;
            document.getElementById('stat-closed').innerText = closed;
            document.getElementById('stat-active').innerText = allJobs.length - closed;
        }

        function renderTable(jobs) {
            const tbody = document.getElementById('jobs-table-body');
            tbody.innerHTML = '';

            if (jobs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-gray-500">No jobs tracked yet.</td></tr>`;
                return;
            }

            // Sort by Date Descending (Newest First) if created_at exists, else ID
            const sorted = [...jobs].sort((a, b) => {
                const da = a.created_at ? new Date(a.created_at) : new Date(0);
                const db = b.created_at ? new Date(b.created_at) : new Date(0);
                return db - da;
            });

            sorted.forEach(job => {
                // 1. Calculate Days Open
                let daysOpen = "--";
                let dateAdded = "Unknown";

                if (job.created_at) {
                    const params = { year: 'numeric', month: 'short', day: 'numeric' };
                    dateAdded = new Date(job.created_at).toLocaleDateString(undefined, params);
                    if ((job.status || '').toLowerCase() !== 'closed') {
                        const diff = Date.now() - new Date(job.created_at).getTime();
                        daysOpen = Math.floor(diff / (1000 * 60 * 60 * 24)) + "d";
                    } else {
                        daysOpen = "Closed";
                    }
                }

                // 2. Fuzzy Match Interview Score
                // Logic: Find interview with matching Job Title AND Company
                let bestScore = null;
                const matches = allInterviews.filter(i => {
                    const matchTitle = (i.job_title || '').toLowerCase().includes((job.job_title || 'XYZ').toLowerCase());
                    const matchCo = (i.company || '').toLowerCase().includes((job.company_name || 'XYZ').toLowerCase());
                    return matchTitle || matchCo; // Loose match
                });

                if (matches.length > 0) {
                    // Get highest score
                    const scores = matches.map(m => m.overall_score).filter(s => s !== null);
                    if (scores.length > 0) bestScore = Math.max(...scores);
                }

                // 3. Render
                const tr = document.createElement('tr');
                tr.className = `border-b border-white/5 hover:bg-white/5 transition-colors group`;

                const isClosed = (job.status || '').toLowerCase() === 'closed';

                // Status Badge
                let statusBadge = '';
                if (isClosed) statusBadge = `<span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-slate-800 text-slate-500 border border-slate-700">Archived</span>`;
                else if (job.status === 'Applied') statusBadge = `<span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-blue-500/10 text-blue-400 border border-blue-500/20">Applied</span>`;
                else statusBadge = `<span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-teal/10 text-teal border border-teal/20">Active</span>`;

                // Fit Scores
                const interviewFitParams = bestScore ?
                    (bestScore >= 4 ? ['text-teal', bestScore] : bestScore >= 3 ? ['text-yellow-400', bestScore] : ['text-red-400', bestScore])
                    : ['text-slate-600', '-'];

                tr.innerHTML = `
                    <td class="p-4 text-gray-400 text-xs font-mono">${dateAdded}</td>
                    <td class="p-4 text-white font-bold">${job.job_title || 'New Role'}</td>
                    <td class="p-4 text-gray-400 text-sm">${job.company_name || 'New Company'}</td>
                    <td class="p-4 text-center">${statusBadge}</td>
                    <td class="p-4 text-center text-xs font-mono text-gray-400">${daysOpen}</td>
                    <td class="p-4 text-center text-sm font-bold ${interviewFitParams[0]}">${interviewFitParams[1]}</td>
                    <td class="p-4 text-center text-xs text-white font-mono font-bold">${job.resume_fit ? job.resume_fit + '%' : 'N/A'}</td>
                    <td class="p-4 text-right">
                        ${isClosed ?
                        `<button onclick="reviveJob('${job.id}')" class="text-xs bg-slate-800 hover:bg-teal hover:text-navy text-teal border border-teal/30 px-3 py-1 rounded transition-colors font-bold uppercase tracking-wider">Revive</button>`
                        : `<button onclick="openDrawer('${job.id}')" class="text-xs text-gray-500 hover:text-white px-3 py-1 transition-colors">View</button>`
                    }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- DRAWER LOGIC ---
        function openDrawer(id) {
            const job = allJobs.find(j => j.id === id);
            if (!job) return;

            // Populate Fields
            document.getElementById('drawer-role').innerText = job.job_title || 'New Role';
            document.getElementById('drawer-company').innerText = job.company_name || 'New Company';

            // Status
            const isClosed = (job.status || '').toLowerCase() === 'closed';
            const statusEl = document.getElementById('drawer-status');
            if (isClosed) statusEl.innerHTML = `<span class="inline-block px-2 py-1 rounded text-[10px] font-bold uppercase bg-slate-800 text-slate-500 border border-slate-700">Archived</span>`;
            else if (job.status === 'Applied') statusEl.innerHTML = `<span class="inline-block px-2 py-1 rounded text-[10px] font-bold uppercase bg-blue-500/10 text-blue-400 border border-blue-500/20">Applied</span>`;
            else statusEl.innerHTML = `<span class="inline-block px-2 py-1 rounded text-[10px] font-bold uppercase bg-teal/10 text-teal border border-teal/20">Active</span>`;

            // Date
            const d = new Date(job.created_at || Date.now());
            document.getElementById('drawer-date').innerText = d.toLocaleDateString();

            // Content
            document.getElementById('drawer-description').innerText = job.job_description || 'No description provided.';
            document.getElementById('drawer-notes').innerText = job.notes || 'No notes.';

            // Buttons
            document.getElementById('btn-launch').onclick = () => window.location.href = `/dashboard.html?id=${id}`;
            document.getElementById('btn-interview').onclick = () => launchTool(job, '/app.html#interview');
            document.getElementById('btn-resume').onclick = () => launchTool(job, '/resume-analyzer.html');

            // Optimized Resume Button
            const resumeBtn = document.getElementById('btn-opt-resume');
            if (job.optimized_resume) {
                if (!resumeBtn) {
                    // Inject if missing (or update existing)
                    const container = document.getElementById('btn-resume').parentElement;
                    const btn = document.createElement('button');
                    btn.id = 'btn-opt-resume';
                    btn.className = "col-span-2 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2";
                    btn.innerHTML = '<i class="fas fa-external-link-alt"></i> Open Optimized Resume';
                    btn.onclick = () => openResumeOptimization(job);
                    container.appendChild(btn);
                } else {
                    resumeBtn.style.display = 'flex';
                    resumeBtn.onclick = () => openResumeOptimization(job);
                }
            } else {
                if (resumeBtn) resumeBtn.style.display = 'none';
            }

            // Show
            const drawer = document.getElementById('job-drawer');
            const overlay = document.getElementById('drawer-overlay');
            overlay.classList.remove('hidden');
            // Trigger reflow
            void drawer.offsetWidth;
            drawer.classList.remove('translate-x-full');
            // Animate overlay
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
        }

        function closeDrawer() {
            const drawer = document.getElementById('job-drawer');
            const overlay = document.getElementById('drawer-overlay');

            drawer.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');

            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
        }

        function launchTool(job, url) {
            // Save Context
            const context = {
                role: job.job_title,
                company: job.company_name,
                jd: job.job_description,
                notes: job.notes,
                job_id: job.id
            };
            localStorage.setItem('mission_context', JSON.stringify(context));
            if (url.includes('app.html')) sessionStorage.setItem('missionLaunch', 'true'); // Trigger auto-start for simulator

            window.location.href = url.includes('#') ? `${url.split('#')[0]}?id=${job.id}#${url.split('#')[1]}` : `${url}?id=${job.id}`;
        }

        // --- ACTIONS ---
        async function reviveJob(id) {
            if (!confirm("Restore this job to your active queue?")) return;

            try {
                // Determine target status (default to Engage)
                const updates = { status: 'Engage' };
                const headers = {
                    'Authorization': `Bearer ${localStorage.getItem('supabase.auth.token')}`,
                    'Content-Type': 'application/json'
                };

                const res = await fetch(`/api/jobs/${id}`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(updates)
                });

                if (!res.ok) throw new Error("Revive failed");

                // Refresh
                initPage();

            } catch (e) {
                alert(e.message);
            }
        }

        function filterTable() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = allJobs.filter(j =>
                (j.job_title || '').toLowerCase().includes(term) ||
                (j.company_name || '').toLowerCase().includes(term)
            );
            renderTable(filtered);
        }

        // --- AUTH/DATA UTILS (Mirrored) ---
        function updateUserProfile(user) {
            if (user.email) {
                const initials = user.email.substring(0, 2).toUpperCase();
                document.getElementById('user-initials').textContent = initials;
                document.getElementById('user-name').textContent = user.email;
            }
        }
        function logout() {
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('aceinterview_session');
            window.location.href = '/login.html';
        }
        // Redirect to dashboard modal logic is complex, simpler to just go to dashboard
        window.openAddModalFromHistory = function () {
            window.location.href = 'dashboard.html';
            // Ideally passing a param to open modal, but simple redirect is safer for now.
        }

        function openResumeOptimization(job) {
            // DEBUG: Trace Data
            const resumeData = job.optimized_resume;
            // alert("DEBUG: Saving Resume Data: " + (resumeData ? "Exists" : "NULL"));

            if (!resumeData) {
                alert("Error: No optimized resume data found for this job.");
                return;
            }

            // 1. Save Resume Data for Loading
            localStorage.setItem('resume_load_context', JSON.stringify(resumeData));

            // 2. Save Mission Context (to keep ID and nav valid)
            const context = {
                role: job.job_title,
                company: job.company_name,
                jd: job.job_description,
                notes: job.notes,
                job_id: job.id
            };
            localStorage.setItem('mission_context', JSON.stringify(context));

            // 3. Launch NEW Viewer
            window.open('/resume-viewer.html', '_blank');
        }

    </script>
</body>

</html>