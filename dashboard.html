<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Hub - AceInterview</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: '#0A2540',
                        teal: '#20C997',
                        slate: {
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Initialization
        const SUPABASE_URL = 'https://nvfjmqacxzlmfamiynuu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZmptcWFjeHpsbWZhbWl5bnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzk3MzAsImV4cCI6MjA4MDcxNTczMH0.W3J-E2ldrc99btVeChF0SauTQxr_48uFwImVaoHfOXI';

        // Initialize Supabase Client
        window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Auth Logic Pre-check
        const SESSION_KEY = 'supabase.auth.token';
        const token = localStorage.getItem(SESSION_KEY);
        if (!token) {
            window.location.href = '/login.html';
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-card:hover {
            border-color: rgba(32, 201, 151, 0.3);
        }

        /* Custom Scrollbar for Kanban */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        .mission-card {
            transition: all 0.2s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #475569;
        }

        /* Custom Ring for Resume Health */
        .ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Action Chips */
        .action-chip {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .action-chip:hover {
            background: rgba(32, 201, 151, 0.1);
            border-color: rgba(32, 201, 151, 0.4);
            color: #20C997;
            transform: translateY(-1px);
        }
    </style>
</head>


<body class="min-h-screen bg-slate-950 text-slate-300 font-sans selection:bg-teal selection:text-black">

    <div class="flex md:h-screen min-h-screen bg-slate-950 relative flex-col md:flex-row">

        <!-- MOBILE HEADER (Visible < lg) -->
        <div
            class="md:hidden fixed top-0 left-0 w-full h-16 bg-slate-900 border-b border-white/5 flex items-center justify-between px-6 z-50">
            <div class="font-black text-xl tracking-tighter text-teal">ACE_CORP</div>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- SIDEBAR (Fixed Left) -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 w-[250px] bg-slate-900 border-r border-white/5 flex flex-col transition-transform duration-300 ease-in-out z-40 -translate-x-full md:translate-x-0 md:static">

            <!-- Logo Area -->
            <div class="h-20 flex items-center px-8 mt-4 lg:mt-0">
                <h1
                    class="font-bold text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                    AceInterview
                </h1>
            </div>

            <!-- Navigation Stack -->
            <nav class="flex-1 px-4 space-y-2 mt-4 overflow-y-auto custom-scroll" id="nav-accordion">
                <!-- Dashboard -->
                <a href="/dashboard.html"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all relative group text-slate-400 hover:text-white hover:bg-white/5"
                    data-path="/dashboard.html">
                    <i class="fas fa-columns w-5 text-center"></i>
                    <span>Dashboard</span>
                </a>

                <!-- The Clinic Category -->
                <div class="nav-group">
                    <button onclick="toggleGroup('clinic')"
                        class="w-full flex items-center justify-between px-4 py-3 text-sm font-bold text-white rounded-lg hover:bg-white/5 transition-colors group">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-user-md text-slate-500 group-hover:text-white w-5 text-center"></i>
                            <span>The Clinic</span>
                        </div>
                        <i id="icon-clinic"
                            class="fas fa-chevron-right text-xs text-slate-500 transform transition-transform duration-200"></i>
                    </button>
                    <div id="group-clinic" class="pl-4 space-y-1 mt-1 border-l border-white/5 ml-4 hidden">
                        <a href="/resume-analyzer.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/resume-analyzer.html">Resume Scanner</a>
                        <a href="/resume-rewriter.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/resume-rewriter.html">Executive Rewrite</a>
                        <a href="/app.html#linkedin"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/app.html#linkedin">LinkedIn Optimizer</a>
                        <a href="/cover-letter.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/cover-letter.html">Cover Letter Architect</a>
                    </div>
                </div>

                <!-- The Simulator Category -->
                <div class="nav-group">
                    <button onclick="toggleGroup('simulator')"
                        class="w-full flex items-center justify-between px-4 py-3 text-sm font-bold text-white rounded-lg hover:bg-white/5 transition-colors group">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-microchip text-slate-500 group-hover:text-white w-5 text-center"></i>
                            <span>The Simulator</span>
                        </div>
                        <i id="icon-simulator"
                            class="fas fa-chevron-right text-xs text-slate-500 transform transition-transform duration-200"></i>
                    </button>
                    <div id="group-simulator" class="pl-4 space-y-1 mt-1 border-l border-white/5 ml-4 hidden">
                        <a href="/app.html#interview"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/app.html#interview">Mock Interview</a>
                        <a href="/lab-assistant.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/lab-assistant.html">Lab Assistant (Tools)</a>
                        <a href="/role-reversal.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/role-reversal.html">Role Reversal</a>
                        <a href="/star-drill.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/star-drill.html">STAR Drill</a>
                    </div>
                </div>

                <!-- Strategy Category -->
                <div class="nav-group">
                    <button onclick="toggleGroup('strategy')"
                        class="w-full flex items-center justify-between px-4 py-3 text-sm font-bold text-white rounded-lg hover:bg-white/5 transition-colors group">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chess-knight text-slate-500 group-hover:text-white w-5 text-center"></i>
                            <span>Strategy</span>
                        </div>
                        <i id="icon-strategy"
                            class="fas fa-chevron-right text-xs text-slate-500 transform transition-transform duration-200"></i>
                    </button>
                    <div id="group-strategy" class="pl-4 space-y-1 mt-1 border-l border-white/5 ml-4 hidden">
                        <a href="/strategy/30-60-90.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/strategy/30-60-90.html">30-60-90 Plan</a>
                        <a href="/strategy/closer.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/strategy/closer.html">Salary Negotiation</a>
                        <a href="/follow-up.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md"
                            data-path="/follow-up.html">Strategic Follow-Up</a>
                    </div>
                </div>

                <!-- Upgrade Hub -->
                <div class="nav-group pt-4 border-t border-white/5">
                    <div class="px-4 py-2 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                        Upgrade Hub
                    </div>
                    <button onclick="buyCredits('price_1Sbq1WIH1WTKNasqXrlCBDSD', 'subscription')"
                        class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-teal rounded-lg hover:bg-teal/10 transition-all group">
                        <i class="fas fa-crown"></i>
                        <span>Monthly Package ($49.99)</span>
                    </button>
                    <button onclick="buyCredits('price_1SeRRnIH1WTKNasqQFCJDxH5', 'payment')"
                        class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 rounded-lg hover:text-white hover:bg-white/5 transition-all group">
                        <i class="fas fa-bolt"></i>
                        <span>Executive Rewrite ($9.99)</span>
                    </button>
                </div>
            </nav>

            <!-- User Footer -->
            <div class="p-4 border-t border-white/5">
                <div
                    class="flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors cursor-pointer group">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-teal/20 flex items-center justify-center text-teal text-xs font-bold border border-teal/30">
                            <span id="user-initials">--</span>
                        </div>
                        <div class="flex flex-col">
                            <span id="user-display-sidebar"
                                class="text-sm font-medium text-white group-hover:text-teal transition-colors">User</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-wider">Plan: <span
                                    id="user-plan-status">Free</span></span>
                        </div>
                    </div>
                    <button onclick="signOut()" class="text-gray-500 hover:text-white transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT WRAPPER -->
        <div class="flex-1 flex flex-col min-w-0 lg:ml-0 overflow-x-hidden overflow-y-auto relative">

            <!-- Mobile Overlay -->
            <div id="mobile-overlay" class="md:hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-30 hidden"
                onclick="toggleSidebar()"></div>

            <!-- Top Spacer for Mobile Header -->
            <div class="h-16 md:hidden flex-shrink-0"></div>

            <!-- Scrollable Content Area -->
            <main
                class="flex-1 flex flex-col p-4 md:p-8 relative bg-gradient-to-br from-slate-900 via-[#0A2540] to-black overflow-y-auto md:h-screen">

                <div class="max-w-7xl mx-auto w-full flex-shrink-0">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1
                                class="text-xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                                Executive Performance Hub
                            </h1>
                            <p class="text-gray-400 text-sm mt-1">Ready to dominate, <span id="user-display-kb"
                                    class="text-teal">Candidate</span>?</p>
                        </div>
                        <button onclick="openModal()"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-xs tracking-wider transition-all flex items-center gap-2 shadow-[0_0_15px_rgba(37,99,235,0.3)]">
                            <i class="fas fa-plus"></i> ADD TARGET
                        </button>
                    </div>

                    <!-- 1. Key Metrics Row (4 Columns) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

                        <!-- Metric 1: Resume Health -->
                        <a href="/resume-analyzer.html"
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Resume Health
                            </h3>
                            <div class="relative w-24 h-24">
                                <svg class="w-full h-full" viewBox="0 0 100 100">
                                    <circle class="text-slate-700 stroke-current" stroke-width="8" cx="50" cy="50"
                                        r="40" fill="transparent"></circle>
                                    <circle id="resume-score-ring"
                                        class="text-teal progress-ring__circle stroke-current ring-circle"
                                        stroke-width="8" stroke-linecap="round" cx="50" cy="50" r="40"
                                        fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
                                </svg>
                                <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                                    <span id="resume-score" class="text-2xl font-bold text-white">--</span>
                                </div>
                            </div>
                        </a>

                        <!-- Metric 2: Avg Interview Score -->
                        <a href="/role-reversal.html"
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Avg. Interview
                                Score</h3>
                            <div id="interview-score" class="text-4xl font-bold text-white mb-2">--<span
                                    class="text-gray-500 text-xl">/10</span></div>
                            <div
                                class="flex items-center text-teal text-xs font-bold bg-teal/10 px-2 py-1 rounded-full">
                                <span>Active</span>
                            </div>
                        </a>

                        <!-- Metric 3: Strategy Log -->
                        <div
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Active Strategy
                            </h3>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-2xl">‚ôüÔ∏è</span>
                                <span id="strategy-count" class="text-4xl font-bold text-white">--</span>
                            </div>
                            <span class="text-gray-500 text-xs uppercase tracking-wider">Jobs Tracked</span>
                        </div>

                        <!-- Metric 4: Credits -->
                        <div
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center relative group hover:border-teal/30 transition-colors">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20"></div>
                            <h3 id="plan-type-label"
                                class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Plan</h3>
                            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden mb-3">
                                <div id="credit-bar" class="bg-teal h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between w-full text-xs">
                                <span id="credit-count" class="text-white font-bold">-- Credits</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KANBAN BOARD (Flex grow to fill rest of screen) -->
                <div
                    class="flex-1 overflow-x-auto overflow-y-hidden custom-scroll w-full pb-6 snap-x snap-mandatory min-h-[600px] md:min-h-0">
                    <div class="flex gap-4 h-full px-1">

                        <!-- COLUMN 1: TARGETS -->
                        <div
                            class="flex-1 flex flex-col min-w-[85vw] md:min-w-[350px] snap-center bg-slate-900/40 rounded-xl border border-dashed border-slate-700/50">
                            <div
                                class="p-4 border-b border-slate-700/50 flex items-center justify-between sticky top-0 bg-[#0d1b2a]/90 backdrop-blur-sm rounded-t-xl z-10">
                                <h3
                                    class="text-xs font-bold font-mono tracking-widest text-slate-400 uppercase flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                                    Targets
                                </h3>
                                <span id="count-identified"
                                    class="bg-slate-800 text-slate-400 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                            </div>
                            <div id="col-identified" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                                <!-- Cards injected here -->
                            </div>
                        </div>

                        <!-- COLUMN 2: APPLIED -->
                        <div
                            class="flex-1 flex flex-col min-w-[85vw] md:min-w-[350px] snap-center bg-blue-900/10 rounded-xl border border-dashed border-blue-900/30">
                            <div
                                class="p-4 border-b border-blue-900/20 flex items-center justify-between sticky top-0 bg-[#0d1b2a]/90 backdrop-blur-sm rounded-t-xl z-10">
                                <h3
                                    class="text-xs font-bold font-mono tracking-widest text-blue-400 uppercase flex items-center gap-2">
                                    <span
                                        class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]"></span>
                                    Applied
                                </h3>
                                <span id="count-applied"
                                    class="bg-blue-900/30 text-blue-300 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                            </div>
                            <div id="col-applied" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                                <!-- Cards injected here -->
                            </div>
                        </div>

                        <!-- COLUMN 3: INTERVIEWING -->
                        <div
                            class="flex-1 flex flex-col min-w-[85vw] md:min-w-[350px] snap-center bg-purple-900/10 rounded-xl border border-dashed border-purple-900/30">
                            <div
                                class="p-4 border-b border-purple-900/20 flex items-center justify-between sticky top-0 bg-[#0d1b2a]/90 backdrop-blur-sm rounded-t-xl z-10">
                                <h3
                                    class="text-xs font-bold font-mono tracking-widest text-purple-400 uppercase flex items-center gap-2">
                                    <span
                                        class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.6)] animate-pulse"></span>
                                    War Zone
                                </h3>
                                <span id="count-interviewing"
                                    class="bg-purple-900/30 text-purple-300 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                            </div>
                            <div id="col-interviewing" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                                <!-- Cards injected here -->
                            </div>
                        </div>

                        <!-- COLUMN 4: OFFER / CLOSED -->
                        <div
                            class="flex-1 flex flex-col min-w-[85vw] md:min-w-[350px] snap-center bg-green-900/10 rounded-xl border border-dashed border-green-900/30">
                            <div
                                class="p-4 border-b border-green-900/20 flex items-center justify-between sticky top-0 bg-[#0d1b2a]/90 backdrop-blur-sm rounded-t-xl z-10">
                                <h3
                                    class="text-xs font-bold font-mono tracking-widest text-green-400 uppercase flex items-center gap-2">
                                    <span
                                        class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                                    Offer / Closed
                                </h3>
                                <span id="count-offer"
                                    class="bg-green-900/30 text-green-300 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                            </div>
                            <div id="col-offer" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                                <!-- Cards injected here -->
                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Add Job Modal -->
    <div id="add-modal"
        class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-200 p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-xl shadow-2xl transform scale-95 transition-transform duration-200 max-h-[90vh] overflow-y-auto custom-scroll"
            id="modal-content">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-800/50 rounded-t-xl">
                <h3 class="text-white font-bold font-mono tracking-wide">NEW_TARGET_ACQUISITION</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-job-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Target
                        Company</label>
                    <input type="text" name="company_name" required placeholder="e.g. Acme Corp"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Role
                        Title</label>
                    <input type="text" name="job_title" required placeholder="e.g. Senior Strategist"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Job Description
                        / Intel</label>
                    <textarea name="job_description" rows="5" placeholder="Paste JD or context here..."
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600 resize-none custom-scroll"></textarea>
                </div>
                <div class="pt-4">
                    <button type="submit" id="btn-save"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all">
                        <span>INITIATE CAMPAIGN</span>
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mission Dossier Slide-Over -->
    <div id="mission-dossier"
        class="fixed inset-y-0 right-0 w-full md:w-[600px] bg-slate-900 border-l border-slate-700 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <div class="p-6 border-b border-slate-700 bg-slate-950 flex justify-between items-center">
            <div>
                <h2 class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-1">MISSION DOSSIER</h2>
                <h3 id="dossier-title" class="text-xl font-bold text-white truncate w-80">Job Title</h3>
                <p id="dossier-company" class="text-sm text-slate-400">Company Name</p>
            </div>
            <button onclick="closeDossier()" class="text-slate-500 hover:text-white transition-colors"><i
                    class="fas fa-times text-xl"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-8 space-y-8 custom-scroll">

            <div class="space-y-3">
                <label class="text-xs font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-user-secret"></i> Interviewer Intel & Notes
                </label>
                <textarea id="dossier-notes"
                    class="w-full h-32 bg-slate-800/50 border border-slate-700 rounded-lg p-4 text-sm text-slate-300 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all placeholder-slate-600"
                    placeholder="Example: VP of Ops hates buzzwords. Mention the 'Project Alpha' win. They use Asana for project management..."></textarea>
            </div>

            <div class="space-y-3">
                <label class="text-xs font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-file-alt"></i> Role Requirements (JD)
                </label>
                <textarea id="dossier-jd"
                    class="w-full h-64 bg-slate-800/50 border border-slate-700 rounded-lg p-4 text-sm text-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-mono text-xs leading-relaxed custom-scroll"
                    placeholder="Paste the full Job Description here..."></textarea>
            </div>

            <div class="space-y-3">
                <label class="text-xs font-bold text-green-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-money-bill-wave"></i> Salary Target / Offer
                </label>
                <input type="text" id="dossier-salary"
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-sm text-slate-300 focus:border-green-500 focus:ring-1 focus:ring-green-500"
                    placeholder="e.g. $150k Base + 20% Bonus">
            </div>

        </div>

        <div class="p-6 border-t border-slate-700 bg-slate-950 flex justify-end gap-3">
            <button onclick="closeDossier()"
                class="px-4 py-2 text-slate-400 hover:text-white text-sm font-medium">Cancel</button>
            <button onclick="saveDossier()"
                class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20 flex items-center gap-2">
                <i class="fas fa-save"></i> SAVE INTEL
            </button>
        </div>
    </div>

    <!-- Hidden PDF Logic (Retained for compatibility if needed in future, but hidden from UI) -->
    <div id="resume-drop-zone" style="display:none;"></div>

    <script>
        // --- AUTH & DATA VARS ---
        let currentToken = localStorage.getItem('supabase.auth.token');
        let currentUser = null;

        // --- UI REFS ---
        const modal = document.getElementById('add-modal');
        const modalContent = document.getElementById('modal-content');
        const cols = {
            'Identified': document.getElementById('col-identified'),
            'Applied': document.getElementById('col-applied'),
            'Interviewing': document.getElementById('col-interviewing'),
            'Offer': document.getElementById('col-offer'),
        };
        const counts = {
            'Identified': document.getElementById('count-identified'),
            'Applied': document.getElementById('count-applied'),
            'Interviewing': document.getElementById('count-interviewing'),
            'Offer': document.getElementById('count-offer'),
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!currentToken) return; // redirect handled in head

            // 1. Sidebar Init
            initSidebar();

            // 2. Fetch User & Stats
            await loadUserProfile();

            // 3. Fetch Jobs (Kanban)
            loadJobs();
        });

        // --- DOSSIER LOGIC ---
        let currentJobId = null;
        const dossier = document.getElementById('mission-dossier');

        window.openDossier = async (id) => {
            currentJobId = id;
            const job = localJobsInfo.find(j => j.id === id);
            if (!job) return;

            // Populate Fields
            document.getElementById('dossier-title').innerText = job.job_title;
            document.getElementById('dossier-company').innerText = job.company_name;
            document.getElementById('dossier-jd').value = job.job_description || '';
            document.getElementById('dossier-notes').value = job.notes || '';
            document.getElementById('dossier-salary').value = job.salary_target || '';

            // Slide In
            dossier.classList.remove('translate-x-full');
        };

        window.closeDossier = () => {
            dossier.classList.add('translate-x-full');
            currentJobId = null;
        };

        window.saveDossier = async () => {
            if (!currentJobId) return;
            const btn = document.querySelector('button[onclick="saveDossier()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';

            const updates = {
                job_description: document.getElementById('dossier-jd').value,
                notes: document.getElementById('dossier-notes').value,
                salary_target: document.getElementById('dossier-salary').value
            };

            try {
                const res = await fetch(`/api/jobs/${currentJobId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${currentToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (!res.ok) throw new Error("Save failed");

                // Update local data
                const jobIndex = localJobsInfo.findIndex(j => j.id === currentJobId);
                if (jobIndex > -1) {
                    localJobsInfo[jobIndex] = { ...localJobsInfo[jobIndex], ...updates };
                }

                alert("Mission Dossier updated.");
                closeDossier();
            } catch (e) {
                alert("Error saving dossier: " + e.message);
            } finally {
                btn.innerHTML = originalText;
            }
        };

        // --- JOB LOGIC (Note: Ported from strategy-log.html) ---
        async function loadJobs() {
            try {
                const res = await fetch('/api/jobs', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                if (res.status === 401) { window.location.href = '/login.html'; return; }

                if (!res.ok) throw new Error("Failed to load jobs");
                const jobs = await res.json();

                // Update Strategy Count Stats
                document.getElementById('strategy-count').innerText = jobs.length;

                renderBoard(jobs);
            } catch (e) {
                console.error("Load Jobs Error:", e);
            }
        }

        let localJobsInfo = [];
        function renderBoard(jobs) {
            localJobsInfo = jobs;
            // Clear Cols
            Object.values(cols).forEach(col => col.innerHTML = '');
            // Track counts
            const stats = { 'Identified': 0, 'Applied': 0, 'Interviewing': 0, 'Offer': 0 };

            jobs.forEach(job => {
                let status = job.status || 'Identified';
                // Normalize status
                const s = status.toLowerCase();
                if (s.includes('offer') || s.includes('closed')) status = 'Offer';
                else if (s.includes('interview')) status = 'Interviewing';
                else if (s.includes('appli')) status = 'Applied';
                else status = 'Identified';

                stats[status]++;

                const card = createJobCard(job, status);
                cols[status].insertAdjacentHTML('beforeend', card);
            });

            // Update Header Counts
            Object.keys(counts).forEach(key => {
                counts[key].textContent = stats[key];
            });
        }

        function createJobCard(job, currentStatus) {
            const resScore = job.resume_score || 0;
            const resClass = resScore > 80 ? 'text-green-500' : (resScore > 0 ? 'text-amber-500' : 'text-slate-600');
            const resIcon = resScore > 80 ? 'fa-check-circle' : 'fa-circle';

            // CONTEXT-AWARE Quick Actions (Stacked Task List)
            let quickActions = '';
            const btnClass = "w-full text-left text-xs font-medium px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-500/50 transition-all flex items-center gap-2 text-slate-300 hover:text-white shadow-sm";

            if (currentStatus === 'Identified' || currentStatus === 'Applied') {
                quickActions = `
                    <button onclick="launchTool('${job.id}', '/resume-analyzer.html')" class="${btnClass}">
                        <i class="fas fa-search-dollar w-4 text-center text-teal"></i> üìÑ Resume Scanner
                    </button>
                    <button onclick="launchTool('${job.id}', '/resume-rewriter.html')" class="${btnClass}">
                        <i class="fas fa-magic w-4 text-center text-purple-400"></i> ‚ú® Executive Rewrite
                    </button>
                    <button onclick="launchTool('${job.id}', '/cover-letter.html')" class="${btnClass}">
                        <i class="fas fa-feather-alt w-4 text-center text-blue-400"></i> ‚úçÔ∏è Cover Letter Architect
                    </button>
                    <button onclick="launchTool('${job.id}', '/app.html#linkedin')" class="${btnClass}">
                        <i class="fab fa-linkedin w-4 text-center text-blue-600"></i> üîó LinkedIn Optimizer
                    </button>
                `;
            } else if (currentStatus === 'Interviewing') {
                quickActions = `
                    <button onclick="launchTool('${job.id}', '/app.html#interview')" class="${btnClass}">
                        <i class="fas fa-microphone w-4 text-center text-teal"></i> üé§ Mock Interview Sim
                    </button>
                    <button onclick="launchTool('${job.id}', '/star-drill.html')" class="${btnClass}">
                        <i class="fas fa-star w-4 text-center text-amber-500"></i> ‚≠ê STAR Drill
                    </button>
                    <button onclick="launchTool('${job.id}', '/follow-up.html')" class="${btnClass}">
                        <i class="fas fa-paper-plane w-4 text-center text-purple-400"></i> üì© Strategic Follow-Up
                    </button>
                `;
            } else if (currentStatus === 'Offer') {
                quickActions = `
                    <button onclick="launchTool('${job.id}', '/strategy/closer.html')" class="${btnClass}">
                        <i class="fas fa-handshake w-4 text-center text-green-500"></i> üí∞ Salary Negotiation
                    </button>
                    <button onclick="launchTool('${job.id}', '/strategy/30-60-90.html')" class="${btnClass}">
                        <i class="fas fa-calendar-alt w-4 text-center text-blue-400"></i> üìÖ 30-60-90 Day Plan
                    </button>
                `;
            }

            return `
            <div class="mission-card bg-slate-900 border border-slate-800 rounded-lg p-4 flex flex-col relative group hover:border-slate-600">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-white font-bold text-sm leading-tight mb-1 truncate max-w-[180px]">${job.job_title}</h3>
                        <p class="text-blue-400 font-mono text-[10px] uppercase tracking-wider truncate max-w-[180px]">${job.company_name}</p>
                    </div>
                    <button onclick="deleteJob('${job.id}')" class="text-slate-700 hover:text-red-500 transition-colors p-1 opacity-0 group-hover:opacity-100">
                        <i class="fas fa-trash-alt text-[10px]"></i>
                    </button>
                </div>

                <div class="mb-3">
                    <select onchange="window.updateStatus('${job.id}', this.value)" 
                        class="w-full bg-slate-950 border border-slate-800 rounded text-[10px] font-bold text-slate-400 py-1 px-2 outline-none focus:border-blue-500 cursor-pointer hover:bg-slate-900 transition-colors">
                        <option value="Identified" ${currentStatus === 'Identified' ? 'selected' : ''}>üéØ Identify</option>
                        <option value="Applied" ${currentStatus === 'Applied' ? 'selected' : ''}>üìù Applied</option>
                        <option value="Interviewing" ${currentStatus === 'Interviewing' ? 'selected' : ''}>üé§ Interviewing</option>
                        <option value="Offer" ${currentStatus === 'Offer' ? 'selected' : ''}>ü§ù Offer / Closed</option>
                    </select>
                </div>

                <div class="flex items-center gap-3 mb-3 border-t border-slate-800/50 pt-2">
                    <div class="flex items-center gap-1.5" title="Resume Score">
                        <i class="fas ${resIcon} ${resClass} text-[10px]"></i>
                        <span class="text-[9px] text-slate-500 font-mono">RES: ${resScore > 0 ? resScore + '%' : 'N/A'}</span>
                    </div>
                </div>

                <div class="flex gap-2">
                     <button onclick="window.openDossier('${job.id}')" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white text-[10px] font-bold py-1.5 rounded transition-colors text-center border border-transparent hover:border-blue-500/30">
                        WAR ROOM
                    </button>
                     <button onclick="launchTool('${job.id}', '/strategy/30-60-90.html')" 
                        class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 border border-blue-900/50 hover:border-blue-500/50 px-2 rounded transition-colors" title="Quick Plan">
                        <i class="fas fa-road text-[10px]"></i>
                    </button>
                </div>
                
                <div class="flex flex-col gap-2 mt-4 border-t border-slate-700/50 pt-3">
                    ${quickActions}
                </div>
            </div>
            `;
        }

        window.updateStatus = async (id, newStatus) => {
            try {
                const res = await fetch(`/api/jobs/${id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${currentToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!res.ok) throw new Error("Update failed");
                loadJobs();
            } catch (e) { alert(e.message); }
        };

        window.deleteJob = async (id) => {
            if (!confirm("Remove this target?")) return;
            try {
                const res = await fetch(`/api/jobs/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                if (!res.ok) throw new Error("Failed");
                loadJobs();
            } catch (e) { alert(e.message); }
        };

        window.openWarRoom = (id) => {
            const job = localJobsInfo.find(j => j.id === id);
            if (job) smartLaunch(id, '/resume-rewriter.html', job);
        };

        window.smartLaunch = (id, url, job) => {
            const context = { job_id: id, role: job.job_title, company: job.company_name, description: job.job_description };
            localStorage.setItem('strategy_context', JSON.stringify(context));
            window.location.href = url;
        };

        // --- MODAL LOGIC ---
        window.openModal = () => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }
        window.closeModal = () => {
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        document.getElementById('add-job-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'SAVING...'; btn.disabled = true;

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.status = 'Identified';

            try {
                const res = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error("Failed");
                closeModal();
                e.target.reset();
                loadJobs();
            } catch (err) { alert(err.message); }
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        });


        // --- USER & SIDEBAR LOGIC ---
        async function loadUserProfile() {
            try {
                // Get User from Supabase
                const { data: { user } } = await supabase.auth.getUser(currentToken);
                if (!user) throw new Error("No user");

                // Get Profile
                const { data: profile } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    // Update UI
                    const initials = profile.name ? profile.name.substring(0, 2).toUpperCase() : 'DK';
                    document.getElementById('user-initials').innerText = initials;
                    document.getElementById('user-display-sidebar').innerText = profile.name || 'User';
                    document.getElementById('user-display-kb').innerText = (profile.name || 'Candidate').split(' ')[0];

                    const isPro = profile.subscription_status === 'active';
                    document.getElementById('user-plan-status').innerText = isPro ? 'PRO' : 'Free';

                    // Plan & Credits Logic
                    const creds = profile.credits || 0;
                    const planLabel = document.getElementById('plan-type-label');
                    const creditLabel = document.getElementById('credit-count');
                    const bar = document.getElementById('credit-bar');

                    if (profile.is_unlimited) {
                        planLabel.innerText = "Monthly Unlimited";
                        creditLabel.innerText = "Unlimited Interviews";
                        bar.style.width = '100%';
                        bar.classList.add('bg-purple-500'); // Special color for unlimited
                    } else if (profile.plan_tier === 'strategy_bundle') {
                        planLabel.innerText = "Strategy Bundle";
                        creditLabel.innerText = `${creds} Credits Left`;
                        bar.style.width = `${Math.min(100, (creds / 20) * 100)}%`;
                    } else {
                        planLabel.innerText = "Free Plan";
                        creditLabel.innerText = `${creds} Credits Left`;
                        bar.style.width = `${Math.min(100, (creds / 10) * 100)}%`;
                    }

                    if (isPro) document.getElementById('credit-bar').classList.add('bg-purple-500');

                    // --- REAL-TIME STATS FETCHING ---

                    // 1. Resume Health (Last Scan)
                    const { data: resumeData } = await supabase
                        .from('resume_scans')
                        .select('score')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .maybeSingle();

                    if (resumeData) {
                        setRing(resumeData.score);
                    } else {
                        setRing(0);
                    }

                    // 2. Interview Score (Last Interview Average)
                    // Note: 'interviews' table usually has 'average_score' or 'score' column. 
                    // I will check for 'average_score' based on previous context or fallback to 0.
                    const { data: interviewData } = await supabase
                        .from('interviews')
                        .select('average_score')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .maybeSingle();

                    if (interviewData && interviewData.average_score) {
                        document.getElementById('interview-score').innerHTML = `${interviewData.average_score}<span class="text-gray-500 text-xl">/10</span>`;
                    } else {
                        document.getElementById('interview-score').innerHTML = `0<span class="text-gray-500 text-xl">/10</span>`;
                    }
                }
            } catch (e) {
                console.error("Profile Load Error", e);
            }
        }

        function setRing(score) {
            const circle = document.querySelector('.ring-circle');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (score / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            document.getElementById('resume-score').innerText = score;
        }

        // Sidebar Toggles
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('mobile-overlay');
            sb.classList.toggle('-translate-x-full');
            ov.classList.toggle('hidden');
        }
        function toggleGroup(id) {
            const g = document.getElementById(`group-${id}`);
            const i = document.getElementById(`icon-${id}`);
            g.classList.toggle('hidden');
            i.classList.toggle('rotate-90');
        }
        function initSidebar() {
            const path = window.location.pathname;
            const links = document.querySelectorAll('[data-path]');
            links.forEach(link => {
                if (link.getAttribute('data-path') === path) {
                    link.classList.add('text-teal', 'bg-teal/5');
                    link.classList.remove('text-slate-400');
                    // Open parent
                    const parent = link.closest('.pl-4');
                    if (parent) parent.classList.remove('hidden');
                }
            });
        }

        // --- SMART CONTEXT PASSING ---
        window.launchTool = (jobId, destinationUrl) => {
            const job = localJobsInfo.find(j => j.id === jobId);
            if (!job) {
                // Fallback if job not found (shouldn't happen)
                window.location.href = destinationUrl;
                return;
            }

            const context = {
                company: job.company_name,
                role: job.job_title,
                jd: job.job_description,
                notes: job.notes
            };

            // Save context for receiver tools to pick up
            localStorage.setItem('mission_context', JSON.stringify(context));
            // User requested explicit separate storage for Interview Lab
            if (context.jd) {
                localStorage.setItem('activeJobDescription', context.jd);
            }

            // Redirect
            window.location.href = destinationUrl;
        };

        window.buyCredits = async (priceId, mode) => {
            // simplified
            const { data, error } = await supabase.functions.invoke('create-checkout-session', {
                body: { price_id: priceId, return_url: window.location.href, mode: mode }
            });
            if (data?.url) window.location.href = data.url;
            else alert("Payment init failed");
        }

        window.signOut = () => {
            localStorage.removeItem(SESSION_KEY);
            window.location.href = '/login.html';
        }

    </script>
</body>

</html>