<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Hub - AceInterview</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: '#0A2540',
                        teal: '#20C997',
                        slate: {
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- App Logic -->
    <script src="/app.js"></script>

    <script>
        // Auth Logic Pre-check (Restored)
        const AUTH_TOKEN_KEY = 'supabase.auth.token';
        const token = localStorage.getItem(AUTH_TOKEN_KEY);
        if (!token) {
            window.location.href = '/login.html';
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-card:hover {
            border-color: rgba(32, 201, 151, 0.3);
        }

        /* Custom Scrollbar for Kanban */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        .mission-card {
            transition: all 0.2s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #475569;
        }

        /* Custom Ring for Resume Health */
        .ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Action Chips */
        .action-chip {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .action-chip:hover {
            background: rgba(32, 201, 151, 0.1);
            border-color: rgba(32, 201, 151, 0.4);
            color: #20C997;
            transform: translateY(-1px);
        }

        /* MISSION SPECIALIST CHATBOT STYLES */
        #support-bubble {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 0 15px rgba(32, 201, 151, 0.2);
        }

        .chat-open #support-bubble {
            transform: scale(0);
            opacity: 0;
        }

        #support-window {
            transform-origin: bottom right;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #support-window.hidden {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
            display: flex !important;
            /* Keep flex but scaled to 0 */
        }

        .support-msg-bot {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px 12px 12px 2px;
        }

        .support-msg-user {
            background: rgba(32, 201, 151, 0.1);
            border: 1px solid rgba(32, 201, 151, 0.3);
            border-radius: 12px 12px 2px 12px;
            color: #20C997;
        }
    </style>
</head>


<body class="min-h-screen bg-slate-950 text-slate-300 font-sans selection:bg-teal selection:text-black">

    <div class="flex md:h-screen min-h-screen bg-slate-950 relative flex-col md:flex-row">

        <!-- MOBILE HEADER (Visible < lg) -->
        <div
            class="md:hidden fixed top-0 left-0 w-full h-16 bg-slate-900 border-b border-white/5 flex items-center justify-between px-6 z-50">
            <div class="font-black text-xl tracking-tighter text-teal">ACE_CORP</div>
        </div>

        <!-- SIDEBAR REMOVED -->

        <!-- MAIN CONTENT WRAPPER -->
        <div class="flex-1 flex flex-col min-w-0 lg:ml-0 overflow-x-hidden overflow-y-auto relative">

            <!-- Mobile Overlay -->
            <div id="mobile-overlay" class="md:hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-30 hidden"
                onclick="toggleSidebar()"></div>

            <!-- Top Spacer for Mobile Header -->
            <div class="h-16 md:hidden flex-shrink-0"></div>

            <!-- Scrollable Content Area -->
            <main
                class="flex-1 flex flex-col p-4 md:p-8 relative bg-gradient-to-br from-slate-900 via-[#0A2540] to-black overflow-y-auto h-full">

                <div class="max-w-full lg:max-w-6xl mx-auto w-full flex-shrink-0">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1
                                class="text-xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                                Performance Hub
                            </h1>
                            <p class="text-gray-400 text-sm mt-1">Ready to dominate, <span id="user-display-kb"
                                    class="text-teal">Candidate</span>?</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <a id="admin-btn" href="/admin.html"
                                class="hidden bg-slate-800 hover:bg-slate-700 text-teal-400 border border-teal-800 hover:border-teal-500 px-4 py-2 rounded-lg font-bold text-xs tracking-wider transition-all flex items-center gap-2">
                                <i class="fas fa-shield-cat"></i> ADMIN
                            </a>
                            <button onclick="shuttleToTool('/lab-assistant.html')"
                                class="text-xs font-bold text-purple-400 hover:text-white transition-all bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/50 hover:border-purple-400 px-4 py-2 rounded-lg flex items-center gap-2 shadow-[0_0_10px_rgba(168,85,247,0.2)] hover:shadow-[0_0_15px_rgba(168,85,247,0.4)] mr-2">
                                <i class="fas fa-flask"></i> Lab Assistant
                            </button>
                            <button
                                onclick="document.getElementById('tool-belt-drawer').classList.remove('translate-x-full')"
                                class="text-xs font-bold text-green-400 hover:text-white transition-all bg-green-500/10 hover:bg-green-500/20 border border-green-500/50 hover:border-green-400 px-4 py-2 rounded-lg flex items-center gap-2 shadow-[0_0_10px_rgba(74,222,128,0.2)] hover:shadow-[0_0_15px_rgba(74,222,128,0.4)] mr-2">
                                <i class="fas fa-tools"></i> Tool Belt
                            </button>
                            <button onclick="openUpgradeDrawer()"
                                class="text-xs font-bold text-teal hover:text-white transition-colors bg-teal/10 hover:bg-teal/20 border border-teal/20 hover:border-teal/50 px-4 py-2 rounded-lg flex items-center gap-2">
                                Purchase Options
                            </button>

                            <!-- TOOL BELT DRAWER -->
                            <div id="tool-belt-drawer"
                                class="fixed inset-y-0 right-0 w-[400px] bg-[#0B1121] border-l border-slate-700 shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
                                <div
                                    class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 backdrop-blur-sm">
                                    <div>
                                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                                            <i class="fas fa-tools text-green-400"></i> Tool Belt
                                        </h2>
                                        <p class="text-xs text-slate-400 mt-1">Access your executive arsenal</p>
                                    </div>
                                    <button
                                        onclick="document.getElementById('tool-belt-drawer').classList.add('translate-x-full')"
                                        class="text-slate-400 hover:text-white transition-colors">
                                        <i class="fas fa-times text-lg"></i>
                                    </button>
                                </div>

                                <div class="flex-1 overflow-y-auto p-6 space-y-4 custom-scroll">

                                    <!-- Category: Preparation -->
                                    <div class="space-y-3">
                                        <label
                                            class="text-xs font-bold text-slate-500 uppercase tracking-widest pl-1">Preparation</label>

                                        <a href="/resume-analyzer.html" id="tool-card-scanner" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-blue-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-microscope text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-blue-400 transition-colors">
                                                            Resume Scanner</h3>
                                                        <p class="text-[10px] text-slate-400">Audit vs Job Description
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        <a href="/resume-rewriter.html" id="tool-card-rewrite" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-yellow-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-yellow-500/10 flex items-center justify-center text-yellow-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-pen-nib text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-yellow-400 transition-colors">
                                                            Executive Rewrite</h3>
                                                        <p class="text-[10px] text-slate-400">Targeted Optimization</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        <a href="/cover-letter.html" id="tool-card-cover" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-purple-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-file-alt text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-purple-400 transition-colors">
                                                            Cover Letter</h3>
                                                        <p class="text-[10px] text-slate-400">Draft Narrative</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        <a href="/app.html#linkedin" id="tool-card-linkedin" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-blue-400/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-blue-400/10 flex items-center justify-center text-blue-300 group-hover:scale-110 transition-transform">
                                                        <i class="fab fa-linkedin text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-blue-300 transition-colors">
                                                            LinkedIn Opt.</h3>
                                                        <p class="text-[10px] text-slate-400">Profile Alignment</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </div>

                                    <!-- Category: Interview -->
                                    <div class="space-y-3 pt-2">
                                        <label
                                            class="text-xs font-bold text-slate-500 uppercase tracking-widest pl-1">Interview</label>

                                        <a href="/app.html" id="tool-card-mock" class="block group">
                                            <!-- Verified filename assumption or will fix if 404, usually interview-coach based on previous context -->
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-green-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center text-green-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-microphone-alt text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-green-400 transition-colors">
                                                            Mock Interview</h3>
                                                        <p class="text-[10px] text-slate-400">AI Roleplay Simulation</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        <a href="/star-drill.html" id="tool-card-star" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-orange-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-orange-500/10 flex items-center justify-center text-orange-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-star text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-orange-400 transition-colors">
                                                            STAR Drill</h3>
                                                        <p class="text-[10px] text-slate-400">Behavioral Answer Builder
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        <!-- NEW: The Inquisitor -->
                                        <a href="/strategy/inquisitor.html" id="tool-card-inquisitor"
                                            class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-fuchsia-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-fuchsia-500/10 flex items-center justify-center text-fuchsia-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-user-secret text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-fuchsia-400 transition-colors">
                                                            The Inquisitor</h3>
                                                        <p class="text-[10px] text-slate-400">Reverse Interview</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </div>

                                    <!-- Category: Post-Interview -->
                                    <div class="space-y-3 pt-2">
                                        <label
                                            class="text-xs font-bold text-slate-500 uppercase tracking-widest pl-1">Post-Interview</label>

                                        <!-- NEW: Value Follow-Up -->
                                        <a href="/strategy/follow-up.html" id="tool-card-followup" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-rose-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-rose-500/10 flex items-center justify-center text-rose-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-envelope-open-text text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-rose-400 transition-colors">
                                                            Value Follow-Up</h3>
                                                        <p class="text-[10px] text-slate-400">Post-Interview Strategy
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        <a href="/strategy/closer.html" id="tool-card-closer" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-teal-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-teal-500/10 flex items-center justify-center text-teal-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-hand-holding-usd text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-teal-400 transition-colors">
                                                            The Closer</h3>
                                                        <p class="text-[10px] text-slate-400">Salary Negotiation</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        <!-- NEW: 30-60-90 Plan -->
                                        <a href="/strategy/30-60-90.html" id="tool-card-plan" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-cyan-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-cyan-500/10 flex items-center justify-center text-cyan-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-calendar-alt text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-cyan-400 transition-colors">
                                                            30-60-90 Plan</h3>
                                                        <p class="text-[10px] text-slate-400">Strategic Roadmap</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>

                                        <a href="/strategy-lab.html" id="tool-card-lab" class="block group">
                                            <div
                                                class="bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-indigo-500/50 rounded-xl p-4 transition-all">
                                                <div class="flex items-center gap-4">
                                                    <div
                                                        class="w-10 h-10 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-400 group-hover:scale-110 transition-transform">
                                                        <i class="fas fa-chess-knight text-lg"></i>
                                                    </div>
                                                    <div>
                                                        <h3
                                                            class="text-sm font-bold text-white group-hover:text-indigo-400 transition-colors">
                                                            Strategy Lab</h3>
                                                        <p class="text-[10px] text-slate-400">Analysis & Follow-up</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                </div>

                                <div class="p-6 border-t border-slate-800 bg-slate-900/50 text-center">
                                    <p class="text-[10px] text-slate-500">Select a tool to launch immediately.</p>
                                </div>
                            </div>
                            <div
                                class="flex items-center gap-3 bg-white/5 rounded-full pl-1 pr-3 py-1 border border-white/10">
                                <div
                                    class="w-8 h-8 rounded-full bg-teal/20 flex items-center justify-center text-teal text-xs font-bold border border-teal/30">
                                    <span id="user-initials">--</span>
                                </div>
                                <div class="flex flex-col">
                                    <span id="user-display-header"
                                        class="text-xs font-bold text-white leading-tight">User</span>
                                    <span class="text-[9px] text-slate-400 leading-tight">Plan: <span
                                            id="user-plan-status">Free</span></span>
                                </div>
                                <div class="h-4 w-px bg-white/10 mx-1"></div>
                                <button onclick="signOut()" class="text-slate-400 hover:text-white transition-colors">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 1. Key Metrics Row (6 Columns for Wider Tiles) -->
                    <div
                        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6 mb-6 md:mb-8">

                        <!-- Metric 1: Resume Health -->
                        <a href="/resume-analyzer.html"
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-between relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <!-- ... content ... -->
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest text-center mt-1">
                                Market Relevance
                            </h3>
                            <div class="relative w-24 h-24 mt-auto mb-2">
                                <svg class="w-full h-full" viewBox="0 0 100 100">
                                    <circle class="text-slate-700 stroke-current" stroke-width="8" cx="50" cy="50"
                                        r="40" fill="transparent"></circle>
                                    <circle id="resume-score-ring"
                                        class="text-teal progress-ring__circle stroke-current ring-circle"
                                        stroke-width="8" stroke-linecap="round" cx="50" cy="50" r="40"
                                        fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
                                </svg>
                                <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                                    <span id="resume-score" class="text-2xl font-bold text-white">--</span>
                                </div>
                            </div>
                        </a>

                        <!-- Metric 2: Avg Interview Score (Span 1) -->
                        <a href="interview-history.html"
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-between relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest text-center mt-1">
                                Strategic Fit
                            </h3>
                            <div class="mt-auto mb-2 flex flex-col items-center">
                                <div id="interview-score" class="text-4xl font-bold text-white mb-2">--<span
                                        class="text-gray-500 text-xl">/10</span></div>
                                <div
                                    class="flex items-center text-teal text-xs font-bold bg-teal/10 px-2 py-1 rounded-full">
                                    <span>Active</span>
                                </div>
                            </div>
                        </a>

                        <!-- Metric 3: Strategy Log (Span 1) -->
                        <!-- Metric 3: Strategy Log (Span 1) -->
                        <div onclick="window.location.href='jobs-history.html'"
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-between relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest text-center mt-1">
                                Active Strategy
                            </h3>
                            <div class="mt-auto mb-2 flex flex-col items-center">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-2xl">♟️</span>
                                    <span id="strategy-count" class="text-4xl font-bold text-white">--</span>
                                </div>
                                <span class="text-gray-500 text-xs uppercase tracking-wider">Jobs Tracked</span>
                            </div>
                        </div>

                        <!-- Metric 4: Universal Credits (Span 1) -->
                        <div id="universal-tile"
                            class="glass-card rounded-2xl p-0 flex flex-col items-center justify-center relative group hover:border-teal/30 transition-colors overflow-hidden h-full min-h-[140px]">
                            <!-- Injected by renderUniversalTile() -->
                        </div>

                        <!-- Metric 5: Tool Locker (Span 2 for Width) -->
                        <div id="tool-locker-tile"
                            class="glass-card rounded-2xl p-0 flex flex-col relative group hover:border-teal/30 transition-colors overflow-hidden h-full min-h-[140px] lg:col-span-2">
                            <!-- Injected by renderToolLocker() -->
                        </div>


                    </div>
                </div>

                <!-- KANBAN BOARD (Flex grow to fill rest of screen) -->
                <div
                    class="flex-1 overflow-x-auto overflow-y-hidden custom-scroll w-full pb-6 snap-x snap-mandatory min-h-[400px] md:min-h-[500px] mt-6 md:mt-8">
                    <div class="flex gap-4 h-full px-1">
                        <!-- Targets Column (Wrapped for Button) -->
                        <!-- Engage Column (Consolidated Targets + Applied) -->
                        <!-- Engage Column (Consolidated Targets + Applied) -->
                        <div
                            class="flex-1 flex flex-col min-w-[300px] snap-center bg-slate-900/40 rounded-xl border border-dashed border-slate-700/50">
                            <div
                                class="p-4 border-b border-slate-700/50 flex items-center justify-between sticky top-0 bg-[#0d1b2a]/90 backdrop-blur-sm rounded-t-xl z-10">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-xs font-bold text-slate-400 uppercase">Engage</h3>
                                    <span id="count-engage"
                                        class="bg-slate-800 text-slate-400 text-[10px] font-bold px-2 rounded-full">0</span>
                                </div>
                                <button onclick="openModal()"
                                    class="bg-teal hover:bg-teal/80 text-slate-900 text-[10px] font-black uppercase tracking-wider px-3 py-1 rounded-full shadow-[0_0_12px_rgba(32,201,151,0.4)] hover:shadow-[0_0_20px_rgba(32,201,151,0.6)] flex items-center gap-1.5 transition-all hover:-translate-y-0.5 border border-teal/50">
                                    <i class="fas fa-plus text-[9px]"></i> Add Lead
                                </button>
                                <!-- EMPTY STATE HINT (Hidden by default) -->
                                <div id="add-lead-hint" class="hidden absolute top-12 right-4 z-50 animate-bounce">
                                    <div
                                        class="bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-xl flex items-center gap-2 relative">
                                        <span>Start Here!</span>
                                        <i class="fas fa-arrow-up"></i>
                                        <div class="absolute -top-1 right-8 w-2 h-2 bg-red-600 rotate-45"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="col-engage" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                            </div>
                        </div>
                        <div
                            class="flex-1 flex flex-col min-w-[300px] snap-center bg-purple-900/10 rounded-xl border border-dashed border-purple-900/30">
                            <div
                                class="p-4 border-b border-purple-900/20 flex justify-between sticky top-0 bg-[#0d1b2a]/90 backdrop-blur-sm rounded-t-xl z-10">
                                <h3 class="text-xs font-bold text-purple-400 uppercase">Interviewing</h3>
                                <span id="count-interviewing"
                                    class="bg-purple-900/30 text-purple-300 text-[10px] font-bold px-2 rounded-full">0</span>
                            </div>
                            <div id="col-interviewing" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3"></div>
                        </div>
                        <div
                            class="flex-1 flex flex-col min-w-[300px] snap-center bg-green-900/10 rounded-xl border border-dashed border-green-900/30">
                            <div
                                class="p-4 border-b border-green-900/20 flex justify-between sticky top-0 bg-[#0d1b2a]/90 backdrop-blur-sm rounded-t-xl z-10">
                                <h3 class="text-xs font-bold text-green-400 uppercase">Post Interview</h3>
                                <span id="count-offer"
                                    class="bg-green-900/30 text-green-300 text-[10px] font-bold px-2 rounded-full">0</span>
                            </div>
                            <div id="col-offer" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3"></div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Add Job Modal -->
    <div id="add-modal"
        class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-200 p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-xl shadow-2xl transform scale-95 transition-transform duration-200 max-h-[90vh] overflow-y-auto custom-scroll"
            id="modal-content">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-800/50 rounded-t-xl">
                <h3 class="text-white font-bold font-mono tracking-wide">NEW_TARGET_ACQUISITION</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-job-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Target
                        Company</label>
                    <input type="text" name="company_name" required placeholder="e.g. Acme Corp"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Role
                        Title</label>
                    <input type="text" name="job_title" required placeholder="e.g. Senior Strategist"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Top 5 Mission
                        Priorities</label>
                    <textarea name="job_description" id="focusAreasInput" rows="5"
                        placeholder="Paste the top 5 distinct priorities for this role (e.g., 1. Enterprise Strategy, 2. Cost Reduction...)"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600 resize-none custom-scroll"></textarea>
                </div>
                <div class="pt-4">
                    <button type="submit" id="btn-save"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all">
                        <span>INITIATE CAMPAIGN</span>
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mission Dossier Slide-Over -->
    <div id="mission-dossier"
        class="fixed inset-y-0 right-0 w-full md:w-[800px] bg-slate-900 border-l border-slate-700 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <div class="p-6 border-b border-slate-700 bg-slate-950 flex justify-between items-center">
            <div>
                <h2 class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-1">MISSION DOSSIER</h2>
                <h3 id="dossier-title" class="text-xl font-bold text-white truncate w-80">Job Title</h3>
                <p id="dossier-company" class="text-sm text-slate-400">Company Name</p>
            </div>
            <button onclick="closeDossier()" class="text-slate-500 hover:text-white transition-colors"><i
                    class="fas fa-times text-xl"></i></button>
        </div>

        <!-- Main 3-Column Container -->
        <div class="flex-1 flex overflow-hidden">

            <!-- COL 1: Inputs (Scrollable) -->
            <div class="flex-1 overflow-y-auto p-8 space-y-8 custom-scroll">

                <div class="space-y-3">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-tasks"></i> Current Stage
                    </label>
                    <select id="dossier-status"
                        class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all outline-none">
                        <option value="Engage">Engage</option>
                        <option value="Interviewing">Interviewing</option>
                        <option value="Post Interview">Post Interview</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-user-secret"></i> Interviewer Intel & Notes
                    </label>
                    <textarea id="dossier-notes"
                        class="w-full h-32 bg-slate-800/50 border border-slate-700 rounded-lg p-4 text-sm text-slate-300 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all placeholder-slate-600"
                        placeholder="Example: VP of Ops hates buzzwords. Mention the 'Project Alpha' win. They use Asana for project management..."></textarea>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-file-alt"></i> Role Requirements (JD)
                    </label>
                    <textarea id="dossier-jd"
                        class="w-full h-64 bg-slate-800/50 border border-slate-700 rounded-lg p-4 text-sm text-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all font-mono text-xs leading-relaxed custom-scroll"
                        placeholder="Paste the full Job Description here..."></textarea>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-green-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-money-bill-wave"></i> Salary Target / Offer
                    </label>
                    <input type="text" id="dossier-salary"
                        class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-sm text-slate-300 focus:border-green-500 focus:ring-1 focus:ring-green-500"
                        placeholder="e.g. $150k Base + 20% Bonus">
                </div>

            </div> <!-- End COL 1 Inputs -->

            <!-- COL 2: Toolkit Sidebar (Reduced Width) -->
            <div class="w-48 border-l border-slate-700 bg-slate-900/50 flex flex-col overflow-y-auto custom-scroll">

                <div class="p-4">
                    <label
                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-toolbox"></i> Mission Toolkit
                    </label>

                    <div id="mission-toolkit-grid" class="flex flex-col gap-3">
                        <!-- Buttons injected via JS or Default -->
                        <button onclick="shuttleToTool('/resume-analyzer.html')"
                            class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-500/50 rounded-lg text-left transition-all group">
                            <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                                    class="fas fa-microscope text-blue-500 mr-2"></i>Resume Scanner</div>
                            <div class="text-[10px] text-slate-500">Audit vs JD</div>
                        </button>

                        <button onclick="shuttleToTool('/cover-letter.html')"
                            class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-purple-500/50 rounded-lg text-left transition-all group">
                            <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                                    class="fas fa-file-alt text-purple-500 mr-2"></i>Cover Letter</div>
                            <div class="text-[10px] text-slate-500">Draft Narrative</div>
                        </button>

                        <button onclick="shuttleToTool('app.html#linkedin')"
                            class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-400/50 rounded-lg text-left transition-all group">
                            <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                                    class="fab fa-linkedin text-blue-400 mr-2"></i>LinkedIn Opt.</div>
                            <div class="text-[10px] text-slate-500">Profile Alignment</div>
                        </button>
                    </div>
                </div>

            </div> <!-- End COL 2 Toolkit -->

            <!-- COL 3: Action Rail -->
            <div
                class="w-16 bg-slate-950 border-l border-slate-700 flex flex-col items-center py-6 gap-6 z-10 flex-shrink-0">

                <!-- Primary Actions -->
                <div class="relative">
                    <button id="dossier-save-btn" onclick="handleSaveIntel()" title="Save Changes"
                        class="w-10 h-10 flex items-center justify-center bg-blue-600 hover:bg-blue-500 text-white rounded-xl shadow-lg shadow-blue-900/20 transition-all hover:scale-105">
                        <i class="fas fa-save text-lg"></i>
                    </button>
                    <!-- SAVE HINT -->
                    <div id="save-hint" class="hidden absolute right-12 top-1 z-50 animate-bounce">
                        <div
                            class="bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow-xl flex items-center gap-1.5 relative whitespace-nowrap">
                            <span>Click Save!</span>
                            <i class="fas fa-arrow-right"></i>
                            <div class="absolute top-1/2 -right-1 -translate-y-1/2 w-2 h-2 bg-red-600 rotate-45"></div>
                        </div>
                    </div>
                </div>

                <button id="dossier-refresh-btn" onclick="handleRefreshIntel()" title="Refresh Intel"
                    class="w-10 h-10 flex items-center justify-center bg-purple-600 hover:bg-purple-500 text-white rounded-xl shadow-lg shadow-purple-900/20 transition-all hover:scale-105">
                    <i class="fas fa-sync-alt text-lg"></i>
                </button>

                <div class="w-8 h-px bg-slate-800 my-2"></div>

                <button onclick="closeDossier()" title="Close / Cancel"
                    class="w-10 h-10 flex items-center justify-center text-slate-500 hover:text-white hover:bg-slate-800 rounded-xl transition-all">
                    <i class="fas fa-times text-lg"></i>
                </button>

                <!-- Spacer -->
                <div class="flex-1"></div>

                <!-- Destructive Action -->
                <button onclick="handleJobDelete()" title="Delete Job"
                    class="w-10 h-10 flex items-center justify-center text-red-900/50 hover:text-red-500 hover:bg-red-500/10 rounded-xl transition-all border border-transparent hover:border-red-500/20">
                    <i class="fas fa-trash text-lg"></i>
                </button>

            </div>

        </div> <!-- End Main 3-Column Container -->
    </div> <!-- END MISSION DOSSIER -->

    <script>
        // --- AUTH & DATA VARS ---
        // --- AUTH & DATA VARS ---
        // Token is now retrieved dynamically to prevent 401 Stale Errors
        let currentUser = null;


        // --- UI REFS ---
        const modal = document.getElementById('add-modal');
        const modalContent = document.getElementById('modal-content');
        const cols = {
            'Identified': document.getElementById('col-identified'),
            'Applied': document.getElementById('col-applied'),
            'Interviewing': document.getElementById('col-interviewing'),
            'Offer': document.getElementById('col-offer'),
        };
        const counts = {
            'Engage': document.getElementById('count-engage'),
            'Interviewing': document.getElementById('count-interviewing'),
            'Offer': document.getElementById('count-offer'),
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!getSession()) return; // redirect handled in head

            // 1. Sidebar Init
            initSidebar();

            // 2. Render Upgrade Hub
            if (window.renderUpgradeHub) {
                renderUpgradeHub('upgradeList');
            }

            // 3. Fetch User & Stats
            await loadUserProfile();

            // 4. Fetch Jobs (Kanban)
            loadJobs();
        });

        // --- DOSSIER LOGIC ---
        let currentJobId = null;
        let dossierInitialState = {}; // Tracking for changes
        const dossier = document.getElementById('mission-dossier');

        function checkForDossierChanges() {
            if (!currentJobId) return;
            const hint = document.getElementById('save-hint');
            if (!hint) return;

            const currentState = {
                status: document.getElementById('dossier-status').value,
                notes: document.getElementById('dossier-notes').value,
                jd: document.getElementById('dossier-jd').value,
                salary: document.getElementById('dossier-salary').value
            };

            const hasChanged = JSON.stringify(currentState) !== JSON.stringify(dossierInitialState);

            if (hasChanged) {
                hint.classList.remove('hidden');
            } else {
                hint.classList.add('hidden');
            }
        }

        // Attach listeners to dossier fields
        ['dossier-status', 'dossier-notes', 'dossier-jd', 'dossier-salary'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', checkForDossierChanges);
                el.addEventListener('change', checkForDossierChanges);
            }
        });

        window.openDossier = async (id) => {
            currentJobId = id;
            const job = localJobsInfo.find(j => j.id === id);
            if (!job) return;

            // Populate Fields
            document.getElementById('dossier-title').innerText = job.job_title;
            document.getElementById('dossier-company').innerText = job.company_name;
            document.getElementById('dossier-jd').value = job.job_description || '';
            document.getElementById('dossier-notes').value = job.notes || '';
            document.getElementById('dossier-salary').value = job.salary_target || '';

            // Status Match (Handle variations)
            const statusMap = {
                'identified': 'Engage',
                'engage': 'Engage',
                'applied': 'Engage',
                'interviewing': 'Interviewing',
                'offer': 'Post Interview',
                'post interview': 'Post Interview',
                'closed': 'Closed'
            };
            let currentStatus = (job.status || 'Engage').toLowerCase();
            // Normalize
            if (currentStatus.includes('post') || currentStatus.includes('offer')) currentStatus = 'post interview';
            else if (currentStatus.includes('interview')) currentStatus = 'interviewing';

            document.getElementById('dossier-status').value = statusMap[currentStatus] || 'Engage';

            // Capture Initial State for Change Tracking
            dossierInitialState = {
                status: document.getElementById('dossier-status').value,
                notes: document.getElementById('dossier-notes').value,
                jd: document.getElementById('dossier-jd').value,
                salary: document.getElementById('dossier-salary').value
            };

            const saveHint = document.getElementById('save-hint');
            if (saveHint) saveHint.classList.add('hidden');

            // UPDATE TOOLKIT BUTTONS based on Status
            const toolkitGrid = document.getElementById('mission-toolkit-grid');
            const statusDisplay = statusMap[currentStatus];

            if (statusDisplay === 'Post Interview') {
                toolkitGrid.innerHTML = `
                <button onclick="shuttleToTool('/strategy/closer.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-red-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-bullseye text-red-500 mr-2"></i>The Closer</div>
                    <div class="text-[10px] text-slate-500">Closing Strategy</div>
                </button>
                <button onclick="shuttleToTool('/strategy/inquisitor.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-indigo-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-user-secret text-indigo-500 mr-2"></i>The Inquisitor</div>
                    <div class="text-[10px] text-slate-500">Due Diligence</div>
                </button>

                <button onclick="shuttleToTool('/strategy/follow-up.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-envelope-open-text text-blue-500 mr-2"></i>Value Follow-Up</div>
                    <div class="text-[10px] text-slate-500">Post-Process Logic</div>
                </button>
                `;
            } else if (statusDisplay === 'Interviewing') {
                toolkitGrid.innerHTML = `
                <button onclick="shuttleToTool('/app.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-green-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-microphone-alt text-green-500 mr-2"></i>Mock Interview</div>
                    <div class="text-[10px] text-slate-500">AI Roleplay Simulation</div>
                </button>
                <button onclick="shuttleToTool('/star-drill.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-orange-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-star text-orange-500 mr-2"></i>STAR Drill</div>
                    <div class="text-[10px] text-slate-500">Behavioral Stories</div>
                </button>
                <button onclick="shuttleToTool('/strategy/inquisitor.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-indigo-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-user-secret text-indigo-500 mr-2"></i>The Inquisitor</div>
                    <div class="text-[10px] text-slate-500">Due Diligence</div>
                </button>
                <button onclick="shuttleToTool('/role-reversal.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-pink-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-exchange-alt text-pink-500 mr-2"></i>Reverse Interview</div>
                    <div class="text-[10px] text-slate-500">Ask the Recruiter</div>
                </button>
                <button onclick="shuttleToTool('/strategy/30-60-90.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-cyan-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-road text-cyan-500 mr-2"></i>30-60-90 Plan</div>
                    <div class="text-[10px] text-slate-500">Onboarding Strategy</div>
                </button>
                 `;
            } else {
                // Default (Engage)
                toolkitGrid.innerHTML = `
                <button onclick="shuttleToTool('/resume-analyzer.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-microscope text-blue-500 mr-2"></i>Resume Scanner</div>
                    <div class="text-[10px] text-slate-500">Audit vs JD</div>
                </button>

                <button onclick="shuttleToTool('/resume-rewriter.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-yellow-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-pen-nib text-yellow-500 mr-2"></i>Executive Rewrite</div>
                    <div class="text-[10px] text-slate-500">Targeted Optimization</div>
                </button>

                <button onclick="shuttleToTool('/cover-letter.html')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-purple-500/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fas fa-file-alt text-purple-500 mr-2"></i>Cover Letter</div>
                    <div class="text-[10px] text-slate-500">Draft Narrative</div>
                </button>
                <button onclick="shuttleToTool('app.html#linkedin')"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-400/50 rounded-lg text-left transition-all group">
                    <div class="text-xs font-bold text-slate-300 group-hover:text-white mb-1"><i
                            class="fab fa-linkedin text-blue-400 mr-2"></i>LinkedIn Opt.</div>
                    <div class="text-[10px] text-slate-500">Profile Alignment</div>
                </button>
                `;
            }

            // Slide In
            dossier.classList.remove('translate-x-full');
        };

        window.closeDossier = async () => {
            // Autosave on close
            if (currentJobId) {
                await saveJobChanges(true); // Silent save
            }
            const dossier = document.getElementById('mission-dossier');
            dossier.classList.add('translate-x-full');
            currentJobId = null;
        };

        window.handleSaveIntel = async () => {
            // Explicit save button
            await saveJobChanges(false);
        };

        window.handleRefreshIntel = async () => {
            const jdText = document.getElementById('dossier-jd').value;
            const btn = document.getElementById('dossier-refresh-btn');

            if (!jdText || jdText.length < 50) {
                alert("Please paste the Job Description first.");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spin fa-sync"></i> GENERATING...';
            btn.disabled = true;

            try {
                const session = getSession();
                const response = await fetch('/api/generate-intel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session?.access_token}`
                    },
                    body: JSON.stringify({ job_description: jdText })
                });

                const data = await response.json();
                if (data.intel) {
                    document.getElementById('dossier-notes').value = data.intel;
                    // Not autosaving immediately, user can review then click Save or Close (Autosave)
                }
            } catch (error) {
                console.error("AI Generation failed:", error);
                alert("Could not generate intel.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // --- SAVE & AUTOSAVE LOGIC ---
        // robust save function that handles UI updates and backend sync
        async function saveJobChanges(silent = false) {
            if (!currentJobId) return;
            const btn = document.getElementById('dossier-save-btn');
            const originalText = btn ? btn.innerHTML : ''; // Safe check if button exists

            if (!silent && btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';
            }

            const rawStatus = document.getElementById('dossier-status').value;

            const updates = {
                job_description: document.getElementById('dossier-jd').value,
                notes: document.getElementById('dossier-notes').value,
                salary_target: document.getElementById('dossier-salary').value,
                status: rawStatus
            };

            try {
                const session = getSession();
                const res = await fetch(`/api/jobs/${currentJobId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${session?.access_token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (!res.ok) throw new Error("Save failed");

                // Optimistic Local Update
                const jobIndex = localJobsInfo.findIndex(j => j.id === currentJobId);
                if (jobIndex > -1) {
                    localJobsInfo[jobIndex] = { ...localJobsInfo[jobIndex], ...updates };
                }

                if (!silent && btn) {
                    // Visual feedback only if explicit save
                    btn.innerHTML = '<i class="fas fa-check"></i> SAVED';
                    const hint = document.getElementById('save-hint');
                    if (hint) hint.classList.add('hidden');
                    setTimeout(() => btn.innerHTML = originalText, 1500);

                    // Update initial state to prevent loop
                    dossierInitialState = {
                        status: document.getElementById('dossier-status').value,
                        notes: document.getElementById('dossier-notes').value,
                        jd: document.getElementById('dossier-jd').value,
                        salary: document.getElementById('dossier-salary').value
                    };
                }

                // Refresh Board to Reflect Moves
                loadJobs();

            } catch (e) {
                console.error("Autosave/Save Error:", e);
                if (!silent) alert("Error saving: " + e.message);
            } finally {
                if (!silent && btn && btn.innerHTML.includes('SAVING')) {
                    btn.innerHTML = originalText;
                }
            }
        }

        // Launch Mission replaced by Refresh Intel in Dossier.
        // Keeping this function if called from elsewhere or redirect needed?
        // User requested removing Start Session button, but if we need a tool launcher:
        window.launchToolFromCard = (id) => {
            // Logic to launch tool from card if needed
            window.openDossier(id);
        }

        window.handleJobDelete = async () => {
            if (!currentJobId) return;
            if (!confirm("Are you sure you want to remove this job from your active list?")) return;

            try {
                const session = getSession();
                const res = await fetch(`/api/jobs/${currentJobId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${session?.access_token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'closed' })
                });

                if (!res.ok) throw new Error("Delete failed");

                // alert("Job removed from active list."); // Removed intrusive alert
                document.getElementById('mission-dossier').classList.add('translate-x-full'); // Manually close to skip autosave of deleted job
                currentJobId = null;

                loadJobs(); // Refresh board
            } catch (e) {
                alert("Error: " + e.message);
            }
        };

        // --- JOB LOGIC ---
        async function loadJobs() {
            try {
                const session = getSession();
                const res = await fetch('/api/jobs', {
                    headers: { 'Authorization': `Bearer ${session?.access_token}` }
                });
                if (!res.ok) return; // Silent fail if still syncing
                const jobs = await res.json();
                renderBoard(jobs);
            } catch (e) { console.error(e); }
        }

        function renderBoard(jobs) {
            // Clear Columns
            ['engage', 'interviewing', 'offer'].forEach(id => {
                const col = document.getElementById(`col-${id}`);
                if (col) col.innerHTML = '';
                const count = document.getElementById(`count-${id}`);
                if (count) count.innerText = '0';
            });

            // Update Active Strategy Count
            const activeCount = jobs.filter(j => (j.status || 'identified').toLowerCase() !== 'closed').length;
            const strategyCountEl = document.getElementById('strategy-count');
            if (strategyCountEl) strategyCountEl.innerText = activeCount;

            // --- EMPTY STATE VISUAL HINT ---
            const addBtn = document.querySelector('button[onclick="openModal()"]');
            const hintEl = document.getElementById('add-lead-hint');

            if (addBtn && hintEl) {
                if (activeCount === 0) {
                    // Activate Pulse & Hint
                    addBtn.classList.add('animate-pulse', 'ring-2', 'ring-red-500', 'shadow-[0_0_15px_rgba(239,68,68,0.6)]', 'border-red-500');
                    addBtn.classList.remove('border-teal/50');
                    hintEl.classList.remove('hidden');
                } else {
                    // Normalize
                    addBtn.classList.remove('animate-pulse', 'ring-2', 'ring-red-500', 'shadow-[0_0_15px_rgba(239,68,68,0.6)]', 'border-red-500');
                    addBtn.classList.add('border-teal/50');
                    hintEl.classList.add('hidden');
                }
            }
            // -------------------------------

            // Sort & Render
            // Sort & Render
            jobs.forEach(job => {
                let status = (job.status || 'Engage').toLowerCase();

                // Skip closed jobs
                if (status === 'closed') return;

                // Normalize for UI
                // Backend might send: Engage, Interviewing, Post Interview, Closed
                // Legacy: Identified, Applied, Offer

                if (status.includes('post') || status.includes('offer')) status = 'offer'; // UI Col ID
                else if (status.includes('interview')) status = 'interviewing'; // UI Col ID
                else if (status.includes('appli')) status = 'engage'; // UI Col ID (Badge: Applied)
                else status = 'engage'; // Default UI Col ID

                // Update Count & Column Selection
                // columnKey matches HTML IDs: col-engage, col-interviewing, col-offer
                let columnKey = status;

                const countEl = document.getElementById(`count-${columnKey}`);
                if (countEl) countEl.innerText = parseInt(countEl.innerText) + 1;

                // Create Card
                // FIX: Map backend keys (job_title, company_name) to UI
                const card = `
                <div class="bg-slate-900 border border-slate-800 p-3 rounded mb-3 relative group hover:border-blue-500/30 transition-all cursor-pointer" onclick="window.openDossier('${job.id}')">
                    <h4 class="text-sm font-bold text-white truncate">${job.job_title || job.role || 'New Role'}</h4>
                    <p class="text-xs text-slate-400 truncate">${job.company_name || job.company || 'New Company'}</p>
                    <div class="mt-2 text-[10px] uppercase font-bold tracking-wider ${status === 'applied' ? 'text-blue-400' : 'text-slate-500'}">
                        ${status === 'applied' ? '<i class="fas fa-paper-plane mr-1"></i> APPLIED' : 'TARGET'}
                    </div>
                    <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                         <i class="fas fa-chevron-right text-slate-600"></i>
                    </div>
                </div>`;
                const col = document.getElementById(`col-${columnKey}`);
                if (col) col.insertAdjacentHTML('beforeend', card);
            });

            // Re-store jobs for local access properly
            localJobsInfo = jobs;
        }


        window.launchMission = (id) => {
            const job = localJobsInfo.find(j => j.id === id);
            if (job) smartLaunch(id, '/app.html#interview', job); // Default to Simulator
        };

        window.smartLaunch = (id, url, job) => {
            const context = { job_id: id, role: job.job_title, company: job.company_name, description: job.job_description, jd: job.job_description };
            localStorage.setItem('mission_context', JSON.stringify(context));
            sessionStorage.setItem('missionLaunch', 'true');

            // Construct URL with Query Param: /app.html?id=123#interview
            if (url.includes('#')) {
                const [path, hash] = url.split('#');
                window.location.href = `${path}?id=${id}#${hash}`;
            } else {
                window.location.href = `${url}?id=${id}`;
            }
        };

        // --- MODAL LOGIC ---
        window.openModal = () => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }
        window.closeModal = () => {
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        document.getElementById('add-job-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'SAVING...'; btn.disabled = true;

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.status = 'Identified';

            try {
                const session = getSession();
                const res = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session?.access_token}` },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error("Failed");
                closeModal();
                e.target.reset();
                loadJobs();
            } catch (err) { alert(err.message); }
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        });


        // --- USER & SIDEBAR LOGIC ---
        async function loadUserProfile() {
            try {
                // Get User from Supabase
                const session = getSession();
                const { data: { user } } = await supabase.auth.getUser(session?.access_token);
                if (!user) throw new Error("No user");

                // Get Profile
                const { data: profile } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    // Update UI
                    const initials = profile.name ? profile.name.substring(0, 2).toUpperCase() : 'DK';
                    document.getElementById('user-initials').innerText = initials;
                    document.getElementById('user-display-header').innerText = profile.name || 'User';
                    document.getElementById('user-display-kb').innerText = (profile.name || 'Candidate').split(' ')[0];

                    const isPro = profile.subscription_status === 'active';
                    document.getElementById('user-plan-status').innerText = isPro ? 'PRO' : 'Free';

                    // Admin Check & Session Sync
                    if (profile.role === 'admin') {
                        const adminBtn = document.getElementById('admin-btn');
                        if (adminBtn) adminBtn.classList.remove('hidden');

                        // Sync Session for Gatekeeper
                        try {
                            const sessionStr = localStorage.getItem('aceinterview_session');
                            let session = sessionStr ? JSON.parse(sessionStr) : {};
                            session.role = 'admin';
                            session.email = profile.email || user.email;
                            localStorage.setItem('aceinterview_session', JSON.stringify(session));
                        } catch (e) {
                            console.error("Session Sync Error", e);
                        }
                    }

                    // Plan & Credits Logic (Refactored to Smart Tiles)
                    if (window.renderSmartTiles) {
                        try {
                            renderSmartTiles(profile);
                        } catch (e) {
                            console.error("Smart Tile Error:", e);
                        }
                    }

                    // --- REAL-TIME STATS FETCHING ---

                    // 1. Resume Health (Data-Wired: Check resume_text OR LocalStorage)
                    const localRes = localStorage.getItem('master_resume_text');
                    const resumeExists = (profile.resume_text && profile.resume_text.length > 50) || (localRes && localRes.length > 50);

                    // 1. Resume Health Logic Upgrade
                    let resumeScore = 0;

                    const { data: resumeData } = await supabase
                        .from('resumes')
                        .select('overall_score')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (resumeData && resumeData.length > 0) {
                        resumeScore = resumeData[0].overall_score || 0;
                    } else {
                        // Fallback
                        resumeScore = resumeExists ? 100 : 0;
                    }

                    setRing(resumeScore);
                    document.getElementById('resume-score').textContent = resumeScore;

                    // 2. Avg Interview Score (Data-Wired: Calculate Average)
                    const { data: interviewData } = await supabase
                        .from('interviews')
                        .select('overall_score') // Correct column name
                        .eq('user_id', user.id);

                    if (interviewData && interviewData.length > 0) {
                        const total = interviewData.reduce((acc, curr) => acc + (curr.overall_score || 0), 0);
                        const avg = (total / interviewData.length).toFixed(1);
                        document.getElementById('interview-score').innerHTML = `${avg}<span class="text-gray-500 text-xl">/5</span>`;
                    } else {
                        document.getElementById('interview-score').innerHTML = `0<span class="text-gray-500 text-xl">/5</span>`;
                    }
                }
            } catch (e) {
                console.error("Profile Load Error", e);
            }
        }

        function setRing(score) {
            const circle = document.querySelector('.ring-circle');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (score / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            document.getElementById('resume-score').innerText = score;
        }

        // Sidebar Toggles
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('mobile-overlay');
            sb.classList.toggle('-translate-x-full');
            ov.classList.toggle('hidden');
        }
        function toggleGroup(id) {
            const g = document.getElementById(`group-${id}`);
            const i = document.getElementById(`icon-${id}`);
            g.classList.toggle('hidden');
            i.classList.toggle('rotate-90');
        }
        function initSidebar() {
            const path = window.location.pathname;
            const links = document.querySelectorAll('[data-path]');
            links.forEach(link => {
                if (link.getAttribute('data-path') === path) {
                    link.classList.add('text-teal', 'bg-teal/5');
                    link.classList.remove('text-slate-400');
                    // Open parent
                    const parent = link.closest('.pl-4');
                    if (parent) parent.classList.remove('hidden');
                }
            });
        }

        // --- SMART CONTEXT PASSING ---
        // NEW: Shuttle Logic
        window.shuttleToTool = (url) => {
            // 1. Scrape Data from Dossier Inputs
            let role = document.getElementById('dossier-title').innerText;
            let company = document.getElementById('dossier-company').innerText;
            const jd = document.getElementById('dossier-jd').value;
            const notes = document.getElementById('dossier-notes').value;
            const status = document.getElementById('dossier-status').value;

            // PREVENT DEFAULTS: If user didn't select a job, these will be "Job Title" / "Company Name"
            if (role === 'Job Title') role = '';
            if (company === 'Company Name') company = '';

            if (!jd || jd.length < 50) {
                if (!confirm("Warning: Job Description is empty or short. Tools work best with a full JD. Proceed anyway?")) return;
            }

            // 2. Save Context
            const context = {
                role: role || 'General Strategy', // Fallback to generic
                company: company || 'General Market',
                jd: jd,
                notes: notes,
                status: status,
                job_id: currentJobId, // CRITICAL FIX: Pass ID for persistence
                timestamp: Date.now()
            };
            localStorage.setItem('mission_context', JSON.stringify(context));

            // 3. Launch
            console.log("Shuttling to " + url, context);
            window.location.href = url;
        };

        window.launchTool = (jobId, destinationUrl) => {
            const job = localJobsInfo.find(j => j.id === jobId);
            if (!job) {
                // Fallback if job not found (shouldn't happen)
                window.location.href = destinationUrl;
                return;
            }

            const context = {
                company: job.company_name,
                role: job.job_title,
                jd: job.job_description,
                notes: job.notes
            };

            // Save context for receiver tools to pick up
            localStorage.setItem('mission_context', JSON.stringify(context));

            // User Display Namequested explicit separate storage for Interview Lab
            if (context.jd) {
                localStorage.setItem('activeJobDescription', context.jd);
            }

            // Redirect
            window.location.href = destinationUrl;
        };

        // window.buyCredits is now handled in app.js

        window.signOut = () => {
            localStorage.removeItem(SESSION_KEY);
            window.location.href = '/login.html';
        }

        // INITIALIZATION: Load jobs on page load
        (async function init() {
            await loadJobs();
        })();

    </script>
    <!-- UPGRADE DRAWER (Reusing Drawer Styles) -->
    <div id="upgrade-drawer-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] hidden transition-opacity"
        onclick="closeUpgradeDrawer()"></div>
    <aside id="upgrade-drawer"
        class="fixed inset-y-0 right-0 w-full md:w-[450px] bg-slate-900 border-l border-slate-700 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-[70] flex flex-col">

        <!-- Drawer Header -->
        <div class="p-6 border-b border-slate-700 bg-slate-950 flex justify-between items-center">
            <div>
                <h2 class="text-xs font-bold text-teal uppercase tracking-widest mb-1">PREMIUM
                    ACCESS</h2>
                <h3 class="text-xl font-bold text-white">Upgrade Hub</h3>
            </div>
            <button onclick="closeUpgradeDrawer()" class="text-slate-500 hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Drawer Content -->
        <div class="flex-1 overflow-y-auto p-8 space-y-8 custom-scroll">
            <!-- Target for app.js Injection -->
            <div id="upgradeList" class="space-y-8">
                <!-- Content Injected by renderUpgradeHub() -->
            </div>
        </div>
    </aside>

    <script>
        // --- UPGRADE DRAWER LOGIC ---
        function openUpgradeDrawer() {
            console.log("Purchase Options Clicked");
            // Ensure content is rendered (fix only partial loading race condition)
            try {
                console.log("Checking renderUpgradeHub:", typeof window.renderUpgradeHub);
                if (window.renderUpgradeHub) {
                    renderUpgradeHub('upgradeList');
                } else {
                    console.error("renderUpgradeHub is undefined! App.js loaded?");
                    // Fallback: Manually inject if critical failure (or alert user)
                    document.getElementById('upgradeList').innerHTML = '<div class="text-red-500 p-4">Loading Error. Please refresh.</div>';
                }
            } catch (e) {
                console.error("Error rendering upgrade hub:", e);
            }

            const drawer = document.getElementById('upgrade-drawer');
            const overlay = document.getElementById('upgrade-drawer-overlay');

            if (drawer && overlay) {
                overlay.classList.remove('hidden');
                // Force Reflow
                void drawer.offsetWidth;

                // Simple Class Removal without RAF which might be flaky
                drawer.classList.remove('translate-x-full');

                // Safety: Force z-index high
                drawer.style.zIndex = '9999';
                overlay.style.zIndex = '9998';

                console.log("Drawer classes updated. Classes:", drawer.className);
            } else {
                console.error("Drawer elements missing!");
            }
        }

        function closeUpgradeDrawer() {
            const drawer = document.getElementById('upgrade-drawer');
            const overlay = document.getElementById('upgrade-drawer-overlay');

            drawer.classList.add('translate-x-full');

            // Wait for transition to finish before hiding overlay
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
        }

        // Close on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeUpgradeDrawer();
            }
        });
    </script>
    <!-- MISSION SPECIALIST CHATBOT -->
    <div id="support-container" class="fixed bottom-6 right-6 z-[100]">
        <!-- Bubble -->
        <button id="support-bubble" onclick="toggleSupportChat()"
            class="w-14 h-14 rounded-full bg-teal flex items-center justify-center text-black shadow-2xl hover:scale-110 transition-all duration-300 relative group">
            <i class="fas fa-comment-dots text-xl group-hover:hidden"></i>
            <i class="fas fa-robot text-xl hidden group-hover:block"></i>
            <div
                class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 border-2 border-slate-950 rounded-full animate-pulse">
            </div>
        </button>

        <!-- Window -->
        <div id="support-window"
            class="hidden absolute bottom-0 right-0 w-[350px] max-w-[calc(100vw-40px)] h-[500px] bg-slate-900/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-3xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div
                class="p-4 bg-gradient-to-r from-teal/20 to-transparent border-b border-white/5 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-lg bg-teal/20 flex items-center justify-center text-teal border border-teal/30">
                        <i class="fas fa-shield-cat"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-teal uppercase tracking-widest">Mission Specialist</p>
                        <p class="text-[8px] text-slate-400">System Support Online</p>
                    </div>
                </div>
                <button onclick="toggleSupportChat()" class="text-slate-500 hover:text-white transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <!-- Messages -->
            <div id="support-chat-output" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll scroll-smooth">
                <div id="support-welcome-bubble" class="support-msg-bot p-3 text-xs leading-relaxed text-slate-300">
                    Initializing mission support...
                </div>
            </div>

            <!-- Input -->
            <div class="p-4 bg-black/20 border-t border-white/5">
                <div class="relative flex items-center">
                    <input type="text" id="support-chat-input"
                        class="w-full bg-slate-800/50 border border-slate-700 rounded-xl py-2.5 px-4 pr-10 text-xs text-white focus:outline-none focus:border-teal/50 transition-all"
                        placeholder="Ask a question..." onkeydown="if(event.key === 'Enter') sendSupportMessage()">
                    <button onclick="sendSupportMessage()"
                        class="absolute right-3 text-teal hover:scale-110 transition-transform">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </div>
                <p class="text-[8px] text-slate-600 text-center mt-2">Specialist cannot access personal data for
                    security.</p>
            </div>
        </div>
    </div>

    <script>
        let isSupportInit = false;

        async function toggleSupportChat() {
            const win = document.getElementById('support-window');
            const bubble = document.getElementById('support-bubble');
            const isHidden = win.classList.contains('hidden');

            if (isHidden) {
                win.classList.remove('hidden');
                bubble.classList.add('scale-0', 'opacity-0');

                // Fetch welcome message on first open
                if (!isSupportInit) {
                    try {
                        const res = await fetch('/api/admin/config?key=support_bot_welcome');
                        const data = await res.json();
                        const welcome = data.value || "Welcome to AceInterview. How can I help you today?";
                        const bubbleEl = document.getElementById('support-welcome-bubble');
                        bubbleEl.innerHTML = welcome.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                        isSupportInit = true;
                    } catch (err) {
                        document.getElementById('support-welcome-bubble').textContent = "Specialist online. Ready for mission instructions.";
                    }
                }

                // Auto-focus input
                setTimeout(() => document.getElementById('support-chat-input').focus(), 400);
            } else {
                win.classList.add('hidden');
                bubble.classList.remove('scale-0', 'opacity-0');
            }
        }

        async function sendSupportMessage() {
            const input = document.getElementById('support-chat-input');
            const output = document.getElementById('support-chat-output');
            const msg = input.value.trim();
            if (!msg) return;

            // 1. Render User Msg
            const userDiv = document.createElement('div');
            userDiv.className = 'support-msg-user p-3 text-xs leading-relaxed ml-8';
            userDiv.textContent = msg;
            output.appendChild(userDiv);
            input.value = '';
            output.scrollTop = output.scrollHeight;

            // 2. Loading State
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'support-msg-bot p-3 text-[10px] italic text-slate-500 mr-8 animate-pulse';
            loadingDiv.textContent = 'Specialist is typing...';
            output.appendChild(loadingDiv);
            output.scrollTop = output.scrollHeight;

            try {
                const res = await fetch('/api/support/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();

                loadingDiv.remove();

                const botDiv = document.createElement('div');
                botDiv.className = 'support-msg-bot p-3 text-xs leading-relaxed text-slate-300 mr-8';
                // Simple markdown-style bold support
                botDiv.innerHTML = (data.answer || "Connection lost. Please try again.").replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                output.appendChild(botDiv);
                output.scrollTop = output.scrollHeight;

            } catch (err) {
                loadingDiv.textContent = 'Specialist offline. Please try again.';
                loadingDiv.classList.remove('animate-pulse');
                loadingDiv.classList.add('text-red-400');
            }
        }

        // --- Keep Existing Upgrade Drawer Logic ---
        function openUpgradeDrawer() {
            document.getElementById('upgrade-drawer').classList.remove('translate-x-full');
            document.getElementById('upgrade-drawer-overlay').classList.remove('hidden');
        }

        function closeUpgradeDrawer() {
            const drawer = document.getElementById('upgrade-drawer');
            const overlay = document.getElementById('upgrade-drawer-overlay');
            drawer.classList.add('translate-x-full');
            setTimeout(() => { overlay.classList.add('hidden'); }, 300);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeUpgradeDrawer();
            }
        });
    </script>
</body>

</html>