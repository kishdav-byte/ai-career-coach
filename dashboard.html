<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Hub - AceInterview</title>
    <!-- Tailwind CSS (via CDN for immediate utility usage as requested) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: '#0A2540',
                        teal: '#20C997',
                        slate: {
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Auth Logic Pre-check
        const SESSION_KEY = 'supabase.auth.token';
        const token = localStorage.getItem(SESSION_KEY);
        if (!token) {
            window.location.href = '/login.html';
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            /* Fallback */
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-card:hover {
            border-color: rgba(32, 201, 151, 0.3);
        }

        /* Custom Ring for Resume Health */
        .ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>


<body class="bg-gray-50 text-white font-sans selection:bg-teal selection:text-black overflow-hidden h-screen">

    <div class="flex h-screen bg-slate-950">

        <!-- MOBILE HEADER (Visible < lg) -->
        <div
            class="lg:hidden fixed top-0 left-0 w-full h-16 bg-slate-900 border-b border-white/5 flex items-center justify-between px-4 z-50">
            <div class="font-bold text-lg tracking-tight text-white">AceInterview</div>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="4" y1="12" x2="20" y2="12" />
                    <line x1="4" y1="6" x2="20" y2="6" />
                    <line x1="4" y1="18" x2="20" y2="18" />
                </svg>
            </button>
        </div>

        <!-- SIDEBAR (Fixed Left) -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 w-[250px] bg-slate-900 border-r border-white/5 flex flex-col transition-transform duration-300 ease-in-out z-40 -translate-x-full lg:translate-x-0 lg:static">

            <!-- Logo Area -->
            <div class="h-20 flex items-center px-8 mt-4 lg:mt-0">
                <h1
                    class="font-bold text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                    AceInterview
                </h1>
            </div>

            <!-- Navigation Stack -->
            <nav class="flex-1 px-4 space-y-2 mt-4 overflow-y-auto custom-scroll" id="nav-accordion">
                <!-- Dashboard -->
                <a href="/dashboard.html"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-all relative group text-slate-400 hover:text-white hover:bg-white/5"
                    data-path="/dashboard.html">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="7" height="9" x="3" y="3" rx="1" />
                        <rect width="7" height="5" x="14" y="3" rx="1" />
                        <rect width="7" height="9" x="14" y="12" rx="1" />
                        <rect width="7" height="5" x="3" y="16" rx="1" />
                    </svg>
                    <span>Dashboard</span>
                </a>

                <!-- The Clinic Category -->
                <div class="nav-group">
                    <button onclick="toggleGroup('clinic')"
                        class="w-full flex items-center justify-between px-4 py-3 text-sm font-bold text-white rounded-lg hover:bg-white/5 transition-colors group">
                        <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="text-slate-500 group-hover:text-white">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                <polyline points="14 2 14 8 20 8" />
                                <path d="M16 13H8" />
                                <path d="M16 17H8" />
                                <path d="M10 9H8" />
                            </svg>
                            <span>The Clinic</span>
                        </div>
                        <svg id="icon-clinic" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="text-slate-500 transform transition-transform duration-200">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                    <div id="group-clinic" class="hidden pl-4 space-y-1 mt-1 border-l border-white/5 ml-4">
                        <a href="/resume-analyzer.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/resume-analyzer.html">Resume Scanner</a>
                        <a href="/resume-rewriter.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/resume-rewriter.html">Executive Rewrite</a>
                        <a href="/app.html#linkedin"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/app.html#linkedin">LinkedIn Optimizer</a>
                    </div>
                </div>

                <!-- The Simulator Category -->
                <div class="nav-group">
                    <button onclick="toggleGroup('simulator')"
                        class="w-full flex items-center justify-between px-4 py-3 text-sm font-bold text-white rounded-lg hover:bg-white/5 transition-colors group">
                        <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="text-slate-500 group-hover:text-white">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                <line x1="12" x2="12" y1="19" y2="22" />
                            </svg>
                            <span>The Simulator</span>
                        </div>
                        <svg id="icon-simulator" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="text-slate-500 transform transition-transform duration-200">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                    <div id="group-simulator" class="hidden pl-4 space-y-1 mt-1 border-l border-white/5 ml-4">
                        <a href="/app.html#interview"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/app.html#interview">Mock Interview</a>
                        <a href="/role-reversal.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/role-reversal.html">Role Reversal</a>
                        <a href="/role-reversal.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/role-reversal.html">STAR Drill</a>
                    </div>
                </div>

                <!-- Strategy Category -->
                <div class="nav-group">
                    <button onclick="toggleGroup('strategy')"
                        class="w-full flex items-center justify-between px-4 py-3 text-sm font-bold text-white rounded-lg hover:bg-white/5 transition-colors group">
                        <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="text-slate-500 group-hover:text-white">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="22" y1="12" x2="18" y2="12" />
                                <line x1="6" y1="12" x2="2" y2="12" />
                                <line x1="12" y1="6" x2="12" y2="2" />
                                <line x1="12" y1="22" x2="12" y2="18" />
                            </svg>
                            <span>Strategy</span>
                        </div>
                        <svg id="icon-strategy" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round"
                            class="text-slate-500 transform transition-transform duration-200">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                    <div id="group-strategy" class="hidden pl-4 space-y-1 mt-1 border-l border-white/5 ml-4">
                        <a href="/strategy/strategy-log.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/strategy/strategy-log.html">Job Tracker</a>
                        <a href="/strategy/30-60-90.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/strategy/30-60-90.html">30-60-90 Plan</a>
                        <a href="/strategy/closer.html"
                            class="nav-sub-item block px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-white/5 rounded-md transition-all relative"
                            data-path="/strategy/closer.html">Salary Negotiation</a>
                    </div>
                </div>
            </nav>

            <script>
                function toggleGroup(id) {
                    const group = document.getElementById('group-' + id);
                    const icon = document.getElementById('icon-' + id);

                    if (group.classList.contains('hidden')) {
                        group.classList.remove('hidden');
                        icon.style.transform = 'rotate(90deg)';
                    } else {
                        group.classList.add('hidden');
                        icon.style.transform = 'rotate(0deg)';
                    }
                }

                function initSidebar() {
                    const path = window.location.pathname;
                    const hash = window.location.hash;
                    const fullPath = path + hash;

                    // 1. Highlight Active Link
                    const links = document.querySelectorAll('.nav-sub-item, .nav-item');
                    links.forEach(link => {
                        const linkPath = link.getAttribute('data-path');
                        // Simple match or startsWith for deeper
                        if (fullPath.includes(linkPath) || (linkPath === '/dashboard.html' && path === '/dashboard.html')) {
                            // Active Style
                            link.classList.remove('text-slate-400');
                            link.classList.add('text-[#20C997]', 'bg-[#20C997]/5');

                            // Add indicator
                            const indicator = document.createElement('div');
                            indicator.className = 'absolute -left-[9px] top-1/2 -translate-y-1/2 w-1 h-4 bg-[#20C997] rounded-full shadow-[0_0_8px_#20C997]';
                            link.appendChild(indicator);

                            // Expand Parent Group
                            const parentGroup = link.closest('.nav-group');
                            if (parentGroup) {
                                // Find the button inside to trigger toggle or manually toggle
                                const btn = parentGroup.querySelector('button');
                                const onclickAttr = btn.getAttribute('onclick');
                                const groupIdMatch = onclickAttr.match(/toggleGroup\('(.+)'\)/);
                                if (groupIdMatch) {
                                    toggleGroup(groupIdMatch[1]);
                                }
                            }
                        }
                    });
                }

                document.addEventListener('DOMContentLoaded', initSidebar);
            </script>

            <!-- Footer / User Profile -->
            <div class="p-4 border-t border-white/5">
                <div
                    class="flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors cursor-pointer group">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-teal/20 flex items-center justify-center text-teal text-xs font-bold border border-teal/30">
                            <span id="user-initials">DK</span>
                        </div>
                        <div class="flex flex-col">
                            <span id="user-display-sidebar"
                                class="text-sm font-medium text-white group-hover:text-teal transition-colors">User</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-wider">Free Plan</span>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-500 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" x2="9" y1="12" y2="12" />
                        </svg>
                    </button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT WRAPPER -->
        <div class="flex-1 flex flex-col min-w-0 lg:ml-0 overflow-hidden relative">

            <!-- Mobile Overlay -->
            <div id="mobile-overlay" class="lg:hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-30 hidden"
                onclick="toggleSidebar()"></div>

            <!-- Top Spacer for Mobile Header -->
            <div class="h-16 lg:hidden flex-shrink-0"></div>

            <!-- Scrollable Content Area -->
            <main
                class="flex-1 overflow-y-auto p-4 lg:p-8 relative bg-gradient-to-br from-slate-900 via-[#0A2540] to-black">

                <div class="max-w-7xl mx-auto">
                    <!-- Original Header Content (Title) moved here as Page Title -->
                    <div class="flex justify-between items-center mb-10">
                        <div>
                            <h1
                                class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                                Executive Performance Hub
                            </h1>
                            <p class="text-gray-400 text-sm mt-1">Ready to dominate, <span id="user-display-kb"
                                    class="text-teal">Candidate</span>?</p>
                        </div>
                        <!-- Could add top-right actions here if needed, but nav is now in sidebar -->
                    </div>

                    <!-- Main Grid Content (From previous step) -->

                    <!-- 1. Key Metrics Row (4 Columns) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                        <!-- Metric 1: Resume Health -->
                        <a href="/resume-analyzer.html"
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Resume Health
                            </h3>

                            <!-- Ring Visualization -->
                            <div class="relative w-24 h-24">
                                <svg class="w-full h-full" viewBox="0 0 100 100">
                                    <circle class="text-slate-700 stroke-current" stroke-width="8" cx="50" cy="50"
                                        r="40" fill="transparent"></circle>
                                    <circle id="resume-score-ring"
                                        class="text-teal progress-ring__circle stroke-current ring-circle"
                                        stroke-width="8" stroke-linecap="round" cx="50" cy="50" r="40"
                                        fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
                                    <!-- Dynamic -->
                                </svg>
                                <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                                    <span id="resume-score" class="text-2xl font-bold text-white">--</span>
                                </div>
                            </div>
                        </a>

                        <!-- Metric 2: Avg Interview Score (Dynamic Placeholder) -->
                        <a href="/role-reversal.html"
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Avg. Interview
                                Score</h3>
                            <div id="interview-score" class="text-4xl font-bold text-white mb-2">--<span
                                    class="text-gray-500 text-xl">/10</span>
                            </div>
                            <div
                                class="flex items-center text-teal text-xs font-bold bg-teal/10 px-2 py-1 rounded-full">
                                <span>--</span>
                                <span class="ml-1 opacity-70">Last 30 days</span>
                            </div>
                        </a>

                        <!-- Metric 3: Strategy Log -->
                        <a href="/strategy/strategy-log.html"
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center relative group transition-all hover:-translate-y-1 cursor-pointer">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20 group-hover:bg-teal transition-all">
                            </div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Active Strategy
                            </h3>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-2xl">♟️</span>
                                <span id="strategy-count" class="text-4xl font-bold text-white">--</span>
                            </div>
                            <span class="text-gray-500 text-xs uppercase tracking-wider">Jobs Tracked</span>
                        </a>

                        <!-- Metric 4: Credits -->
                        <div
                            class="glass-card rounded-2xl p-6 flex flex-col items-center justify-center relative group hover:border-teal/30 transition-colors">
                            <div class="absolute top-0 left-0 w-full h-1 bg-teal/20"></div>
                            <h3 id="plan-name" class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">
                                Plan</h3>
                            <!-- Progress Bar -->
                            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden mb-3">
                                <div id="credit-bar" class="bg-teal h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between w-full text-xs">
                                <span id="credit-count" class="text-white font-bold">-- Credits</span>
                                <span class="text-gray-500">Left</span>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Main Content Area (2:1 Ratio) -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Left Column: Trend (Span 2) -->
                        <div class="lg:col-span-2 glass-card rounded-2xl p-6 min-h-[300px] flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-bold text-white">Performance History</h3>
                                <div class="flex gap-2">
                                    <span class="text-xs text-teal bg-teal/10 px-2 py-1 rounded">Interviews</span>
                                    <span
                                        class="text-xs text-gray-500 hover:text-white cursor-pointer px-2 py-1">Resume</span>
                                </div>
                            </div>

                            <!-- Chart Placeholder (Pure CSS) -->
                            <div
                                class="flex-grow flex items-end justify-between gap-4 px-4 pb-2 border-b border-white/5 relative">
                                <!-- Y-Axis Grid Lines -->
                                <div
                                    class="absolute inset-0 flex flex-col justify-between pointer-events-none opacity-20">
                                    <div class="border-t border-dashed border-gray-400 w-full h-0"></div>
                                    <div class="border-t border-dashed border-gray-400 w-full h-0"></div>
                                    <div class="border-t border-dashed border-gray-400 w-full h-0"></div>
                                    <div class="border-t border-dashed border-gray-400 w-full h-0"></div>
                                </div>

                                <!-- Bars -->
                                <div
                                    class="w-full bg-gradient-to-t from-teal/10 to-teal/40 hover:to-teal/60 rounded-t-sm transition-all h-[40%] relative group cursor-pointer">
                                    <div
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                        4/10</div>
                                </div>
                                <div
                                    class="w-full bg-gradient-to-t from-teal/10 to-teal/40 hover:to-teal/60 rounded-t-sm transition-all h-[55%] relative group cursor-pointer">
                                    <div
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                        5.5/10</div>
                                </div>
                                <div
                                    class="w-full bg-gradient-to-t from-teal/10 to-teal/40 hover:to-teal/60 rounded-t-sm transition-all h-[50%] relative group cursor-pointer">
                                    <div
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                        5/10</div>
                                </div>
                                <div
                                    class="w-full bg-gradient-to-t from-teal/10 to-teal/40 hover:to-teal/60 rounded-t-sm transition-all h-[70%] relative group cursor-pointer">
                                    <div
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                        7/10</div>
                                </div>
                                <div
                                    class="w-full bg-gradient-to-t from-teal/10 to-teal/40 hover:to-teal/60 rounded-t-sm transition-all h-[65%] relative group cursor-pointer">
                                    <div
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                        6.5/10</div>
                                </div>
                                <div
                                    class="w-full bg-gradient-to-t from-teal/10 to-teal/40 hover:to-teal/60 rounded-t-sm transition-all h-[80%] relative group cursor-pointer">
                                    <div
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                        8/10</div>
                                </div>
                                <div
                                    class="w-full bg-gradient-to-t from-teal/10 to-teal/40 hover:to-teal/60 rounded-t-sm transition-all h-[75%] relative group cursor-pointer">
                                    <div
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                        7.5/10</div>
                                </div>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-gray-500 uppercase tracking-widest">
                                <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                            </div>
                        </div>

                        <!-- Right Column: Action Center -->
                        <div class="glass-card rounded-2xl p-6 flex flex-col">
                            <h3 class="text-lg font-bold text-white mb-6">Recommended Actions</h3>

                            <div class="flex-grow space-y-4">
                                <!-- Action 1 -->
                                <a href="/resume-analyzer.html"
                                    class="block p-4 bg-white/5 rounded-xl border border-white/5 hover:border-teal/50 hover:bg-white/10 transition-all cursor-pointer group">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-semibold text-white group-hover:text-teal text-sm">Optimize
                                            Resume</h4>
                                        <span
                                            class="text-[10px] bg-teal text-black font-bold px-1.5 py-0.5 rounded uppercase">High
                                            Impact</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-2">Your 'Experience' section needs active verbs.
                                        Fix it
                                        now.</p>
                                </a>

                                <!-- Action 2 -->
                                <a href="/role-reversal.html"
                                    class="block p-4 bg-white/5 rounded-xl border border-white/5 hover:border-teal/50 hover:bg-white/10 transition-all cursor-pointer group">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-semibold text-white group-hover:text-teal text-sm">Mock
                                            Interview</h4>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-2">Practice "Tell me about yourself" to boost
                                        confidence.
                                    </p>
                                </a>
                            </div>

                            <a href="/resume-analyzer.html"
                                class="w-full mt-6 py-3 bg-teal text-black font-bold text-sm rounded-xl hover:bg-[#1aa179] transition-colors text-center block">
                                Start New Session
                            </a>
                        </div>
                    </div>

                    <!-- 3. Bottom Section: Recent Activity -->
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-white">Recent Activity</h3>
                            <button class="text-xs text-teal hover:text-white transition-colors">View All</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="text-gray-500 text-xs uppercase tracking-wider border-b border-white/5">
                                        <th class="pb-3 font-medium pl-2">Project Name</th>
                                        <th class="pb-3 font-medium">Type</th>
                                        <th class="pb-3 font-medium">Score</th>
                                        <th class="pb-3 font-medium">Date</th>
                                        <th class="pb-3 font-medium">Status</th>
                                        <th class="pb-3 font-medium text-right pr-2">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-activity-table" class="divide-y divide-white/5 text-sm">
                                    <!-- Dynamic Content -->
                                    <tr>
                                        <td colspan="6" class="py-10 text-center text-gray-500">Loading activity...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div> <!-- End Max-W-7xl -->
            </main>
        </div>
    </div>

    <!-- Hidden Drop Zone -->
    <div id="resume-drop-zone" style="display:none;">
        <input type="file" id="resume-file-input" accept=".pdf,.txt,.docx" style="display: none;">
        <div class="cleaning-loader" id="parsing-loader" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing...</p>
        </div>
        <div class="drop-content"></div>
    </div>

    <script>
        // PDF Parsing Logic (Retained from original)
        const dropZone = document.getElementById('resume-drop-zone');
        const fileInput = document.getElementById('resume-file-input');
        const parsingLoader = document.getElementById('parsing-loader');
        const dropContent = document.querySelector('.drop-content'); // This might need adjustment if .drop-content is not directly under drop-zone

        // Handle Click (only if dropZone is visible, which it isn't now)
        if (dropZone) {
            dropZone.addEventListener('click', () => fileInput.click());

            // Handle Drag & Drop (only if dropZone is visible)
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--success)';
                dropZone.style.backgroundColor = 'rgba(32, 201, 151, 0.05)';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#0A2540';
                dropZone.style.backgroundColor = '#fff';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#0A2540';
                dropZone.style.backgroundColor = '#fff';

                const files = e.dataTransfer.files;
                if (files.length) handleFile(files[0]);
            });
        }

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            console.log("File detected:", file.name);
            if (dropContent) dropContent.style.display = 'none';
            if (parsingLoader) parsingLoader.style.display = 'flex';

            try {
                let text = "";
                if (file.type === "application/pdf") {
                    text = await parsePdf(file);
                } else {
                    // Assume text
                    text = await file.text();
                }

                if (text && text.length > 50) {
                    console.log("Text extracted via Dashboard. Redirecting to App...");
                    // Store for App to pickup
                    localStorage.setItem('pending_resume_text', text);
                    localStorage.setItem('pending_resume_filename', file.name);

                    // Redirect
                    window.location.href = '/resume-analyzer.html';
                } else {
                    console.error("Text length: " + (text ? text.length : 0));
                    throw new Error("Could not extract meaningful text (len < 50).");
                }

            } catch (err) {
                console.error("Parsing Error:", err);
                alert("Could not read this file. Please try a standard text-based PDF or TXT file.");
                if (dropContent) dropContent.style.display = 'block';
                if (parsingLoader) parsingLoader.style.display = 'none';
            }
        }

        // Initialize PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function parsePdf(file) {
            // Basic PDF.js implementation
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(s => s.str).join(' ');
                fullText += pageText + "\n";
            }
            return fullText;
        }


        // Main Dashboard Logic (Adapted from original)
        const APP_SESSION_KEY = 'aceinterview_session';
        const SESSION_EXPIRY_DAYS = 7;

        function getSession() {
            const sessionStr = localStorage.getItem(APP_SESSION_KEY);
            if (!sessionStr) return null;

            try {
                const session = JSON.parse(sessionStr);

                // FIX: If logged_in_at is missing, assume it is valid (Date.now()) to prevent auto-expiry
                const loggedInAt = session.logged_in_at || Date.now();
                const now = Date.now();
                const expiryMs = SESSION_EXPIRY_DAYS * 24 * 60 * 60 * 1000;

                if (now - loggedInAt > expiryMs) {
                    console.warn("Session expired. Logging out.");
                    localStorage.removeItem(APP_SESSION_KEY);
                    return null;
                }

                return session;
            } catch (e) {
                return null;
            }
        }

        function logout() {
            localStorage.removeItem(APP_SESSION_KEY);
            // Also remove auth tokens
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('supabase.auth.refresh_token');
            if (window.supabase) supabase.auth.signOut();
            window.location.href = '/?logout=success';
        }

        // SUPABASE INIT
        const SUPABASE_URL = 'https://nvfjmqacxzlmfamiynuu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZmptcWFjeHpsbWZhbWl5bnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzk3MzAsImV4cCI6MjA4MDcxNTczMH0.W3J-E2ldrc99btVeChF0SauTQxr_48uFwImVaoHfOXI';

        let supabase = null;
        if (typeof createClient !== 'undefined') { // Check if CDN loaded
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            // Fallback if CDN fails or strict CSP
            console.error("Supabase CDN not loaded.");
            // Try to use window.supabase if available globally from some other import (unlikely here)
        }

        // Wait for Supabase to define if script async
        document.addEventListener('DOMContentLoaded', async () => {
            if (!supabase && window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        });


        async function fetchDashboardData(userEmail) {
            console.log("Fetching dashboard data for:", userEmail);
            if (!supabase) return;

            try {
                // 0. AUTH RESTORATION
                // The new client doesn't automatically pick up the token from localStorage
                // We must set it manually if it exists.
                const token = localStorage.getItem('supabase.auth.token');
                if (token) {
                    // Attempt to set session. Note: This expects 'access_token' and optional 'refresh_token'.
                    // Our legacy code stored just the token string or a JSON? 
                    // Let's check how it was stored. Based on previous code: localStorage.setItem('supabase.auth.token', session.access_token);
                    // If it's just the token string:
                    const { data, error } = await supabase.auth.setSession({
                        access_token: token,
                        refresh_token: localStorage.getItem('supabase.auth.refresh_token') || ''
                    });

                    if (error) {
                        console.warn("Session restore failed:", error.message);
                        // If fail, maybe redirect or clear?
                    }
                }

                // 1. Get User
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) {
                    console.log("No authenticated user found even after token check.");
                    return;
                }

                console.log("Authenticated as:", user.id);

                // 2. Get Resume Score (Latest)
                const { data: resumes } = await supabase.from('resumes')
                    .select('overall_score')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                const resumeScore = resumes?.[0]?.overall_score || 0;
                document.getElementById('resume-score').textContent = resumeScore;

                // Update Ring
                const circle = document.getElementById('resume-score-ring');
                const radius = circle.r.baseVal.value;
                const circumference = radius * 2 * Math.PI;
                const offset = circumference - (resumeScore / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                circle.style.stroke = resumeScore > 75 ? '#20C997' : (resumeScore > 50 ? '#fbbf24' : '#ef4444');


                // 3. Get Strategy Count (Active Jobs)
                const { count: jobCount } = await supabase.from('user_jobs')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', user.id);

                console.log("Jobs found:", jobCount);
                document.getElementById('strategy-count').textContent = jobCount || 0;


                // 4. Get Plan Details & Credits
                const { data: profile } = await supabase.from('profiles')
                    .select('plan_tier, credits_remaining')
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    document.getElementById('plan-name').textContent = profile.plan_tier || 'Free Plan';
                    document.getElementById('credit-count').textContent = `${profile.credits_remaining} Credits`;
                    // Assume 100 is max credits for visual bar
                    const pct = Math.min((profile.credits_remaining || 0), 100);
                    document.getElementById('credit-bar').style.width = `${pct}%`;
                }

                // 5. Get Interview Avg (Last 30 days)
                const pastDate = new Date();
                pastDate.setDate(pastDate.getDate() - 30);

                const { data: interviews } = await supabase.from('interviews')
                    .select('overall_score')
                    .eq('user_id', user.id)
                    .gte('created_at', pastDate.toISOString());

                const avgScore = interviews && interviews.length
                    ? (interviews.reduce((a, b) => a + b.overall_score, 0) / interviews.length).toFixed(1)
                    : 0;

                document.getElementById('interview-score').innerHTML = `${avgScore}<span class="text-gray-500 text-xl">/10</span>`;


                // 6. Recent Activity
                const { data: activity } = await supabase.from('user_recent_activity')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(5);

                const tableBody = document.getElementById('recent-activity-table');
                if (activity && activity.length > 0) {
                    tableBody.innerHTML = activity.map(a => `
                         <tr class="group hover:bg-white/5 transition-colors">
                            <td class="py-4 pl-2 font-medium text-white">${a.project_name || 'Untitled'}</td>
                            <td class="py-4 text-gray-400">${a.type}</td>
                            <td class="py-4 text-white font-bold">${a.score || '-'}</td>
                            <td class="py-4 text-gray-500">${timeAgo(a.created_at)}</td>
                            <td class="py-4">
                                <span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-teal/20 text-teal">${a.status || 'Done'}</span>
                            </td>
                            <td class="py-4 text-right pr-2">
                                <button class="text-gray-400 hover:text-white">•••</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="py-10 text-center text-gray-500">No activity found.</td></tr>';
                }

            } catch (err) {
                console.error("Error fetching dashboard data:", err);
            }
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `\${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `\${Math.floor(diffInSeconds / 3600)}h ago`;
            return `\${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        async function initDashboard() {
            // 1. Try to get the session normally
            let session = getSession();

            // 2. RECOVERY: If session is missing but Token exists, rebuild it!
            if (!session) {
                const token = localStorage.getItem('supabase.auth.token');
                if (token) {
                    try {
                        const parts = token.split('.');
                        if (parts.length === 3) {
                            const base64Url = parts[1];
                            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                            const payloadStr = atob(base64);
                            const payload = JSON.parse(payloadStr);

                            if (payload.email) {
                                session = {
                                    email: payload.email,
                                    name: payload.user_metadata?.name || 'User',
                                    logged_in_at: Date.now(),
                                    account_status: 'active',
                                    resume_credits: 3,
                                    interview_credits: 3
                                };
                                localStorage.setItem(APP_SESSION_KEY, JSON.stringify(session));
                            }
                        }
                    } catch (e) {
                        console.error("Session Recovery Error:", e.message);
                    }
                }
            }

            // 3. Final Check
            if (!session) {
                // Critical: Clear artifacts to prevent Login Redirect Loop
                localStorage.removeItem(APP_SESSION_KEY);
                localStorage.removeItem('supabase.auth.token');
                window.location.href = '/login.html';
                return;
            }
            // Display user info
            const displayName = session.name || session.email;
            const shortName = displayName.split('@')[0].split(' ')[0]; // Extract first name or part before @

            // Update New Sidebar & Header Elements
            if (document.getElementById('user-display-sidebar')) document.getElementById('user-display-sidebar').textContent = shortName;
            if (document.getElementById('user-display-kb')) document.getElementById('user-display-kb').textContent = shortName;

            // Initials
            const initials = shortName.substring(0, 2).toUpperCase();
            if (document.getElementById('user-initials')) document.getElementById('user-initials').textContent = initials;

            // Check for payment success URL param
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('payment') === 'success') {
                // Just clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Show Dashboard
            const loading = document.getElementById('loading');
            const content = document.getElementById('dashboard-content');
            if (loading) loading.style.display = 'none';
            if (content) content.style.display = 'block';
        }

        // Initialize on load
        initDashboard().then(() => {
            // Fetch real data after generic init
            // Recover user from session
            const session = getSession();
            if (session) {
                fetchDashboardData(session.email);
            }
        });
    </script>
</body>

</html>