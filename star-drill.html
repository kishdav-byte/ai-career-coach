<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAR Drill - Strategy Lab</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: auto;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s forwards;
        }

        .star-card {
            transition: all 0.3s ease;
        }

        .star-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>

<body
    class="flex flex-col md:flex-row min-h-screen md:h-screen bg-slate-950 text-slate-300 overflow-y-auto md:overflow-hidden">

    <!-- LEFT PANEL: INPUT (40%) -->
    <aside
        class="w-full md:w-[40%] h-auto md:h-full flex flex-col relative z-20 border-b md:border-b-0 md:border-r border-slate-800 bg-slate-900/50 backdrop-blur-sm shadow-[10px_0_30px_-5px_rgba(0,0,0,0.5)] order-1">

        <!-- Header -->
        <div class="p-6 md:p-8 border-b border-slate-800/60 flex justify-between items-center">
            <div>
                <h1 class="text-[10px] font-bold tracking-[0.2em] text-blue-500 uppercase mb-1 drop-shadow-md">THE
                    SIMULATOR</h1>
                <div class="text-2xl font-black tracking-tight text-white drop-shadow-xl">STAR<span
                        class="text-blue-500">_DRILL</span></div>
            </div>
            <!-- HISTORY BUTTON -->
            <button onclick="openHistory()"
                class="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white px-3 py-1 rounded text-xs font-bold mr-4 transition-colors">
                <i class="fas fa-history mr-1"></i> HISTORY
            </button>
            <a href="/dashboard.html"
                class="text-slate-500 hover:text-white transition-colors text-xs font-mono tracking-wide">[EXIT]</a>
        </div>




        <!-- Scrollable Controls -->
        <div class="flex-1 overflow-y-auto custom-scroll p-6 md:p-8 flex flex-col relative">

            <!-- Context Panel (Top) -->
            <div id="context-panel" class="mb-4 p-4 bg-slate-900/40 border border-slate-700/50 rounded-xl hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-1">Target Mission
                        </div>
                        <h2 id="ctx-role" class="text-white font-bold text-sm">Loading...</h2>
                        <p id="ctx-company" class="text-xs text-slate-400">...</p>
                    </div>
                    <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded">Resume Active</span>
                </div>
            </div>

            <!-- CHAT CONTAINER -->
            <div id="chat-container" class="flex-1 space-y-4 mb-4 overflow-y-auto custom-scroll pb-20">
                <!-- AI Welcome Message -->
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div
                        class="bg-slate-800/80 p-4 rounded-r-xl rounded-bl-xl border border-slate-700/50 text-sm text-slate-200 shadow-sm max-w-[85%]">
                        <p>I'm your Behavioral Interview Coach. I've analyzed your resume and the target role.</p>
                        <p class="mt-2">I'm going to ask you a specific question to test your experience. Ready?</p>
                    </div>
                </div>
            </div>

            <!-- INPUT AREA (Sticky Bottom of Container) -->
            <div class="mt-auto relative group">
                <textarea id="user-input"
                    class="w-full h-24 bg-slate-900/80 border border-slate-700/60 rounded-xl p-4 pr-12 text-sm text-slate-300 placeholder-slate-600 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/20 focus:bg-slate-900 resize-none custom-scroll transition-all shadow-inner"
                    placeholder="Type your answer or use the microphone..."></textarea>

                <div class="absolute bottom-3 right-3 flex gap-2">
                    <!-- Mic Button -->
                    <button id="mic-btn" onclick="toggleRecording()"
                        class="px-4 py-2 rounded-lg bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 transition-all shadow-lg flex items-center gap-2"
                        title="Dictate Story">
                        <i id="mic-icon" class="fas fa-microphone"></i>
                        <span class="text-xs font-bold">Record</span>
                    </button>
                    <!-- Send Button -->
                    <button id="send-btn" onclick="sendMessage()"
                        class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-500 transition-all shadow-lg flex items-center gap-2">
                        <span class="text-xs font-bold">Send</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

        </div>






    </aside>


    <!-- RIGHT PANEL: RESULTS (60%) -->
    <main
        class="w-full md:flex-1 h-auto md:h-full bg-slate-950 relative overflow-visible md:overflow-hidden flex flex-col order-2">

        <!-- DECORATIVE GRIDS -->
        <div class="absolute inset-0 z-0 opacity-10 pointer-events-none"
            style="background-image: linear-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(59, 130, 246, 0.1) 1px, transparent 1px); background-size: 40px 40px;">
        </div>
        <div
            class="absolute inset-0 z-0 bg-gradient-to-br from-slate-950 via-slate-950 to-blue-900/10 pointer-events-none">
        </div>

        <!-- CONTAINER -->
        <div class="h-full overflow-y-auto custom-scroll relative z-10 p-6 md:p-12 flex flex-col">

            <!-- STATE A: IDLE -->
            <div id="state-idle" class="flex-1 flex flex-col items-center justify-center text-center">
                <div
                    class="w-24 h-24 rounded-2xl bg-slate-900/50 border border-slate-800 flex items-center justify-center mb-8 rotate-3 shadow-[0_0_40px_-10px_rgba(0,0,0,0.5)]">
                    <span class="text-4xl">‚≠ê</span>
                </div>
                <h2 class="text-xl font-bold text-white mb-2 tracking-tight">Structured Output</h2>
                <p class="text-slate-500 max-w-sm text-sm">Your formatted story will appear here, broken down by
                    Situation, Task, Action, and Result.</p>
            </div>

            <!-- STATE B: LOADING -->
            <div id="state-loading" class="hidden flex-1 flex flex-col items-center justify-center animate-pulse">
                <h3 class="text-2xl font-bold text-blue-500 uppercase tracking-widest mb-4">Structuring Story...</h3>
                <p class="text-slate-500 text-sm">Isolating key actions and quantifying results.</p>
            </div>

            <!-- STATE C: RESULTS (The 4 Cards) -->
            <div id="state-result" class="hidden w-full max-w-4xl mx-auto space-y-6 pb-20">

                <!-- S: Situation -->
                <div
                    class="star-card bg-slate-900/50 border-l-4 border-blue-500 rounded-r-xl p-6 relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 p-4 opacity-10 font-black text-6xl text-blue-500 pointer-events-none">
                        S</div>
                    <h3 class="text-blue-400 font-bold uppercase tracking-wider text-xs mb-3">Situation</h3>
                    <p id="res-s" class="text-slate-200 leading-relaxed"></p>
                </div>

                <!-- T: Task -->
                <div
                    class="star-card bg-slate-900/50 border-l-4 border-purple-500 rounded-r-xl p-6 relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 p-4 opacity-10 font-black text-6xl text-purple-500 pointer-events-none">
                        T</div>
                    <h3 class="text-purple-400 font-bold uppercase tracking-wider text-xs mb-3">Task</h3>
                    <p id="res-t" class="text-slate-200 leading-relaxed"></p>
                </div>

                <!-- A: Action (Main Highlight) -->
                <div
                    class="star-card bg-gradient-to-r from-slate-900 to-slate-800 border-l-4 border-green-500 rounded-r-xl p-8 relative overflow-hidden shadow-lg transform scale-[1.02]">
                    <div
                        class="absolute top-0 right-0 p-4 opacity-10 font-black text-6xl text-green-500 pointer-events-none">
                        A</div>
                    <h3 class="text-green-400 font-bold uppercase tracking-wider text-xs mb-4">Action (The Core)</h3>
                    <p id="res-a" class="text-white text-lg leading-relaxed font-medium"></p>
                </div>

                <!-- R: Result -->
                <div
                    class="star-card bg-slate-900/50 border-l-4 border-yellow-500 rounded-r-xl p-6 relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 p-4 opacity-10 font-black text-6xl text-yellow-500 pointer-events-none">
                        R</div>
                    <h3 class="text-yellow-400 font-bold uppercase tracking-wider text-xs mb-3">Result</h3>
                    <p id="res-r" class="text-slate-200 leading-relaxed"></p>
                </div>

                <div class="mt-8 flex justify-center">
                    <button onclick="copyAll()"
                        class="text-xs text-slate-500 hover:text-white uppercase tracking-widest font-bold flex items-center gap-2 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                        Copy Full Answer
                    </button>
                    <span id="copy-msg" class="ml-2 text-xs text-green-500 hidden">Copied!</span>
                </div>

            </div>

        </div>

    </main>

    <!-- LIMIT MODAL -->
    <div id="limit-modal"
        class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-blue-500/30 rounded-2xl max-w-md w-full p-8 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
            <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">üîí
            </div>
            <h3 class="text-2xl font-bold text-white mb-2">Free Limit Reached</h3>
            <p class="text-slate-400 mb-8">You've used your 3 free STAR Drills for this month. Upgrade to the Monthly
                Plan for unlimited access to all tools.</p>
            <a href="/pricing.html"
                class="block w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-all mb-3 shadow-[0_0_20px_rgba(37,99,235,0.4)]">
                Upgrade Now ($49.99/mo)
            </a>
            <button onclick="document.getElementById('limit-modal').classList.add('hidden')"
                class="text-slate-500 text-sm hover:text-white">Cancel</button>
        </div>
    </div>

    <script>
        const textarea = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');
        const APP_SESSION_KEY = 'aceinterview_session';

        let chatHistory = [];
        let isRecording = false;
        let recognition = null;
        let missionContext = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadContext();
            startSession();
        });

        function loadContext() {
            try {
                // Load Active Mission Context from Dashboard
                const ctxStr = localStorage.getItem('mission_context');

                // Also try to get Master Resume if not in context
                const resumeStr = localStorage.getItem('master_resume_text');

                if (ctxStr) {
                    missionContext = JSON.parse(ctxStr);
                    missionContext.resume_text = resumeStr || ""; // Ensure resume is attached

                    // Update UI
                    document.getElementById('context-panel').classList.remove('hidden');
                    document.getElementById('ctx-role').innerText = missionContext.role_title || "Target Role";
                    document.getElementById('ctx-company').innerText = missionContext.company_name || "Target Company";
                } else {
                    // Fallback if no context (Manual Mode implied)
                    missionContext = {
                        resume_text: resumeStr || "",
                        job_description: "",
                        role_title: "General Interview"
                    };
                }
            } catch (e) {
                console.error("Context Load Error", e);
            }
        }

        async function startSession() {
            // Initial AI Greeting & Question Generation
            addMessage('system', "Analyzing your profile and target role...");

            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'star_coach_init',
                        resume_text: missionContext.resume_text,
                        job_description: missionContext.job_description,
                        role_title: missionContext.role_title
                    })
                });

                const data = await response.json();
                if (data.question) {
                    // Remove "Analyzing..." bubble (optional, but keep for history)
                    addMessage('system', data.question);
                } else {
                    addMessage('system', "I'm ready. Tell me about a time you demonstrated leadership.");
                }

            } catch (e) {
                console.error(e);
                addMessage('system', "Connection error. Please tell me your story manually.");
            }
        }

        async function sendMessage() {
            const text = textarea.value.trim();
            if (!text) return;

            // User Bubble
            addMessage('user', text);
            textarea.value = '';

            // Show Thinking
            const thinkingId = addMessage('system', "Thinking...", true);

            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'star_coach_step',
                        history: chatHistory,
                        latest_input: text
                    })
                });

                const data = await response.json();

                // Remove Thinking Bubble
                document.getElementById(thinkingId).remove();

                if (data.status === 'clarify') {
                    addMessage('system', data.question);
                } else if (data.status === 'complete') {
                    addMessage('system', "Great story! I've structured it into the S.T.A.R. format below.");
                    showResult(data.star_data);
                    saveToHistory(data.star_data, text); // Save original input as full transcript approximation
                }

            } catch (e) {
                document.getElementById(thinkingId).remove();
                addMessage('system', "Error processing response. Please try again.");
            }
        }

        function addMessage(role, text, isThinking = false) {
            const div = document.createElement('div');
            const uniqueId = 'msg-' + Date.now();
            div.id = uniqueId;
            div.className = "flex gap-3 fade-in";

            // Add to history (except thinking bubbles)
            if (!isThinking) {
                chatHistory.push({ role: role, content: text });
            }

            if (role === 'system') {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="bg-slate-800/80 p-4 rounded-r-xl rounded-bl-xl border border-slate-700/50 text-sm text-slate-200 shadow-sm max-w-[85%]">
                        <p>${text}</p>
                    </div>
                `;
            } else {
                div.classList.add('flex-row-reverse');
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center shrink-0">
                        <i class="fas fa-user text-white text-xs"></i>
                    </div>
                    <div class="bg-blue-600/20 p-4 rounded-l-xl rounded-br-xl border border-blue-500/30 text-sm text-white shadow-sm max-w-[85%]">
                        <p>${text}</p>
                    </div>
                `;
            }

            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return uniqueId;
        }

        function showResult(starData) {
            document.getElementById('res-s').innerText = starData.S;
            document.getElementById('res-t').innerText = starData.T;
            document.getElementById('res-a').innerText = starData.A;
            document.getElementById('res-r').innerText = starData.R;

            document.getElementById('state-idle').classList.add('hidden');
            document.getElementById('state-result').classList.remove('hidden');
        }

        async function saveToHistory(starData, rawText) {
            // Get Auth
            let userId = null;
            let token = null;
            try {
                const sessionStr = localStorage.getItem(APP_SESSION_KEY);
                if (sessionStr) {
                    const s = JSON.parse(sessionStr);
                    userId = s.user_id || s.user?.id || s.id;
                    token = s.access_token;
                }
            } catch (e) { }

            if (!userId) return;

            await fetch('/api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify({
                    action: 'star_drill', // Re-use save endpoint logic or update backend to have star_save. 
                    // NOTE: reused star_drill endpoint expects 'input_text' to generate STAR, 
                    // BUT if we want to save *pre-generated* STAR, we might need a tweak. 
                    // For now, let's assume we invoke standard save or just rely on the user copying it.
                    // Actually, let's call star_drill but pass the raw input to trigger the save flow 
                    // The backend currently re-generates STAR. To force save EXACT structure, we need a new endpoint or tweak.
                    // Let's rely on the displayed result for now and maybe implement a specific save later if precise fidelity matches.
                    // Or better: Let's call the extraction endpoint with the full history as input text so it saves it.
                    input_text: rawText,
                    user_id: userId
                })
            });

            // Show Toast
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-3 animate-bounce';
            toast.innerHTML = '<i class="fas fa-check-circle"></i> STORY SAVED TO HISTORY';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }


        // --- SPEECH RECOGNITION ---
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = function () {
                isRecording = true;
                const btn = document.getElementById('mic-btn');
                btn.classList.remove('text-slate-400', 'bg-slate-800');
                btn.classList.add('text-white', 'bg-red-500', 'animate-pulse');
                textarea.placeholder = "Listening...";
            };

            recognition.onend = function () {
                isRecording = false;
                const btn = document.getElementById('mic-btn');
                btn.classList.add('text-slate-400', 'bg-slate-800');
                btn.classList.remove('text-white', 'bg-red-500', 'animate-pulse');
                textarea.placeholder = "Type your answer or use the microphone...";
            };

            recognition.onresult = function (event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                // Append finding to textarea
                if (finalTranscript) {
                    textarea.value += (textarea.value ? ' ' : '') + finalTranscript;
                }
            };
        }

        function toggleRecording() {
            if (!recognition) return alert("Browser not supported.");
            if (isRecording) recognition.stop();
            else recognition.start();
        }


        async function openHistory() {
            document.getElementById('history-modal').classList.remove('hidden');
            loadHistory();
        }

        async function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '<div class="text-center text-slate-500 py-10">Loading...</div>';

            try {
                // Get Auth
                let userId = null;
                let token = null;
                try {
                    const sessionStr = localStorage.getItem(APP_SESSION_KEY);
                    if (sessionStr) {
                        const s = JSON.parse(sessionStr);
                        userId = s.user_id || s.user?.id || s.id;
                        token = s.access_token;
                    }
                } catch (e) { }

                if (!userId) {
                    list.innerHTML = '<div class="text-center text-red-400 py-10">Please login to view history.</div>';
                    return;
                }

                const response = await fetch('/api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        action: 'get_star_stories',
                        user_id: userId
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                if (!data.stories || data.stories.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-500 py-10">No saved drills yet.</div>';
                    return;
                }

                list.innerHTML = data.stories.map(s => `
                <div onclick='viewStory(${JSON.stringify(s).replace(/'/g, "&#39;")})' class="p-4 bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-blue-500/50 rounded-xl cursor-pointer transition-all group">
                    <div class="flex justify-between items-start mb-2">
                            <div class="font-bold text-white text-sm truncate pr-4">${s.situation ? s.situation.substring(0, 60) + '...' : 'Untitled Story'}</div>
                            <div class="text-[10px] text-slate-500 font-mono whitespace-nowrap">${new Date(s.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="text-xs text-slate-400 line-clamp-2">${s.input_text || ''}</div>
                </div>
            `).join('');

            } catch (e) {
                console.error(e);
                list.innerHTML = `<div class="text-center text-red-400 py-10">Error loading history: ${e.message}</div>`;
            }
        }

        function viewStory(s) {
            document.getElementById('history-modal').classList.add('hidden');

            textarea.value = s.input_text || '';
            textarea.dispatchEvent(new Event('input'));

            document.getElementById('res-s').innerText = s.situation || "N/A";
            document.getElementById('res-t').innerText = s.task || "N/A";
            document.getElementById('res-a').innerText = s.action || "N/A";
            document.getElementById('res-r').innerText = s.result || "N/A";

            document.getElementById('state-idle').classList.add('hidden');
            document.getElementById('state-loading').classList.add('hidden');
            document.getElementById('state-result').classList.remove('hidden');
        }


    </script>

    <!-- HISTORY MODAL -->
    <div id="history-modal"
        class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-start justify-center pt-20 p-4">
        <div
            class="bg-slate-900 border border-slate-700 rounded-2xl max-w-2xl w-full flex flex-col max-h-[80vh] shadow-2xl">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-history text-blue-500 mr-2"></i>Saved
                    Drills</h3>
                <button onclick="document.getElementById('history-modal').classList.add('hidden')"
                    class="text-slate-500 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">
                <!-- Items injected here -->
                <div class="text-center text-slate-500 py-10">Loading...</div>
            </div>
        </div>
    </div>
</body>

</html>