<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Log | Mission Control</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        .mission-card {
            transition: all 0.2s ease;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #475569;
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-300 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-slate-900/50 backdrop-blur-md z-40 shrink-0">
        <div class="px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="../dashboard.html" class="text-slate-400 hover:text-white transition-colors">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <div class="text-[10px] font-bold tracking-[0.2em] text-blue-500 uppercase">STRATEGY LAB</div>
                    <div class="text-lg font-bold text-white font-mono tracking-tight">MISSION_CONTROL <span
                            class="hidden md:inline text-slate-600">// PIPELINE</span></div>
                </div>
            </div>
            <button onclick="openModal()"
                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-xs tracking-wider transition-all flex items-center gap-2 shadow-[0_0_15px_rgba(37,99,235,0.3)]">
                <i class="fas fa-plus"></i> ADD TARGET
            </button>
        </div>
    </nav>

    <!-- Kanban Board Container -->
    <main class="flex-1 overflow-x-auto overflow-y-hidden custom-scroll p-6">
        <div class="flex gap-6 h-full min-w-[1000px]">

            <!-- COLUMN 1: TARGETS -->
            <div
                class="flex-1 flex flex-col min-w-[300px] bg-slate-900/30 rounded-xl border border-dashed border-slate-800/50">
                <div
                    class="p-4 border-b border-slate-800/50 flex items-center justify-between sticky top-0 bg-slate-950/80 backdrop-blur-sm rounded-t-xl z-10">
                    <h3
                        class="text-xs font-bold font-mono tracking-widest text-slate-400 uppercase flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                        Targets (Identify)
                    </h3>
                    <span id="count-identified"
                        class="bg-slate-800 text-slate-400 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="col-identified" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                    <!-- Cards injected here -->
                </div>
            </div>

            <!-- COLUMN 2: APPLIED -->
            <div
                class="flex-1 flex flex-col min-w-[300px] bg-blue-900/10 rounded-xl border border-dashed border-blue-900/30">
                <div
                    class="p-4 border-b border-blue-900/20 flex items-center justify-between sticky top-0 bg-slate-950/80 backdrop-blur-sm rounded-t-xl z-10">
                    <h3
                        class="text-xs font-bold font-mono tracking-widest text-blue-400 uppercase flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]"></span>
                        Applied
                    </h3>
                    <span id="count-applied"
                        class="bg-blue-900/30 text-blue-300 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="col-applied" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                    <!-- Cards injected here -->
                </div>
            </div>

            <!-- COLUMN 3: INTERVIEWING -->
            <div
                class="flex-1 flex flex-col min-w-[300px] bg-purple-900/10 rounded-xl border border-dashed border-purple-900/30">
                <div
                    class="p-4 border-b border-purple-900/20 flex items-center justify-between sticky top-0 bg-slate-950/80 backdrop-blur-sm rounded-t-xl z-10">
                    <h3
                        class="text-xs font-bold font-mono tracking-widest text-purple-400 uppercase flex items-center gap-2">
                        <span
                            class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.6)] animate-pulse"></span>
                        War Zone (Interview)
                    </h3>
                    <span id="count-interviewing"
                        class="bg-purple-900/30 text-purple-300 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="col-interviewing" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                    <!-- Cards injected here -->
                </div>
            </div>

            <!-- COLUMN 4: OFFER / CLOSED -->
            <div
                class="flex-1 flex flex-col min-w-[300px] bg-green-900/10 rounded-xl border border-dashed border-green-900/30">
                <div
                    class="p-4 border-b border-green-900/20 flex items-center justify-between sticky top-0 bg-slate-950/80 backdrop-blur-sm rounded-t-xl z-10">
                    <h3
                        class="text-xs font-bold font-mono tracking-widest text-green-400 uppercase flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                        Closed / Offer
                    </h3>
                    <span id="count-offer"
                        class="bg-green-900/30 text-green-300 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                </div>
                <div id="col-offer" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                    <!-- Cards injected here -->
                </div>
            </div>

        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-state" class="fixed inset-0 bg-slate-950 z-50 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-slate-500 font-mono text-sm animate-pulse">SYNCING PIPELINE...</p>
    </div>

    <!-- Add Job Modal -->
    <div id="add-modal"
        class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-200 p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-xl shadow-2xl transform scale-95 transition-transform duration-200 max-h-[90vh] overflow-y-auto custom-scroll"
            id="modal-content">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-800/50 rounded-t-xl">
                <h3 class="text-white font-bold font-mono tracking-wide">NEW_TARGET_ACQUISITION</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="add-job-form" class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Target
                        Company</label>
                    <input type="text" name="company_name" required placeholder="e.g. Acme Corp"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Role
                        Title</label>
                    <input type="text" name="job_title" required placeholder="e.g. Senior Strategist"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Job Description
                        / Intel</label>
                    <textarea name="job_description" rows="5" placeholder="Paste JD or context here..."
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-colors placeholder-slate-600 resize-none custom-scroll"></textarea>
                </div>

                <div class="pt-4">
                    <button type="submit" id="btn-save"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all">
                        <span>INITIATE CAMPAIGN</span>
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Config (Same as Dashboard)
        const SUPABASE_URL = 'https://nvfjmqacxzlmfamiynuu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZmptcWFjeHpsbWZhbWl5bnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzk3MzAsImV4cCI6MjA4MDcxNTczMH0.W3J-E2ldrc99btVeChF0SauTQxr_48uFwImVaoHfOXI';

        const modal = document.getElementById('add-modal');
        const modalContent = document.getElementById('modal-content');

        function openModal() {
            modal.classList.remove('hidden');
            // small delay to define opacity transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        // Close on backdrop click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // AUTH CHECK & REFRESH
            let currentToken = localStorage.getItem('supabase.auth.token');
            const refreshToken = localStorage.getItem('supabase.auth.refresh_token');

            if (!currentToken) {
                window.location.href = '/login.html';
                return;
            }

            // Init Supabase
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Refesh Token Logic ( Simplified for this view )
            // Ideally we check validity or let the fetch fail with 401 and redirect.

            const loading = document.getElementById('loading-state');
            const form = document.getElementById('add-job-form');

            // Columns
            const cols = {
                'Identified': document.getElementById('col-identified'),
                'Applied': document.getElementById('col-applied'),
                'Interviewing': document.getElementById('col-interviewing'),
                'Offer': document.getElementById('col-offer'),
            };

            const counts = {
                'Identified': document.getElementById('count-identified'),
                'Applied': document.getElementById('count-applied'),
                'Interviewing': document.getElementById('count-interviewing'),
                'Offer': document.getElementById('count-offer'),
            };


            // Fetch Jobs
            async function loadJobs() {
                try {
                    const res = await fetch('/api/jobs', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    if (res.status === 401) window.location.href = '/login.html';
                    if (!res.ok) throw new Error("Failed to load jobs");

                    const jobs = await res.json();
                    renderBoard(jobs);
                    loading.classList.add('hidden');
                } catch (e) {
                    console.error(e);
                }
            }

            function renderBoard(jobs) {
                // Clear Cols
                Object.values(cols).forEach(col => col.innerHTML = '');

                // Track counts
                const stats = { 'Identified': 0, 'Applied': 0, 'Interviewing': 0, 'Offer': 0 };

                jobs.forEach(job => {
                    // Default to Identified if unknown
                    let status = job.status || 'Identified';
                    // Normalize status string case (Backend stores capitalized often, but let's be safe)
                    // We map common variations to our 4 keys
                    if (status.toLowerCase().includes('offer') || status.toLowerCase().includes('closed')) status = 'Offer';
                    else if (status.toLowerCase().includes('interview')) status = 'Interviewing';
                    else if (status.toLowerCase().includes('appli')) status = 'Applied';
                    else status = 'Identified';

                    stats[status]++;

                    const card = createJobCard(job, status);
                    cols[status].insertAdjacentHTML('beforeend', card);
                });

                // Update counts
                Object.keys(counts).forEach(key => {
                    counts[key].textContent = stats[key];
                });
            }

            function createJobCard(job, currentStatus) {
                // Resume Status
                const resScore = job.resume_score || 0;
                const resClass = resScore > 80 ? 'text-green-500' : (resScore > 0 ? 'text-amber-500' : 'text-slate-600');
                const resIcon = resScore > 80 ? 'fa-check-circle' : 'fa-circle';

                // Interview Status Display
                const intScore = job.interview_score || 0;

                return `
                <div class="mission-card bg-slate-900 border border-slate-800 rounded-lg p-4 flex flex-col relative group hover:border-slate-600">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-white font-bold text-sm leading-tight mb-1 truncate max-w-[180px]">${job.job_title}</h3>
                            <p class="text-blue-400 font-mono text-[10px] uppercase tracking-wider truncate max-w-[180px]">${job.company_name}</p>
                        </div>
                        <button onclick="deleteJob('${job.id}')" class="text-slate-700 hover:text-red-500 transition-colors p-1 opacity-0 group-hover:opacity-100">
                            <i class="fas fa-trash-alt text-[10px]"></i>
                        </button>
                    </div>

                    <!-- Status Dropdown (The "Drag Drop" Mechanism) -->
                    <div class="mb-3">
                        <select onchange="updateStatus('${job.id}', this.value)" 
                            class="w-full bg-slate-950 border border-slate-800 rounded text-[10px] font-bold text-slate-400 py-1 px-2 outline-none focus:border-blue-500 cursor-pointer hover:bg-slate-900 transition-colors">
                            <option value="Identified" ${currentStatus === 'Identified' ? 'selected' : ''}>üéØ Identify</option>
                            <option value="Applied" ${currentStatus === 'Applied' ? 'selected' : ''}>üìù Applied</option>
                            <option value="Interviewing" ${currentStatus === 'Interviewing' ? 'selected' : ''}>üé§ Interviewing</option>
                            <option value="Offer" ${currentStatus === 'Offer' ? 'selected' : ''}>ü§ù Offer / Closed</option>
                        </select>
                    </div>

                    <!-- Mini Stats -->
                    <div class="flex items-center gap-3 mb-3 border-t border-slate-800/50 pt-2">
                        <div class="flex items-center gap-1.5" title="Resume Score">
                            <i class="fas ${resIcon} ${resClass} text-[10px]"></i>
                            <span class="text-[9px] text-slate-500 font-mono">RES: ${resScore > 0 ? resScore + '%' : 'N/A'}</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2">
                         <button onclick="window.openWarRoom('${job.id}')" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white text-[10px] font-bold py-1.5 rounded transition-colors text-center border border-transparent hover:border-blue-500/30">
                            WAR ROOM
                        </button>
                         <button onclick="smartLaunch('${job.id}', '30-60-90.html', ${JSON.stringify(job).replace(/"/g, '&quot;')})" 
                            class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 border border-blue-900/50 hover:border-blue-500/50 px-2 rounded transition-colors" title="Quick Plan">
                            <i class="fas fa-road text-[10px]"></i>
                        </button>
                    </div>
                </div>
                `;
            }

            // Status Update Logic
            window.updateStatus = async (id, newStatus) => {
                // Optimistic UI updates could happen here, but simplest is to just call API and reload
                // Or better: visually move it immediately? 
                // Let's do simple reload for robustness first.

                try {
                    const res = await fetch(`/api/jobs/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!res.ok) throw new Error("Update failed");
                    loadJobs(); // Refresh board
                } catch (e) {
                    alert("Failed to move card: " + e.message);
                }
            };

            // War Room Redirect (Saving old modal logic if user preferred it, but for Kanban compact view, standard redirect or lightweight modal is better)
            // The user request said "Keep Open War Room button... secondary action". 
            // I'll make it launch a tools menu or just redirect to a default tool?
            // Actually, let's make "War Room" open a dedicated modal or just expand.
            // For now, let's duplicate the logic from the old file but simplify presentation.
            // Let's make "War Room" just jump to Resume Rewriter as "Main Base" or show a quick selection prompt.
            // Using a simple browser 'prompt' style is ugly. Let's redirect to dashboard tool selection?
            // Actually, let's keep the `smartLaunch` logic and make WAR ROOM open the 30-60-90 plan by default or the Resume tool.

            window.openWarRoom = (id) => {
                // Simplified: Just go to Resume Rewriter as entry point? 
                // Or better: Detect state. If interviewing, go to Interview tool?
                // For simplicity: Alert user where to go? No.
                // Let's just Launch Strategy Plan as default War Room action.
                // Re-using smartLaunch data requires the job object, which I didn't pass to this fn easily.
                // Correct: I can look up the job from a simple cache if needed, or just pass it.
                // Let's rely on finding the button's context or just reloading.
                // Actually, let's make the War Room button trigger a small context menu in the future.
                // For this MVP step 1: War Room -> Resume Rewriter (the base).
                const job = findJobById(id);
                if (job) smartLaunch(id, '../resume-rewriter.html', job);
            };

            let localJobsInfo = []; // Cache to find job by ID
            const superRender = renderBoard;
            renderBoard = (jobs) => {
                localJobsInfo = jobs; // Update cache
                superRender(jobs);
            }

            function findJobById(id) {
                return localJobsInfo.find(j => j.id === id);
            }

            // Delete Job Logic
            window.deleteJob = async (id) => {
                if (!confirm("Are you sure you want to remove this target campaign?")) return;

                try {
                    const res = await fetch(`/api/jobs/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });

                    if (!res.ok) throw new Error("Failed to delete job");
                    loadJobs();
                } catch (e) {
                    console.error("Delete Error:", e);
                    alert("Error removing target: " + e.message);
                }
            };

            // Smart Launch Logic
            window.smartLaunch = (id, url, job) => {
                const context = {
                    job_id: id,
                    role: job.job_title,
                    company: job.company_name,
                    description: job.job_description
                };
                localStorage.setItem('strategy_context', JSON.stringify(context));
                window.location.href = url;
            };

            // Add Job Submit
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-save');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';
                btn.disabled = true;

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                // Default status
                data.status = 'Identified';

                try {
                    const res = await fetch('/api/jobs', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentToken}`
                        },
                        body: JSON.stringify(data)
                    });

                    if (!res.ok) throw new Error("Failed to create target");

                    closeModal();
                    form.reset();
                    loadJobs();

                } catch (err) {
                    alert("Error: " + err.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });

            // Initial Load
            loadJobs();
        });
    </script>
</body>

</html>