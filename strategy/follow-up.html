<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Value Follow-Up | Strategy Lab</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Supabase Client for Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/app.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 0.6;
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }

            50% {
                opacity: 1;
                box-shadow: 0 0 20px 0 rgba(59, 130, 246, 0.6);
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        /* Markdown Styling */
        .markdown-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .markdown-content h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #60a5fa;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #1e293b;
            padding-bottom: 0.5rem;
        }

        .markdown-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #94a3b8;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .markdown-content p {
            color: #cbd5e1;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .markdown-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
            color: #cbd5e1;
        }

        .markdown-content li {
            margin-bottom: 0.5rem;
        }

        .markdown-content strong {
            color: #22c55e;
            font-weight: 600;
        }

        /* Green bold */
        .highlight-placeholder {
            background-color: #fde047;
            /* Bright Yellow */
            color: #0f172a;
            /* Dark Text */
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px dashed #ca8a04;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .drag-active {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.2);
            background-color: rgba(30, 41, 59, 0.5) !important;
        }
    </style>
</head>

<body
    class="flex flex-col md:flex-row min-h-screen md:h-screen bg-slate-950 text-slate-300 overflow-y-auto md:overflow-hidden">

    <!-- LEFT PANEL: CONTROLS (300px Fixed) -->
    <aside
        class="w-full md:w-[320px] lg:w-[350px] flex-shrink-0 h-auto md:h-full flex flex-col relative z-20 border-b md:border-b-0 md:border-r border-slate-800 bg-slate-900/50 backdrop-blur-sm shadow-[10px_0_30px_-5px_rgba(0,0,0,0.5)] order-1">

        <!-- Header -->
        <div class="p-6 border-b border-slate-800/60 flex justify-between items-center bg-slate-900/80">
            <div>
                <h1 class="text-[10px] font-bold tracking-[0.2em] text-green-500 uppercase mb-1 drop-shadow-md">STRATEGY
                    LAB</h1>
                <div class="text-xl font-bold tracking-tight text-white font-mono">VALUE<span
                        class="text-green-500">_FOLLOW_UP</span></div>
            </div>
            <a href="../dashboard.html"
                class="text-slate-500 hover:text-white transition-colors text-xs font-mono tracking-wide">[EXIT]</a>
        </div>

        <!-- Scrollable Form -->
        <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-8">
            <!-- Resume Upload (Missing in previous view, added back for functionality) -->
            <div>
                <label
                    class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.8)]"></span>
                    1. Your Resume
                </label>
                <div id="dropzone"
                    class="border-2 border-dashed border-blue-500/30 bg-slate-900/20 rounded-xl p-8 text-center transition-all duration-300 cursor-pointer hover:border-blue-500/60 hover:shadow-[0_0_20px_rgba(59,130,246,0.1)] group relative">
                    <input type="file" id="resume-upload" class="hidden" accept=".pdf,.doc,.docx,.txt">
                    <div id="upload-idle">
                        <div
                            class="w-12 h-12 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-600/20 group-hover:text-blue-400 transition-all shadow-inner border border-white/5">
                            <i class="fas fa-cloud-upload-alt text-xl text-slate-400 group-hover:text-blue-400"></i>
                        </div>
                        <p class="text-xs font-semibold text-slate-200 tracking-wide">DROP RESUME PDF</p>
                        <p class="text-[9px] text-slate-500 mt-1 font-mono uppercase">Parses context & skills</p>
                    </div>
                    <div id="upload-success" class="hidden">
                        <div
                            class="w-12 h-12 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-3 border border-green-500/20 shadow-[0_0_15px_rgba(74,222,128,0.2)]">
                            <i class="fas fa-check text-green-400"></i>
                        </div>
                        <p class="text-xs font-semibold text-white truncate px-2" id="filename-display">resume.pdf</p>
                        <button onclick="resetUpload(event)"
                            class="text-[9px] text-slate-500 hover:text-red-400 uppercase tracking-wider mt-2 font-bold transition-colors">Change
                            File</button>
                    </div>
                </div>
            </div>

            <form id="tool-form" class="space-y-6">

                <!-- Input: Scenario -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Context /
                        Scenario</label>
                    <div class="relative group">
                        <select name="scenario" required
                            class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-green-500 outline-none transition-all appearance-none cursor-pointer group-hover:border-slate-600">
                            <option value="post_interview">Post-Interview Thank You (Within 24h)</option>
                            <option value="no_response_1">No Response (1 Week Check-in)</option>
                            <option value="no_response_2">No Response (2 Week Check-in)</option>
                            <option value="networking">Cold Networking Reachout</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-green-500">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Input: Recipient -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Recipient
                        Name</label>
                    <div class="relative group">
                        <input type="text" name="recipient_name" required
                            class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-green-500 outline-none transition-all group-hover:border-slate-600"
                            placeholder="e.g. John Doe">
                    </div>
                </div>

                <!-- Input: Value Context -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Key Value /
                        Conversation Topic</label>
                    <div class="relative group">
                        <textarea name="context" rows="6" required id="context-input"
                            class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-green-500 outline-none resize-none custom-scroll transition-all group-hover:border-slate-600"
                            placeholder="e.g. We discussed the scale issues in Python. I have 3 ideas for migrating to Go..."></textarea>
                    </div>
                </div>

            </form>
        </div>

        <!-- Footer Action -->
        <div class="p-6 border-t border-slate-800/60 bg-slate-900/40 backdrop-blur-md z-30">
            <button type="submit" form="tool-form" id="btn-generate" disabled
                class="w-full bg-green-600 hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(34,197,94,0.4)] transition-all flex items-center justify-center gap-2 group">
                <span class="btn-text">INITIALIZING...</span>
                <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </aside>

    <!-- RIGHT PANEL: OUPUT -->
    <main
        class="flex-1 h-auto md:h-full bg-slate-950 relative overflow-visible md:overflow-hidden flex flex-col order-2">

        <!-- Background Grids -->
        <div class="absolute inset-0 z-0 opacity-10 pointer-events-none"
            style="background-image: linear-gradient(rgba(34, 197, 94, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(34, 197, 94, 0.1) 1px, transparent 1px); background-size: 40px 40px;">
        </div>

        <!-- Toolbar -->
        <div
            class="relative z-20 h-16 border-b border-slate-800/50 flex items-center justify-between px-8 bg-slate-900/30 backdrop-blur-sm flex-shrink-0">
            <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-slate-600" id="status-dot"></span>
                READY
            </h2>
            <div class="flex gap-4">
                <button id="btn-copy"
                    class="text-slate-400 hover:text-white transition-colors text-sm font-mono flex items-center gap-2 hidden">
                    <i class="far fa-copy"></i> Copy
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-auto custom-scroll p-8 md:p-12 relative z-10">

            <!-- Unlock Overlay -->
            <div id="unlock-overlay"
                class="hidden absolute inset-0 bg-slate-950/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center text-center p-8">
                <div
                    class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-4 border border-slate-700">
                    <i class="fas fa-lock text-2xl text-slate-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Unlock The Follow-Up</h2>
                <p class="text-slate-400 mb-6 max-w-sm">Draft a perfect, value-driven email that practically forces a
                    reply.</p>
                <button id="btn-unlock"
                    class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg shadow-green-900/20">
                    Unlock Tool ($6.99)
                </button>
            </div>

            <!-- Loading State -->
            <div id="loading" class="hidden flex flex-col items-center justify-center mt-20">
                <div class="w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full animate-spin mb-6">
                </div>
                <p class="text-green-400 font-mono animate-pulse">DRAFTING EMAIL...</p>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="flex flex-col items-center justify-center mt-20 opacity-50">
                <i class="fas fa-paper-plane text-6xl text-slate-700 mb-6"></i>
                <p class="text-slate-500 text-lg">Enter scenario details to start.</p>
            </div>

            <!-- Markdown Output -->
            <div id="result-content" class="hidden markdown-content max-w-3xl mx-auto pb-20"></div>
        </div>
    </main>

    <script>
        // Use window.supabase from app.js or initialize fallback
        const initSupabase = () => {
            if (window.supabase) return window.supabase;
            const supabaseUrl = 'https://nvfjmqacxzlmfamiynuu.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZmptcWFjeHpsbWZhbWl5bnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzk3MzAsImV4cCI6MjA4MDcxNTczMH0.W3J-E2ldrc99btVeChF0SauTQxr_48uFwImVaoHfOXI';
            window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
            return window.supabase;
        };

        const supabaseClient = initSupabase();

        // Global State
        let extractedResumeText = "";
        let isLocked = true;
        let userEmail = null;
        let userId = null;
        let authToken = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Check Smart Context
            const missionContext = localStorage.getItem('mission_context');
            if (missionContext) {
                try {
                    const ctx = JSON.parse(missionContext);
                    const statusText = `Interviewed for ${ctx.role} at ${ctx.company}.\n\nNotes:\n${ctx.notes || 'No specific notes.'}`;
                    document.getElementById('context-input').value = statusText;
                    localStorage.removeItem('mission_context');
                } catch (e) { console.error("Context Error", e); }
            }

            // 1. Auth Check
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (!session || error) {
                console.warn("No session found, redirecting to login");
                window.location.href = '../login.html'; // Adjust path if needed
                return;
            }
            authToken = session.access_token;

            // 2. Fetch Profile & Credits via API
            await verifyAccess(authToken);

            // Bind Events
            const form = document.getElementById('tool-form');
            form.addEventListener('submit', handleGeneration);

            document.getElementById('btn-copy').addEventListener('click', copyContent);

            // Drag and Drop
            setupDragDrop();
        });

        async function verifyAccess(token) {
            const overlay = document.getElementById('unlock-overlay');
            const genBtn = document.getElementById('btn-generate');
            const statusDot = document.getElementById('status-dot');
            const btnUnlock = document.getElementById('btn-unlock');

            try {
                // Ensure overlay is blocking by default
                overlay.classList.remove('hidden');
                genBtn.disabled = true;

                const res = await fetch('/api/user-profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 401) {
                    console.error("401 Unauthorized from /api/user-profile");
                    // Try to refresh session?
                    throw new Error("Session invalid or expired");
                }

                if (!res.ok) throw new Error("Failed to load profile");

                const user = await res.json();
                userEmail = user.email;
                userId = user.id;

                const hasCredit = user.is_unlimited
                    || (user.credits_followup && user.credits_followup > 0)
                    || (user.credits && user.credits > 0);

                if (hasCredit) {
                    // UNLOCKED
                    isLocked = false;
                    overlay.classList.add('hidden');
                    genBtn.disabled = false;
                    genBtn.innerHTML = `<span class="btn-text">WRITE EMAIL</span><i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>`;
                    genBtn.classList.remove('shadow-green-900/20');

                    statusDot.classList.remove('bg-slate-600');
                    statusDot.classList.add('bg-green-500', 'shadow-[0_0_8px_rgba(34,197,94,0.6)]');
                } else {
                    // LOCKED
                    isLocked = true;
                    genBtn.disabled = false; // Enable for purchase
                    genBtn.innerHTML = `<i class="fas fa-lock"></i> <span class="btn-text">UNLOCK TOOL ($6.99)</span>`;
                    genBtn.classList.add('shadow-green-900/20');

                    // Bind Purchase
                    const buyHandler = (e) => {
                        e.preventDefault();
                        initiateCheckout('strategy_followup', user.email);
                    };
                    genBtn.onclick = buyHandler;
                    btnUnlock.onclick = () => initiateCheckout('strategy_followup', user.email);
                }

            } catch (e) {
                console.error("Access verification error:", e);
                // Fallback: Allow purchase attempt even if profile fetch failed?
                // No, we need email/ID. 
                genBtn.disabled = false;
                genBtn.innerHTML = `<span>RETRY CONNECTION</span><i class="fas fa-sync"></i>`;
                genBtn.onclick = () => window.location.reload();

                if (e.message.includes("Session")) {
                    alert("Your session has expired. Please log in again.");
                    window.location.href = '../login.html';
                }
            }
        }

        async function initiateCheckout(planType, email) {
            const btn = document.activeElement;
            const originalText = btn.innerHTML;

            if (btn) {
                btn.innerHTML = 'Processing...';
                btn.disabled = true;
            }

            try {
                const res = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({
                        plan_type: planType,
                        email: email,
                        userId: userId, // Pass ID
                        successUrl: window.location.href
                    })
                });
                const json = await res.json();
                if (json.url) window.location.href = json.url;
                else throw new Error(json.error || "Checkout failed");
            } catch (e) {
                alert("Checkout Error: " + e.message);
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        async function handleGeneration(e) {
            e.preventDefault();
            if (isLocked) return;

            const form = e.target;
            const formData = new FormData(form);
            const inputs = Object.fromEntries(formData.entries());

            if (!extractedResumeText) return alert("Please upload a resume first.");

            // Add Resume
            inputs.resume_text = extractedResumeText;

            const resultDiv = document.getElementById('result-content');
            const loadDiv = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const btnGenerate = document.getElementById('btn-generate');
            const btnCopy = document.getElementById('btn-copy');

            loadDiv.classList.remove('hidden');
            emptyState.classList.add('hidden');
            resultDiv.classList.add('hidden');
            btnGenerate.disabled = true;
            btnCopy.classList.add('hidden');

            try {
                const res = await fetch('/api/generate-strategy-tool', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        email: userEmail,
                        tool_type: 'follow_up',
                        inputs: inputs
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                let start_idx = 0;
                resultDiv.innerHTML = marked.parse(data.content);

                // Highlight placeholders
                resultDiv.innerHTML = resultDiv.innerHTML.replace(/\[(.*?)\]/g, '<span class="highlight-placeholder">[$1]</span>');

                resultDiv.classList.remove('hidden');
                btnCopy.classList.remove('hidden');

            } catch (err) {
                alert("Error: " + err.message);
                emptyState.classList.remove('hidden');
            } finally {
                loadDiv.classList.add('hidden');
                btnGenerate.disabled = false;
            }
        }

        function setupDragDrop() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('resume-upload');
            const uploadIdle = document.getElementById('upload-idle');
            const uploadSuccess = document.getElementById('upload-success');
            const filenameDisplay = document.getElementById('filename-display');

            dropzone.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => dropzone.addEventListener(eventName, () => dropzone.classList.add('drag-active'), false));
            ['dragleave', 'drop'].forEach(eventName => dropzone.addEventListener(eventName, () => dropzone.classList.remove('drag-active'), false));
            dropzone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);
            fileInput.addEventListener('change', function () { handleFiles(this.files); });

            async function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    filenameDisplay.textContent = file.name;
                    try {
                        if (file.type === "application/pdf") {
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            let fullText = "";
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const tc = await page.getTextContent();
                                fullText += tc.items.map(s => s.str).join(' ');
                            }
                            extractedResumeText = fullText;
                        } else {
                            extractedResumeText = await file.text();
                        }
                        // Sticky Memory
                        localStorage.setItem('master_resume_text', extractedResumeText);
                        localStorage.setItem('master_resume_name', file.name);

                        uploadIdle.classList.add('hidden');
                        uploadSuccess.classList.remove('hidden');
                        dropzone.classList.remove('border-dashed', 'border-blue-500/30');
                        dropzone.classList.add('border-green-500/30', 'bg-slate-900/80');
                    } catch (e) {
                        console.error(e);
                        alert("File Parse Error: " + e.message);
                    }
                }
            }
            window.resetUpload = (e) => {
                e.stopPropagation();
                fileInput.value = '';
                extractedResumeText = "";
                uploadIdle.classList.remove('hidden');
                uploadSuccess.classList.add('hidden');
                dropzone.classList.add('border-dashed', 'border-blue-500/30');
                dropzone.classList.remove('border-green-500/30', 'bg-slate-900/80', 'drag-active');
            }
        }

        function copyContent() {
            const text = document.getElementById('result-content').innerText;
            navigator.clipboard.writeText(text);
            const btnCopy = document.getElementById('btn-copy');
            const original = btnCopy.innerHTML;
            btnCopy.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => btnCopy.innerHTML = original, 2000);
        }

    </script>
</body>

</html>