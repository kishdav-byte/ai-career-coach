<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Performance - Total Package Interview</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass-sidebar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }
    </style>
</head>

<div class="flex h-screen bg-slate-950 relative flex-col md:flex-row overflow-hidden">

    <!-- MOBILE HEADER (Visible < md) -->
    <div
        class="md:hidden fixed top-0 left-0 w-full h-16 bg-slate-900 border-b border-white/5 flex items-center justify-between px-6 z-50">
        <div class="flex flex-col">
            <span class="text-[9px] font-bold text-teal uppercase tracking-[0.2em] leading-none mb-0.5">Total
                Package</span>
            <span class="text-lg font-black text-white tracking-tighter leading-none">INTERVIEW</span>
        </div>
        <button onclick="toggleSidebar()" class="p-3 -mr-3 text-slate-400 hover:text-white transition-colors">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 w-[260px] md:relative md:w-64 glass-sidebar flex flex-col justify-between h-full z-40 transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0">
        <!-- Logo -->
        <div class="h-20 flex items-center px-6 border-b border-white/5">
            <div class="flex flex-col">
                <span class="text-[10px] font-bold text-teal uppercase tracking-[0.2em] leading-tight">Total
                    Package</span>
                <span class="text-xl font-black text-white tracking-tighter leading-tight">INTERVIEW</span>
            </div>
        </div>

        <!-- Nav -->
        <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto custom-scroll">
            <a href="/dashboard.html"
                class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition-all">
                <i class="fas fa-th-large"></i>
                <span>Performance Hub</span>
            </a>
            <a href="/resume-analyzer.html"
                class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition-all">
                <i class="fas fa-file-alt"></i>
                <span>Resume Analyzer</span>
            </a>
            <a href="/resume-history.html"
                class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-white bg-teal/10 border border-teal/30 rounded-lg">
                <i class="fas fa-history"></i>
                <span>Resume Performance</span>
            </a>
            <a href="/interview-history.html"
                class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition-all">
                <i class="fas fa-chart-line"></i>
                <span>Interview Performance</span>
            </a>
        </nav>

        <!-- User Profile -->
        <div class="p-4 border-t border-white/5">
            <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                <div
                    class="w-10 h-10 rounded-full bg-teal/20 flex items-center justify-center text-teal text-sm font-bold">
                    <span id="user-initials">--</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div id="user-display" class="text-sm font-bold text-white truncate">User</div>
                    <div class="text-xs text-slate-400">Free Plan</div>
                </div>
                <button onclick="signOut()" class="text-slate-400 hover:text-white transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden bg-gradient-to-br from-slate-900 via-slate-950 to-black">
        <!-- Top Spacer for Mobile -->
        <div class="h-16 md:hidden flex-shrink-0"></div>

        <!-- Header -->
        <div class="flex-shrink-0 p-6 md:p-8 border-b border-white/5">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">Resume <span
                            class="text-teal">Performance</span></h1>
                    <p class="text-sm text-slate-400">Track your resume evolution and market relevance over time</p>
                </div>
                <a href="/resume-analyzer.html"
                    class="px-6 py-3 bg-teal hover:bg-teal/80 text-slate-900 font-bold rounded-lg transition-all flex items-center gap-2 justify-center shadow-lg shadow-teal/20">
                    <i class="fas fa-plus"></i>
                    <span>New Analysis</span>
                </a>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto p-6 md:p-8 space-y-8 custom-scroll">

            <!-- Score Trajectory Chart -->
            <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-lg font-bold text-white mb-1">Score Trajectory</h2>
                        <p class="text-sm text-slate-400">Your resume market relevance over time</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-slate-500 uppercase tracking-wider">Overall Average</div>
                        <div id="overall-avg" class="text-3xl font-bold text-teal">--</div>
                    </div>
                </div>
                <div class="relative h-64 md:h-80">
                    <canvas id="scoreChart"></canvas>
                </div>
            </div>

            <!-- Resume History Table -->
            <div class="bg-slate-900/50 border border-slate-800 rounded-2xl overflow-hidden">
                <div class="p-6 border-b border-slate-800 flex items-center justify-between">
                    <h2 class="text-lg font-bold text-white">Resume History</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="sortBy('date')" id="sort-date"
                            class="px-3 py-1.5 text-xs font-bold bg-teal text-slate-900 rounded-lg shadow-lg">
                            <i class="fas fa-calendar mr-1"></i> Chronological
                        </button>
                        <button onclick="sortBy('score')" id="sort-score"
                            class="px-3 py-1.5 text-xs font-bold text-white bg-slate-700 hover:bg-slate-600 rounded-lg transition-all">
                            <i class="fas fa-sort-amount-down mr-1"></i> By Score
                        </button>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-950/50 border-b border-slate-800">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                    Date</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                    Job Target</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                    Type</th>
                                <th
                                    class="px-6 py-4 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">
                                    Score</th>
                                <th
                                    class="px-6 py-4 text-right text-xs font-bold text-slate-400 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-table" class="divide-y divide-slate-800">
                            <!-- Populated by JS -->
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <div>Loading resume history...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SUPABASE_URL = 'https://nvfjmqacxzlmfamiynuu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52ZmptcWFjeHpsbWZhbWl5bnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzk3MzAsImV4cCI6MjA4MDcxNTczMH0.W3J-E2ldrc99btVeChF0SauTQxr_48uFwImVaoHfOXI';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const SESSION_KEY = 'aceinterview_session';

    let resumeData = [];
    let currentSort = 'date';
    let scoreChart = null;

    // Toggle Sidebar (Mobile)
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('-translate-x-full');
    }

    // Sign Out
    function signOut() {
        localStorage.removeItem(SESSION_KEY);
        window.location.href = '/login.html';
    }

    // Sort Data
    function sortBy(type) {
        currentSort = type;
        const dateBtn = document.getElementById('sort-date');
        const scoreBtn = document.getElementById('sort-score');

        if (type === 'date') {
            dateBtn.className = 'px-3 py-1.5 text-xs font-bold bg-teal text-slate-900 rounded-lg shadow-lg';
            scoreBtn.className = 'px-3 py-1.5 text-xs font-bold text-white bg-slate-700 hover:bg-slate-600 rounded-lg transition-all';
        } else {
            dateBtn.className = 'px-3 py-1.5 text-xs font-bold text-white bg-slate-700 hover:bg-slate-600 rounded-lg transition-all';
            scoreBtn.className = 'px-3 py-1.5 text-xs font-bold bg-teal text-slate-900 rounded-lg shadow-lg';
        }

        renderTable();
    }

    // Render Table
    function renderTable() {
        const tbody = document.getElementById('history-table');

        if (!resumeData || resumeData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                        <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                        <div class="text-lg font-medium">No resume history yet</div>
                        <div class="text-sm mt-1">Run your first analysis to get started</div>
                    </td>
                </tr>
            `;
            return;
        }

        // Sort data
        const sorted = [...resumeData].sort((a, b) => {
            if (currentSort === 'date') {
                return new Date(b.created_at) - new Date(a.created_at);
            } else {
                return (b.overall_score || 0) - (a.overall_score || 0);
            }
        });

        tbody.innerHTML = sorted.map(resume => {
            const date = new Date(resume.created_at);
            const score = resume.overall_score || 0;
            const scoreColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';

            return `
                <tr class="hover:bg-slate-800/30 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-white font-medium">${date.toLocaleDateString()}</div>
                        <div class="text-xs text-slate-500">${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-white font-medium">${resume.job_title || 'General Analysis'}</div>
                        <div class="text-xs text-slate-500">${resume.company_name || 'No specific target'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${resume.version_type === 'rewrite' ? 'bg-purple-500/10 text-purple-400 border border-purple-500/30' : 'bg-blue-500/10 text-blue-400 border border-blue-500/30'}">
                            ${resume.version_type || 'Analysis'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="text-2xl font-bold ${scoreColor}">${score}</div>
                        <div class="text-xs text-slate-500">/ 100</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="viewResume('${resume.id}')" class="px-4 py-2 text-xs font-bold bg-teal text-slate-900 hover:bg-teal/80 rounded-lg transition-all shadow-lg">
                                <i class="fas fa-eye mr-1"></i> View
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Render Chart
    function renderChart() {
        const ctx = document.getElementById('scoreChart').getContext('2d');

        if (scoreChart) {
            scoreChart.destroy();
        }

        const sortedByDate = [...resumeData].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        const labels = sortedByDate.map(r => new Date(r.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        const scores = sortedByDate.map(r => r.overall_score || 0);

        scoreChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Resume Score',
                    data: scores,
                    borderColor: '#20C997',
                    backgroundColor: 'rgba(32, 201, 151, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#20C997',
                    pointBorderColor: '#0f172a',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#20C997',
                        bodyColor: '#fff',
                        borderColor: '#20C997',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#94a3b8',
                            callback: function (value) {
                                return value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    }
                }
            }
        });

        // Calculate and display average
        const avg = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
        document.getElementById('overall-avg').textContent = avg + '/100';
    }

    // View Resume Details
    function viewResume(id) {
        // TODO: Navigate to resume viewer or open modal
        alert('Resume viewer coming soon! ID: ' + id);
    }

    // Re-analyze Resume
    function reanalyze(id) {
        const resume = resumeData.find(r => r.id === id);
        if (resume) {
            // Store resume data and redirect to analyzer
            localStorage.setItem('reanalyze_resume', JSON.stringify(resume));
            window.location.href = '/resume-analyzer.html';
        }
    }

    // Load Resume History
    async function loadResumeHistory() {
        try {
            const sessionStr = localStorage.getItem(SESSION_KEY);
            if (!sessionStr) {
                window.location.href = '/login.html';
                return;
            }

            const session = JSON.parse(sessionStr);
            const userId = session.user_id || session.id;
            const token = session.access_token;

            if (!userId || !token) {
                window.location.href = '/login.html';
                return;
            }

            // Set user display
            document.getElementById('user-display').textContent = session.email || 'User';
            const initials = (session.email || 'U').substring(0, 2).toUpperCase();
            document.getElementById('user-initials').textContent = initials;

            // Fetch resume history from Supabase
            const { data, error } = await supabaseClient
                .from('resumes')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error fetching resume history:', error);
                document.getElementById('history-table').innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-red-400">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <div>Error loading resume history</div>
                        </td>
                    </tr>
                `;
                return;
            }

            resumeData = data || [];
            renderTable();
            renderChart();

        } catch (err) {
            console.error('Unexpected error:', err);
            document.getElementById('history-table').innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-red-400">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <div>Failed to load resume history</div>
                    </td>
                </tr>
            `;
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', loadResumeHistory);
</script>

</body>

</html>