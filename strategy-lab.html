<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Lab | AI Career Coach</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .tool-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .tool-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .tool-status {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-500);
            margin-top: auto;
        }

        .status-unlocked {
            color: var(--success);
        }

        .status-locked {
            color: var(--gray-500);
        }

        .bundle-banner {
            background: var(--gradient-primary);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .bundle-content h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .bundle-content p {
            opacity: 0.9;
        }

        .btn-unlock {
            background: var(--success);
            color: white;
            border: none;
            width: 100%;
        }

        .btn-open {
            background: var(--primary);
            color: white;
            text-decoration: none;
            text-align: center;
            padding: 0.75rem;
            border-radius: 8px;
            display: block;
        }
    </style>
</head>

<body class="bg-gray-50">

    <nav class="nav">
        <div class="nav-container">
            <a href="/dashboard.html" class="nav-logo">AI Career Coach</a>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span id="credit-display" style="font-size: 0.9rem; font-weight: 600;"></span>
                <a href="/dashboard.html" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Back to Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container" style="padding-top: 2rem; padding-bottom: 4rem;">

        <div class="section-header">
            <h1>Strategy Lab</h1>
            <p>Advanced tools for high-stakes career moves. Own the process.</p>
        </div>

        <!-- Bundle Banner -->
        <div id="bundle-banner" class="bundle-banner" style="display: none;">
            <div class="bundle-content">
                <div
                    style="background:#22c55e; color:white; font-size:0.75rem; font-weight:800; padding:4px 10px; border-radius:20px; display:inline-block; margin-bottom:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    BEST VALUE - SAVE $20+</div>
                <h2>Unlock the Full Suite</h2>
                <p>Get instant access to All 5 Strategy Tools + A Premium Resume Rewrite.</p>
            </div>
            <button id="btn-buy-bundle" class="btn btn-secondary animate-pulse"
                style="background: white; color: var(--primary);">
                Unlock All for $29.99
            </button>
        </div>

        <div class="strategy-grid">

            <!-- Card 0: Strategy Log (Mission Control) -->
            <div class="tool-card" style="border: 1px solid #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);">
                <div class="tool-icon">üìã</div>
                <h3 style="color: #1d4ed8;">Mission Control</h3>
                <p>Track your active campaigns, resume scores, and tool usage in one dashboard.</p>
                <div class="tool-status status-unlocked">Free Access</div>
                <div>
                    <a href="/strategy/strategy-log.html" class="btn btn-open" style="background: #2563eb;">Open Log</a>
                </div>
            </div>

            <!-- Card 1: 30-60-90 Day Plan -->
            <div class="tool-card">
                <div class="tool-icon">üìÖ</div>
                <h3>30-60-90 Day Plan</h3>
                <p>Impress hiring managers with a concrete vision for your first 3 months.</p>
                <div id="status-plan" class="tool-status"></div>
                <div id="action-plan">
                    <button class="btn btn-unlock">Unlock - $8.99</button>
                </div>
            </div>

            <!-- Card 2: Cover Letter -->
            <div class="tool-card">
                <div class="tool-icon">‚úâÔ∏è</div>
                <h3>Smart Cover Letter</h3>
                <p>Generate a tailored cover letter that highlights your fit for the role.</p>
                <div id="status-cover" class="tool-status"></div>
                <div id="action-cover">
                    <button class="btn btn-unlock">Unlock - $6.99</button>
                </div>
            </div>

            <!-- Card 3: The Closer (Negotiation) -->
            <div class="tool-card">
                <div class="tool-icon">üí∞</div>
                <h3>The Closer</h3>
                <p>Negotiation scripts to maximize your comp package. Phone & Email.</p>
                <div id="status-negotiation" class="tool-status"></div>
                <div id="action-negotiation">
                    <button class="btn btn-unlock">Unlock - $6.99</button>
                </div>
            </div>

            <!-- Card 4: The Inquisitor -->
            <div class="tool-card">
                <div class="tool-icon">üïµÔ∏è</div>
                <h3>The Inquisitor</h3>
                <p>Strategic reverse-interview questions to ask your interviewer.</p>
                <div id="status-inquisitor" class="tool-status"></div>
                <div id="action-inquisitor">
                    <button class="btn btn-unlock">Unlock - $6.99</button>
                </div>
            </div>

            <!-- Card 5: Value Follow-Up -->
            <div class="tool-card">
                <div class="tool-icon">üì®</div>
                <h3>Value Follow-Up</h3>
                <p>Post-interview email that pitches a solution, not just a "thank you".</p>
                <div id="status-followup" class="tool-status"></div>
                <div id="action-followup">
                    <button class="btn btn-unlock">Unlock - $6.99</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('supabase.auth.token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // Fetch Fresh User Data
            let userData = null;
            try {
                // Always fetch fresh from API to ensure credits are up to date
                const res = await fetch('/api/user-profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    userData = await res.json();
                } else {
                    // Fallback to localStorage if API fails
                    const sessionStr = localStorage.getItem('aceinterview_session');
                    if (sessionStr) userData = JSON.parse(sessionStr);
                }
            } catch (e) {
                console.error("Error fetching fresh profile:", e);
                const sessionStr = localStorage.getItem('aceinterview_session');
                if (sessionStr) userData = JSON.parse(sessionStr);
            }

            if (!userData) {
                console.error("No user data found");
                return;
            }

            // -- CHECK CREDITS --
            const creditsPlan = userData.credits_30_60_90 || 0;
            const creditsCover = userData.credits_cover_letter || 0;
            const creditsNeg = userData.credits_negotiation || 0;
            const creditsInq = userData.credits_inquisitor || 0;
            const creditsFollow = userData.credits_followup || 0;

            const isUnlimited = userData.is_unlimited;

            // Show Banner? Only if user is missing something and NOT unlimited
            if (!isUnlimited && (creditsPlan === 0 || creditsCover === 0 || creditsNeg === 0 || creditsInq === 0 || creditsFollow === 0)) {
                document.getElementById('bundle-banner').style.display = 'flex';
            }

            // -- RENDER CARDS --

            // 1. Plan
            renderCard('plan', creditsPlan, '/strategy/30-60-90', 'strategy_plan', isUnlimited);
            // 2. Cover
            renderCard('cover', creditsCover, '/strategy/cover-letter', 'strategy_cover', isUnlimited);
            // 3. Negotiation (Closer)
            renderCard('negotiation', creditsNeg, '/strategy/closer', 'strategy_closer', isUnlimited);
            // 4. Inquisitor
            renderCard('inquisitor', creditsInq, '/strategy/inquisitor', 'strategy_inquisitor', isUnlimited);
            // 5. Follow-Up
            renderCard('followup', creditsFollow, '/strategy/follow-up', 'strategy_followup', isUnlimited);

            // -- BUNDLE CLICK --
            document.getElementById('btn-buy-bundle').addEventListener('click', () => {
                initiateCheckout('strategy_bundle');
            });


            // -- HELPER FUNCTIONS --

            function renderCard(idSuffix, credits, url, priceType, isUnlimited) {
                const statusEl = document.getElementById(`status-${idSuffix}`);
                const actionEl = document.getElementById(`action-${idSuffix}`);

                // Allow access if credits > 0 OR Unlimited
                const hasAccess = isUnlimited || credits > 0 || (userData.credits && userData.credits > 0);

                if (hasAccess) {
                    statusEl.textContent = isUnlimited ? "Unlimited Access" : `${credits} Credit${credits > 1 ? 's' : ''} Available`;
                    statusEl.classList.add('status-unlocked');
                    actionEl.innerHTML = `<a href="${url}.html" class="btn btn-open">Open Tool</a>`;
                } else {
                    statusEl.textContent = "Locked";
                    statusEl.classList.add('status-locked');
                    const btn = actionEl.querySelector('button');
                    if (btn) btn.onclick = () => initiateCheckout(priceType);
                }
            }

            async function initiateCheckout(planType) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const res = await fetch('/api/create-checkout-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            plan_type: planType,
                            email: userData.email,
                            userId: userData.id || userData.user_id,
                            successUrl: window.location.origin + '/dashboard.html'
                        })
                    });
                    const result = await res.json();
                    const data = result.data || result;
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error(result.error || "No redirect URL received");
                    }

                } catch (e) {
                    alert("Checkout Error: " + e.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

        });
    </script>
</body>

</html>